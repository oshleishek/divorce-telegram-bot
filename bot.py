"""
Telegram Bot –¥–ª—è –ª—ñ–¥–æ–≥–µ–Ω–µ—Ä–∞—Ü—ñ—ó –∞–¥–≤–æ–∫–∞—Ç—ñ–≤ (–†–æ–∑–ª—É—á–µ–Ω–Ω—è)
–í–µ—Ä—Å—ñ—è: 3.1 ULTIMATE IMPROVED
–ê–≤—Ç–æ—Ä: –°—Ç–∞—Å + Claude + Gemini

–ó–ú–Ü–ù–ò –í v3.1 (–ü–û–ö–†–ê–©–ï–ù–ê –í–û–†–û–ù–ö–ê):
‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
‚úÖ –†–æ–∑—à–∏—Ä–µ–Ω–∞ —Å–µ–≥–º–µ–Ω—Ç–∞—Ü—ñ—è: 4 ‚Üí 10 —Å–µ–≥–º–µ–Ω—Ç—ñ–≤ (A1, A2, B1, B2, C1, C2, D1, D2, E1, E2)
‚úÖ –î–µ—Ç–∞–ª—å–Ω—ñ –º–∏–Ω—ñ-–∫–µ–π—Å–∏ (—Ä–µ–∞–ª—å–Ω—ñ —ñ—Å—Ç–æ—Ä—ñ—ó –∑ —ñ–º–µ–Ω–∞–º–∏, –º—ñ—Å—Ç–∞–º–∏, —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞–º–∏)
‚úÖ –ú—ñ–∫—Ä–æ–∫–æ–º—ñ—Ç–∏ –ø—ñ—Å–ª—è –∫–æ–∂–Ω–æ—ó –≤—ñ–¥–ø–æ–≤—ñ–¥—ñ ("‚úÖ –ó—Ä–æ–∑—É–º—ñ–ª–æ...")
‚úÖ –ñ–∏–≤—ñ —Ç–µ–∫—Å—Ç–∏ –∑ –µ–º–ø–∞—Ç—ñ—î—é —Ç–∞ –ø–æ—è—Å–Ω–µ–Ω–Ω—è–º–∏
‚úÖ –ü–æ–∫—Ä–∞—â–µ–Ω–∏–π –æ—Ñ—Ñ–µ—Ä –∑ —Ä–µ–≤–µ—Ä—Å-—Ä–∏–∑–∏–∫–æ–º —Ç–∞ –ø–µ—Ä—Å–æ–Ω–∞–ª—ñ–∑–∞—Ü—ñ—î—é
‚úÖ –ü–æ–∫—Ä–∞—â–µ–Ω—ñ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∏ –¥–ª—è –∫–æ–∂–Ω–æ–≥–æ —Å–µ–≥–º–µ–Ω—Ç—É

–ó–ë–ï–†–ï–ñ–ï–ù–û –ó v3.0:
‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
‚úÖ –ê–Ω–∞–ª—ñ—Ç–∏–∫–∞ –∫–æ–Ω–≤–µ—Ä—Å—ñ—ó (Analytics sheet)
‚úÖ –í—Å—ñ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á—ñ (All_Users sheet)
‚úÖ –Ü–º'—è –∑ contact
‚úÖ –ù–∞–≥–∞–¥—É–≤–∞–Ω–Ω—è –ø—Ä–æ –∫–≤—ñ–∑ (15 —Ö–≤) —Ç–∞ —Ç–µ–ª–µ—Ñ–æ–Ω (60 —Å–µ–∫)
‚úÖ Flask web-server –¥–ª—è Render
‚úÖ –¢–µ–∫—Å—Ç–∏ –≤ –∫–æ–Ω—Å—Ç–∞–Ω—Ç–∞—Ö
"""

import os
import logging
import random
from datetime import datetime
from telegram import Update, InlineKeyboardButton, InlineKeyboardMarkup, ReactionTypeEmoji
from telegram.ext import Application, CommandHandler, CallbackQueryHandler, MessageHandler, filters, ContextTypes
import gspread
from oauth2client.service_account import ServiceAccountCredentials
import requests
from flask import Flask
import threading
import asyncio
from telegram.constants import ChatAction
import re

# =====================================================
# –ù–ê–õ–ê–®–¢–£–í–ê–ù–ù–Ø –õ–û–ì–£–í–ê–ù–ù–Ø
# =====================================================

logging.basicConfig(
    format='%(asctime)s - %(name)s - %(levelname)s - %(message)s',
    level=logging.INFO
)
logger = logging.getLogger(__name__)

# =====================================================
# –ö–û–ù–°–¢–ê–ù–¢–ò
# =====================================================

BOT_TOKEN = os.environ.get('BOT_TOKEN', 'YOUR_BOT_TOKEN_HERE')
MAKE_WEBHOOK_URL = os.environ.get('MAKE_WEBHOOK_URL', '')
GOOGLE_SHEET_URL = os.environ.get('GOOGLE_SHEET_URL')
ADMIN_ID = os.environ.get('ADMIN_ID')

# =====================================================
# –ü–Ü–î–ö–õ–Æ–ß–ï–ù–ù–Ø –î–û GOOGLE SHEETS
# =====================================================

def init_google_sheets():
    """–Ü–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—è –ø—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è –¥–æ Google Sheets"""
    try:
        required_vars = [
            'GOOGLE_PROJECT_ID', 
            'GOOGLE_PRIVATE_KEY', 
            'GOOGLE_CLIENT_EMAIL',
            'GOOGLE_SHEET_URL'
        ]
        missing_vars = [var for var in required_vars if not os.environ.get(var)]
        
        if missing_vars:
            logger.warning(f"‚ö†Ô∏è Google Sheets –Ω–µ –Ω–∞–ª–∞—à—Ç–æ–≤–∞–Ω–æ (–≤—ñ–¥—Å—É—Ç–Ω—ñ –∑–º—ñ–Ω–Ω—ñ: {', '.join(missing_vars)})")
            return None, None, None
        
        scope = ['https://spreadsheets.google.com/feeds',
                 'https://www.googleapis.com/auth/drive']
        
        creds_dict = {
            "type": "service_account",
            "project_id": os.environ.get('GOOGLE_PROJECT_ID'),
            "private_key_id": os.environ.get('GOOGLE_PRIVATE_KEY_ID'),
            "private_key": os.environ.get('GOOGLE_PRIVATE_KEY', '').replace('\\n', '\n'),
            "client_email": os.environ.get('GOOGLE_CLIENT_EMAIL'),
            "client_id": os.environ.get('GOOGLE_CLIENT_ID'),
            "auth_uri": "https://accounts.google.com/o/oauth2/auth",
            "token_uri": "https://oauth2.googleapis.com/token",
            "auth_provider_x509_cert_url": "https://www.googleapis.com/oauth2/v1/certs",
            "client_x509_cert_url": os.environ.get('GOOGLE_CERT_URL')
        }
        
        logger.info("üîÑ –ü—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è –¥–æ Google Sheets...")
        creds = ServiceAccountCredentials.from_json_keyfile_dict(creds_dict, scope)
        client = gspread.authorize(creds)
        
        logger.info(f"üîÑ –í—ñ–¥–∫—Ä–∏–≤–∞—é —Ç–∞–±–ª–∏—Ü—é –ø–æ URL...")
        spreadsheet = client.open_by_url(GOOGLE_SHEET_URL)
        
        # –û—Ç—Ä–∏–º—É—î–º–æ –∞–±–æ —Å—Ç–≤–æ—Ä—é—î–º–æ –ª–∏—Å—Ç–∏
        try:
            leads_sheet = spreadsheet.worksheet("Leads")
        except gspread.WorksheetNotFound:
            leads_sheet = spreadsheet.add_worksheet("Leads", rows=1000, cols=20)
            # –î–æ–¥–∞—î–º–æ –∑–∞–≥–æ–ª–æ–≤–∫–∏ (–¥–æ–¥–∞–ª–∏ segment_name)
            leads_sheet.append_row([
                "–î–∞—Ç–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–Ω—è", "Telegram ID", "Username", "–Ü–º'—è", "–¢–µ–ª–µ—Ñ–æ–Ω",
                "–î—ñ—Ç–∏", "–ó–≥–æ–¥–∞ —Å—É–ø—Ä—É–≥–∞", "–ú–∞–π–Ω–æ", "–ú—ñ—Å—Ü–µ —Å—É–ø—Ä—É–≥–∞", "–¢–µ—Ä–º—ñ–Ω–æ–≤—ñ—Å—Ç—å",
                "–°–µ–≥–º–µ–Ω—Ç", "–ù–∞–∑–≤–∞ —Å–µ–≥–º–µ–Ω—Ç—É", "–í–∞—Ä—Ç—ñ—Å—Ç—å", "–°—Ç—Ä–æ–∫–∏", "–°—Ç–∞—Ç—É—Å"
            ])
        
        try:
            analytics_sheet = spreadsheet.worksheet("Analytics")
        except gspread.WorksheetNotFound:
            analytics_sheet = spreadsheet.add_worksheet("Analytics", rows=5000, cols=10)
            analytics_sheet.append_row([
                "Timestamp", "Telegram ID", "Username", "Event", "Details"
            ])
        
        try:
            all_users_sheet = spreadsheet.worksheet("All_Users")
        except gspread.WorksheetNotFound:
            all_users_sheet = spreadsheet.add_worksheet("All_Users", rows=5000, cols=10)
            all_users_sheet.append_row([
                "–î–∞—Ç–∞ –ø–µ—Ä—à–æ–≥–æ –∫–æ–Ω—Ç–∞–∫—Ç—É", "Telegram ID", "Username", 
                "First Name", "Last Name", "–ó–∞–≤–µ—Ä—à–∏–≤ –∫–≤—ñ–∑", "–°—Ç–∞—Ç—É—Å"
            ])
        
        logger.info(f"‚úÖ Google Sheets –ø—ñ–¥–∫–ª—é—á–µ–Ω–æ —É—Å–ø—ñ—à–Ω–æ")
        logger.info(f"  üìä Leads: {leads_sheet.title}")
        logger.info(f"  üìà Analytics: {analytics_sheet.title}")
        logger.info(f"  üë• All Users: {all_users_sheet.title}")
        
        return leads_sheet, analytics_sheet, all_users_sheet
        
    except Exception as e:
        logger.error(f"‚ùå –ü–æ–º–∏–ª–∫–∞ –ø—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è –¥–æ Google Sheets: {type(e).__name__}: {str(e)}")
        return None, None, None

# –Ü–Ω—ñ—Ü—ñ–∞–ª—ñ–∑—É—î–º–æ sheets
SHEETS_LEADS, SHEETS_ANALYTICS, SHEETS_ALL_USERS = init_google_sheets()

# =====================================================
# –ê–ù–ê–õ–Ü–¢–ò–ö–ê - –õ–û–ì–£–í–ê–ù–ù–Ø –ü–û–î–Ü–ô
# =====================================================

async def log_event(telegram_id, username, event, details=""):
    """–õ–æ–≥—É—î –∫–æ–∂–Ω—É –ø–æ–¥—ñ—é –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞ –¥–ª—è –∞–Ω–∞–ª—ñ—Ç–∏–∫–∏ –∫–æ–Ω–≤–µ—Ä—Å—ñ—ó"""
    
    if SHEETS_ANALYTICS is None:
        return
    
    try:
        row = [
            datetime.now().isoformat(),
            str(telegram_id),
            username or "",
            event,
            details
        ]
        
        SHEETS_ANALYTICS.append_row(row)
        logger.info(f"üìä Analytics: {telegram_id} ‚Üí {event}")
        
    except Exception as e:
        logger.error(f"‚ùå –ü–æ–º–∏–ª–∫–∞ –ª–æ–≥—É–≤–∞–Ω–Ω—è –ø–æ–¥—ñ—ó: {e}")

async def save_all_user(telegram_id, username, first_name, last_name):
    """–ó–±–µ—Ä—ñ–≥–∞—î –í–°–Ü–• –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á—ñ–≤, —Ö—Ç–æ –Ω–∞—Ç–∏—Å–Ω—É–≤ /start"""
    
    if SHEETS_ALL_USERS is None:
        return
    
    try:
        # –ü–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ —á–∏ –≤–∂–µ —î —Ç–∞–∫–∏–π –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á
        existing = SHEETS_ALL_USERS.find(str(telegram_id), in_column=2)
        if existing:
            logger.info(f"üë• –ö–æ—Ä–∏—Å—Ç—É–≤–∞—á {telegram_id} –≤–∂–µ –≤ –±–∞–∑—ñ")
            return
        
        row = [
            datetime.now().isoformat(),
            str(telegram_id),
            username or "",
            first_name or "",
            last_name or "",
            "–ù—ñ",  # –ó–∞–≤–µ—Ä—à–∏–≤ –∫–≤—ñ–∑
            "new"   # –°—Ç–∞—Ç—É—Å
        ]
        
        SHEETS_ALL_USERS.append_row(row)
        logger.info(f"üë• –ù–æ–≤–∏–π –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á –≤ –±–∞–∑—ñ: {username or telegram_id}")
        
    except Exception as e:
        logger.error(f"‚ùå –ü–æ–º–∏–ª–∫–∞ –∑–±–µ—Ä–µ–∂–µ–Ω–Ω—è –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞: {e}")

# =====================================================
# WEB-–°–ï–†–í–ï–† –î–õ–Ø RENDER (–©–û–ë –ù–ï –ó–ê–°–ò–ù–ê–í)
# =====================================================

app = Flask(__name__)

@app.route('/')
def home():
    return "‚úÖ Divorce Bot v3.1 is running!", 200

@app.route('/health')
def health():
    return {"status": "ok", "bot": "running", "version": "3.1"}, 200

def run_flask():
    """–ó–∞–ø—É—Å–∫ Flask –≤ –æ–∫—Ä–µ–º–æ–º—É –ø–æ—Ç–æ—Ü—ñ"""
    port = int(os.environ.get('PORT', 10000))
    app.run(host='0.0.0.0', port=port, debug=False, use_reloader=False)

def determine_segment(user_data):
    """
    –û–Ω–æ–≤–ª–µ–Ω–∞ –ª–æ–≥—ñ–∫–∞ v3.5: –í—Ä–∞—Ö–æ–≤—É—î –∫–æ–Ω—Ñ–ª—ñ–∫—Ç–∏ –ø–æ –¥—ñ—Ç—è—Ö —Ç–∞ –º–∞–π–Ω—É.
    """
    has_children = user_data.get('has_children') == 'yes'
    conflict_children = user_data.get('conflict_children') == 'yes'  # –ù–æ–≤–∏–π –ø—Ä–∞–ø–æ—Ä–µ—Ü—å
    
    property_dispute = user_data.get('property_dispute') == 'yes'
    conflict_property = user_data.get('conflict_property') == 'yes'  # –ù–æ–≤–∏–π –ø—Ä–∞–ø–æ—Ä–µ—Ü—å
    
    spouse_location = user_data.get('spouse_location')
    urgency = user_data.get('urgency')
    spouse_consent = user_data.get('spouse_consent')

    # 1. –ó–ê –ö–û–†–î–û–ù–û–ú (D)
    if spouse_location == 'abroad':
        if urgency == 'high':
            return ('D1', 'üåç –ú—ñ–∂–Ω–∞—Ä–æ–¥–Ω–µ —Ä–æ–∑–ª—É—á–µ–Ω–Ω—è (VIP)', '18 000 ‚Äî 26 000 –≥—Ä–Ω', '4-5 –º—ñ—Å—è—Ü—ñ–≤')
        return ('D2', 'üåç –ú—ñ–∂–Ω–∞—Ä–æ–¥–Ω–µ —Ä–æ–∑–ª—É—á–µ–Ω–Ω—è (–°—Ç–∞–Ω–¥–∞—Ä—Ç)', '14 000 ‚Äî 20 000 –≥—Ä–Ω', '4-6 –º—ñ—Å—è—Ü—ñ–≤')
    
    # 2. –ù–ï–í–Ü–î–û–ú–ï –ú–Ü–°–¶–ï (E) - ‚úÖ –í–ò–ü–†–ê–í–õ–ï–ù–û –¢–£–¢
    if spouse_location == 'unknown':
        # –Ø–∫—â–æ –Ω–µ–º–∞—î –∑–≥–æ–¥–∏ ‚Äî —Ü–µ —Å–∞–±–æ—Ç–∞–∂ (E2)
        if spouse_consent == 'no':
            return ('E2', 'üîç –†–æ–∑–ª—É—á–µ–Ω–Ω—è –∑ —Ä–æ–∑—à—É–∫–æ–º', '16 000 ‚Äî 24 000 –≥—Ä–Ω', '6-9 –º—ñ—Å—è—Ü—ñ–≤')
        # –Ø–∫—â–æ –∑–≥–æ–¥–∞ —î –∞–±–æ –Ω–µ–≤—ñ–¥–æ–º–∞ ‚Äî —Ü–µ –ø—Ä–æ—Å—Ç–æ —Å—É–¥ –±–µ–∑ –∞–¥—Ä–µ—Å–∏ (E1, –¥–µ—à–µ–≤—à–µ)
        return ('E1', 'üîç –†–æ–∑–ª—É—á–µ–Ω–Ω—è –±–µ–∑ –∞–¥—Ä–µ—Å–∏', '12 000 ‚Äî 16 000 –≥—Ä–Ω', '5-7 –º—ñ—Å—è—Ü—ñ–≤')

    # 3. –ú–ê–ô–ù–û (C) - –¢–ï–ü–ï–† –†–û–ó–£–ú–ù–ï!
    if property_dispute:
        if conflict_property:
            # –Ñ –∫–æ–Ω—Ñ–ª—ñ–∫—Ç -> –î–æ—Ä–æ–≥–æ
            if has_children:
                return ('C1', 'üíº –ö–æ–º–ø–ª–µ–∫—Å–Ω–∏–π –º–∞–π–Ω–æ–≤–∏–π —Å–ø—ñ—Ä', '25 000 ‚Äî 50 000+ –≥—Ä–Ω', '8-16 –º—ñ—Å—è—Ü—ñ–≤')
            else:
                return ('C1', 'üí∞ –°—É–¥–æ–≤–∏–π –ø–æ–¥—ñ–ª –º–∞–π–Ω–∞', '18 000 ‚Äî 30 000 –≥—Ä–Ω', '6-10 –º—ñ—Å—è—Ü—ñ–≤')
        else:
            # –ú–∞–π–Ω–æ —î, –∞–ª–µ –∫–æ–Ω—Ñ–ª—ñ–∫—Ç—É –Ω–µ–º–∞—î -> –î–µ—à–µ–≤—à–µ (–¢–≤—ñ–π –≤–∏–ø–∞–¥–æ–∫!)
            return ('C2_PEACE', 'ü§ù –û—Ñ–æ—Ä–º–ª–µ–Ω–Ω—è –ø–æ–¥—ñ–ª—É –º–∞–π–Ω–∞', '10 000 ‚Äî 16 000 –≥—Ä–Ω', '3-5 –º—ñ—Å—è—Ü—ñ–≤')

    # 4. –î–Ü–¢–ò (B)
    if has_children:
        if conflict_children:
            return ('B1', 'üõ° –°—É–¥–æ–≤–∏–π —Å–ø—ñ—Ä –∑–∞ –¥—ñ—Ç–µ–π', '14 000 ‚Äî 22 000 –≥—Ä–Ω', '5-8 –º—ñ—Å—è—Ü—ñ–≤')
        else:
            return ('B2', 'üë®‚Äçüë©‚Äçüëß –ú–∏—Ä–Ω–µ —Ä–æ–∑–ª—É—á–µ–Ω–Ω—è –∑ –¥—ñ—Ç—å–º–∏', '8 000 ‚Äî 12 000 –≥—Ä–Ω', '3-4 –º—ñ—Å—è—Ü—ñ')

    # 5. –ü–†–û–°–¢–Ü (A)
    if urgency == 'high':
        return ('A1', '‚ö°Ô∏è –ï–∫—Å–ø—Ä–µ—Å-—Ä–æ–∑–ª—É—á–µ–Ω–Ω—è', '5 500 ‚Äî 7 500 –≥—Ä–Ω', '2-3 –º—ñ—Å—è—Ü—ñ')
    
    return ('A2', '‚úÖ –°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–µ —Ä–æ–∑–ª—É—á–µ–Ω–Ω—è', '4 500 ‚Äî 6 500 –≥—Ä–Ω', '3-4 –º—ñ—Å—è—Ü—ñ')

# =====================================================
# üìù –ü–û–ö–†–ê–©–ï–ù–Ü –¢–ï–ö–°–¢–ò –î–õ–Ø –ö–û–†–ò–°–¢–£–í–ê–ß–ê
# =====================================================

TEXT_WELCOME = """
–ú–∏ –≥–æ—Ç–æ–≤—ñ –ø—Ä–æ–∞–Ω–∞–ª—ñ–∑—É–≤–∞—Ç–∏ –≤–∞—à—É —Å–∏—Ç—É–∞—Ü—ñ—é.

–¶–µ –∑–∞–π–º–µ 2 —Ö–≤–∏–ª–∏–Ω–∏:
1. –í–∏ –≤—ñ–¥–ø–æ–≤—ñ–¥–∞—î—Ç–µ –Ω–∞ 5 –ø—Ä–æ—Å—Ç–∏—Ö –ø–∏—Ç–∞–Ω—å.
2. –°–∏—Å—Ç–µ–º–∞ —Ñ–æ—Ä–º—É—î —Ñ—ñ–Ω–∞–Ω—Å–æ–≤–∏–π —Ç–∞ —é—Ä–∏–¥–∏—á–Ω–∏–π –ø—Ä–æ–≥–Ω–æ–∑.
3. –í–∏ –æ—Ç—Ä–∏–º—É—î—Ç–µ —Ü–∏—Ñ—Ä–∏ —Ç–∞ —Ä–æ–∑—É–º—ñ–Ω–Ω—è —Å–∏—Ç—É–∞—Ü—ñ—ó.

<i>–ù–∞—Ç–∏—Å–Ω—ñ—Ç—å –∫–Ω–æ–ø–∫—É –Ω–∏–∂—á–µ, —â–æ–± —Ä–æ–∑–ø–æ—á–∞—Ç–∏ –∞–Ω–∞–ª—ñ–∑.</i> üëá
"""

# üìù –¢–ï–ö–°–¢: –ü–∏—Ç–∞–Ω–Ω—è 1 (–ü–û–ö–†–ê–©–ï–ù–û –∑ –ø–æ—è—Å–Ω–µ–Ω–Ω—è–º)
TEXT_Q1 = """
<b>–ü–∏—Ç–∞–Ω–Ω—è 1 –∑ 6</b>

–ß–∏ —î —É –≤–∞—Å —Å–ø—ñ–ª—å–Ω—ñ –¥—ñ—Ç–∏ (–¥–æ 18 —Ä–æ–∫—ñ–≤)?

<i>–¶–µ –≤–∞–∂–ª–∏–≤–æ, –±–æ –Ω–∞—è–≤–Ω—ñ—Å—Ç—å –¥—ñ—Ç–µ–π –≤–ø–ª–∏–≤–∞—î –Ω–∞ –ø—Ä–æ—Ü–µ–¥—É—Ä—É —Ç–∞ —Å—Ç—Ä–æ–∫–∏ —Ä–æ–∑–ª—É—á–µ–Ω–Ω—è.</i>
"""

# üìù –ú–Ü–ö–†–û–ö–û–ú–Ü–¢–ò (–Ω–æ–≤—ñ —Ç–µ–∫—Å—Ç–∏ –ø—ñ—Å–ª—è –≤—ñ–¥–ø–æ–≤—ñ–¥–µ–π)
MICROCOMMIT_Q1_YES = "‚úÖ –ó—Ä–æ–∑—É–º—ñ–ª–æ, —î –¥—ñ—Ç–∏.\n\n"
MICROCOMMIT_Q1_NO = "‚úÖ –ó—Ä–æ–∑—É–º—ñ–ª–æ.\n\n"

# üëá –ù–û–í–ï: –£—Ç–æ—á–Ω–µ–Ω–Ω—è –ø–æ –¥—ñ—Ç—è—Ö
TEXT_Q1_CLARIFY = """
<b>–£—Ç–æ—á–Ω–µ–Ω–Ω—è –ø–æ –¥—ñ—Ç—è—Ö:</b>

–°–∫–∞–∂—ñ—Ç—å, —á–∏ —î —É –≤–∞—Å —Å–ø—ñ—Ä –∑ —á–æ–ª–æ–≤—ñ–∫–æ–º/–¥—Ä—É–∂–∏–Ω–æ—é —â–æ–¥–æ —Ç–æ–≥–æ, –∑ –∫–∏–º –∂–∏—Ç–∏–º—É—Ç—å –¥—ñ—Ç–∏, –∞–±–æ —â–æ–¥–æ –∞–ª—ñ–º–µ–Ω—Ç—ñ–≤?

<i>–¶–µ –∫–∞—Ä–¥–∏–Ω–∞–ª—å–Ω–æ –≤–ø–ª–∏–≤–∞—î –Ω–∞ —Å–∫–ª–∞–¥–Ω—ñ—Å—Ç—å —Å–ø—Ä–∞–≤–∏ —Ç–∞ –±—é–¥–∂–µ—Ç.</i>
"""

# üìù –¢–ï–ö–°–¢: –ü–∏—Ç–∞–Ω–Ω—è 2 (–ü–û–ö–†–ê–©–ï–ù–û)
TEXT_Q2 = """<b>–ü–∏—Ç–∞–Ω–Ω—è 2 –∑ 6</b>

–ß–∏ –∑–≥–æ–¥–µ–Ω(–Ω–∞) –≤–∞—à —á–æ–ª–æ–≤—ñ–∫/–¥—Ä—É–∂–∏–Ω–∞ –Ω–∞ —Ä–æ–∑–ª—É—á–µ–Ω–Ω—è?

<i>–Ø–∫—â–æ –æ–±–∏–¥–≤–∞ –∑–≥–æ–¥–Ω—ñ - –ø—Ä–æ—Ü–µ—Å –±—É–¥–µ —à–≤–∏–¥—à–∏–º. –Ø–∫—â–æ —Ö—Ç–æ—Å—å –ø—Ä–æ—Ç–∏ - —Ü–µ –Ω–µ –ø–µ—Ä–µ—à–∫–æ–¥–∞, –ø—Ä–æ—Å—Ç–æ —Ç—Ä–∏–≤–∞—Ç–∏–º–µ –¥–æ–≤—à–µ.</i>
"""

# üìù –ú–Ü–ö–†–û–ö–û–ú–Ü–¢–ò –¥–ª—è Q2
MICROCOMMIT_Q2_YES = "‚úÖ –î–æ–±—Ä–µ, —â–æ —î –∑–≥–æ–¥–∞.\n\n"
MICROCOMMIT_Q2_NO = "‚úÖ –†–æ–∑—É–º—ñ—é, —Ü–µ —Å–∫–ª–∞–¥–Ω—ñ—à–µ. –ê–ª–µ —Ä–æ–∑–ª—É—á–∏—Ç–∏—Å—è –º–æ–∂–Ω–∞ —ñ –±–µ–∑ –∑–≥–æ–¥–∏.\n\n"
MICROCOMMIT_Q2_UNKNOWN = "‚úÖ –î–æ–±—Ä–µ, –∑'—è—Å—É—î–º–æ –¥–∞–ª—ñ.\n\n"

# üìù –¢–ï–ö–°–¢: –ü–∏—Ç–∞–Ω–Ω—è 3 (–ü–û–ö–†–ê–©–ï–ù–û)
TEXT_Q3 = """<b>–ü–∏—Ç–∞–Ω–Ω—è 3 –∑ 6</b>

–ß–∏ —î —Å–ø—ñ–ª—å–Ω–µ –º–∞–π–Ω–æ, —è–∫–µ –ø–æ—Ç—Ä—ñ–±–Ω–æ –¥—ñ–ª–∏—Ç–∏?
<i>(–∫–≤–∞—Ä—Ç–∏—Ä–∞, –±—É–¥–∏–Ω–æ–∫, –∑–µ–º–ª—è, –∞–≤—Ç–æ–º–æ–±—ñ–ª—å, –±—ñ–∑–Ω–µ—Å, –≤–µ–ª–∏–∫—ñ –∑–∞–æ—â–∞–¥–∂–µ–Ω–Ω—è —Ç–æ—â–æ)</i>

<i>–Ø–∫—â–æ –º–∞–π–Ω–∞ –º–∞–ª–æ –∞–±–æ –≤–∏ –¥–æ–º–æ–≤–∏–ª–∏—Å—è - –ø—Ä–æ—Ü–µ—Å –ø—Ä–æ—Å—Ç—ñ—à–∏–π. –Ø–∫—â–æ —î –≤–µ–ª–∏–∫—ñ –∞–∫—Ç–∏–≤–∏ - –ø–æ—Ç—Ä—ñ–±–µ–Ω –ø—Ä–æ—Ñ–µ—Å—ñ–π–Ω–∏–π —Ä–æ–∑–¥—ñ–ª.</i>
"""

# üìù –ú–Ü–ö–†–û–ö–û–ú–Ü–¢–ò –¥–ª—è Q3
MICROCOMMIT_Q3_YES = "‚úÖ –ê–≥–∞, —Ä–æ–∑–¥—ñ–ª –º–∞–π–Ω–∞. –¶–µ –≤–∏–º–∞–≥–∞—î –æ—Å–æ–±–ª–∏–≤–æ—ó —É–≤–∞–≥–∏.\n\n"
MICROCOMMIT_Q3_NO = "‚úÖ –î–æ–±—Ä–µ, –º–∞–π–Ω–∞ –Ω–µ–º–∞—î –∞–±–æ –≤—Ä–µ–≥—É–ª—å–æ–≤–∞–Ω–æ.\n\n"
MICROCOMMIT_Q3_UNSURE = "‚úÖ –ó—Ä–æ–∑—É–º—ñ–ª–æ, —Ä–æ–∑–±–µ—Ä–µ–º–æ—Å—è.\n\n"

# üëá –ù–û–í–ï: –£—Ç–æ—á–Ω–µ–Ω–Ω—è –ø–æ –º–∞–π–Ω—É
TEXT_Q3_CLARIFY = """
<b>–£—Ç–æ—á–Ω–µ–Ω–Ω—è –ø–æ –º–∞–π–Ω—É:</b>

–ß–∏ —î –º—ñ–∂ –≤–∞–º–∏ –∫–æ–Ω—Ñ–ª—ñ–∫—Ç —â–æ–¥–æ –ø–æ–¥—ñ–ª—É?

<i>–¢–æ–±—Ç–æ: –≤–∏ –≤–∂–µ –¥–æ–º–æ–≤–∏–ª–∏—Å—è, –∫–æ–º—É —â–æ –¥—ñ—Å—Ç–∞–Ω–µ—Ç—å—Å—è (–ø–æ—Ç—Ä—ñ–±–Ω–æ –ª–∏—à–µ —é—Ä–∏–¥–∏—á–Ω–æ –æ—Ñ–æ—Ä–º–∏—Ç–∏), —á–∏ –∫–æ–∂–µ–Ω —Ç—è–≥–Ω–µ –∫–æ–≤–¥—Ä—É –Ω–∞ —Å–µ–±–µ (–ø–æ—Ç—Ä—ñ–±–µ–Ω —Å—É–¥)?</i>
"""

# üìù –¢–ï–ö–°–¢: –ü–∏—Ç–∞–Ω–Ω—è 4 (–ü–û–ö–†–ê–©–ï–ù–û)
TEXT_Q4 = """<b>–ü–∏—Ç–∞–Ω–Ω—è 4 –∑ 6</b>

–î–µ –∑–∞—Ä–∞–∑ –ø–µ—Ä–µ–±—É–≤–∞—î—Ç–µ –≤–∏ —Ç–∞ –≤–∞—à —á–æ–ª–æ–≤—ñ–∫/–¥—Ä—É–∂–∏–Ω–∞?

<i>–¶–µ –≤–∏–∑–Ω–∞—á–∞—î, —á–∏ –ø–æ—Ç—Ä—ñ–±–µ–Ω –Ω–∞–º –¥–∏—Å—Ç–∞–Ω—Ü—ñ–π–Ω–∏–π –ø—Ä–æ—Ü–µ—Å —Ç–∞ –¥–æ —è–∫–æ–≥–æ —Å–∞–º–µ —Å—É–¥—É –ø–æ–¥–∞–≤–∞—Ç–∏ –¥–æ–∫—É–º–µ–Ω—Ç–∏.</i>
"""

# üìù –ú–Ü–ö–†–û–ö–û–ú–Ü–¢–ò –¥–ª—è Q4
MICROCOMMIT_Q4_UKRAINE = "‚úÖ –î–æ–±—Ä–µ, –æ–±–∏–¥–≤–∞ –≤ –£–∫—Ä–∞—ó–Ω—ñ.\n\n"
MICROCOMMIT_Q4_ABROAD = "‚úÖ –ó—Ä–æ–∑—É–º—ñ–ª–æ, —î –º—ñ–∂–Ω–∞—Ä–æ–¥–Ω–∏–π –µ–ª–µ–º–µ–Ω—Ç. –¶–µ –Ω–µ –ø—Ä–æ–±–ª–µ–º–∞, –≤—Å–µ –º–æ–∂–Ω–∞ –æ—Ä–≥–∞–Ω—ã–∑—É–≤–∞—Ç–∏ –¥–∏—Å—Ç–∞–Ω—Ü—ñ–π–Ω–æ.\n\n"
MICROCOMMIT_Q4_UNKNOWN = "‚úÖ –†–æ–∑—É–º—ñ—é. –Ñ –ø—Ä–æ—Ü–µ–¥—É—Ä–∞ —Ä–æ–∑–ª—É—á–µ–Ω–Ω—è –±–µ–∑ –≤—ñ–¥–æ–º–æ—ó –∞–¥—Ä–µ—Å–∏.\n\n"

# üìù –¢–ï–ö–°–¢: –ü–∏—Ç–∞–Ω–Ω—è 5 (–ü–û–ö–†–ê–©–ï–ù–û)
TEXT_Q5 = """<b>–ü–∏—Ç–∞–Ω–Ω—è 5 –∑ 6</b>

–ù–∞—Å–∫—ñ–ª—å–∫–∏ —Ç–µ—Ä–º—ñ–Ω–æ–≤–æ –≤–∞–º –ø–æ—Ç—Ä—ñ–±–Ω–æ —Ä–æ–∑–ª—É—á–µ–Ω–Ω—è?

<i>–¶–µ –¥–æ–ø–æ–º–æ–∂–µ –ø—ñ–¥—ñ–±—Ä–∞—Ç–∏ –æ–ø—Ç–∏–º–∞–ª—å–Ω–∏–π –ø–∞–∫–µ—Ç –ø–æ—Å–ª—É–≥.</i>
"""

TEXT_Q6_PHONE = """
‚úÖ <b>–î–∞–Ω—ñ –ø—Ä–∏–π–Ω—è—Ç–æ!</b>

–°–∏—Å—Ç–µ–º–∞ –≤–∂–µ —Å—Ñ–æ—Ä–º—É–≤–∞–ª–∞ –ø–æ–ø–µ—Ä–µ–¥–Ω—ñ–π —Ä–æ–∑—Ä–∞—Ö—É–Ω–æ–∫ –≤–∞—Ä—Ç–æ—Å—Ç—ñ —Ç–∞ —Å—Ç—Ä–æ–∫—ñ–≤ –¥–ª—è –≤–∞—à–æ–≥–æ –≤–∏–ø–∞–¥–∫—É.

–©–æ–± –ø–æ–±–∞—á–∏—Ç–∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç —Ç–∞ –∑–±–µ—Ä–µ–≥—Ç–∏ –π–æ–≥–æ –∑–∞ —Å–æ–±–æ—é ‚Äî –ø—ñ–¥—Ç–≤–µ—Ä–¥—ñ—Ç—å, —â–æ –≤–∏ —Ä–µ–∞–ª—å–Ω–∞ –ª—é–¥–∏–Ω–∞.

üëá <b>–ù–∞—Ç–∏—Å–Ω—ñ—Ç—å –∫–Ω–æ–ø–∫—É "–ü–æ–¥—ñ–ª–∏—Ç–∏—Å—è –Ω–æ–º–µ—Ä–æ–º", —â–æ–± –≤—ñ–¥–∫—Ä–∏—Ç–∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç.</b>

<i>–¶–µ –∫–æ–Ω—Ñ—ñ–¥–µ–Ω—Ü—ñ–π–Ω–æ. –ú–∏ –Ω–µ –ø–µ—Ä–µ–¥–∞—î–º–æ –Ω–æ–º–µ—Ä —Ç—Ä–µ—Ç—ñ–º –æ—Å–æ–±–∞–º –±–µ–∑ –≤–∞—à–æ—ó –∑–≥–æ–¥–∏.</i>
"""

# =====================================================
# –Ü–ù–°–ê–ô–¢–ò –†–ò–ù–ö–£ (–ü–û–ó–ò–¶–Ü–Ø "–ù–ê–î –†–ò–ù–ö–û–ú")
# =====================================================

MINI_CASES = {
    # –°–∏—Ç—É–∞—Ü–∏—è: –î–µ—Ç–∏ + –ö–æ–Ω—Ñ–ª–∏–∫—Ç
    'yes_children_no_consent': [
        """
<i>üí° <b>–Ü–Ω—Å–∞–π—Ç –≤—ñ–¥ —Å–µ—Ä–≤—ñ—Å—É:</b>

–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ–∫–∞–∑—É—î, —â–æ —Å–ø—Ä–∞–≤–∏ "–¥—ñ—Ç–∏ + –∫–æ–Ω—Ñ–ª—ñ–∫—Ç" ‚Äî —Ü–µ –∑–æ–Ω–∞ –Ω–∞–π–≤–∏—â–æ–≥–æ —Ä–∏–∑–∏–∫—É. –ë–∞–≥–∞—Ç–æ –∞–¥–≤–æ–∫–∞—Ç—ñ–≤-–∑–∞–≥–∞–ª—å–Ω–æ–≥–æ –ø—Ä–æ—Ñ—ñ–ª—é –±–µ—Ä—É—Ç—å—Å—è –∑–∞ –Ω–∏—Ö, –∞–ª–µ –ø—Ä–æ–≥—Ä–∞—é—Ç—å –∞–≥—Ä–µ—Å–∏–≤–Ω—ñ–π —Å—Ç–æ—Ä–æ–Ω—ñ.

–í–∞–º –ø–æ—Ç—Ä—ñ–±–µ–Ω –Ω–µ –ø—Ä–æ—Å—Ç–æ —é—Ä–∏—Å—Ç, –∞ –≤—É–∑—å–∫–∏–π —Å–ø–µ—Ü—ñ–∞–ª—ñ—Å—Ç —ñ–∑ <b>—Å—ñ–º–µ–π–Ω–æ–≥–æ –ø—Ä–∞–≤–∞ —Ç–∞ –æ–ø—ñ–∫–∏</b>. –¢—ñ–ª—å–∫–∏ —Ç–∞–∫–∏–π —Ñ–∞—Ö—ñ–≤–µ—Ü—å –∑–Ω–∞—î, —è–∫ –ø—Ä–∞–≤–∏–ª—å–Ω–æ –∑–∞—Ñ—ñ–∫—Å—É–≤–∞—Ç–∏ –≥—Ä–∞—Ñ—ñ–∫ —Å–ø—ñ–ª–∫—É–≤–∞–Ω–Ω—è —á–∏ –∞–ª—ñ–º–µ–Ω—Ç–∏, —â–æ–± –ø–æ—Ç—ñ–º –Ω–µ –±—ñ–≥–∞—Ç–∏ –¥–æ –≤–∏–∫–æ–Ω–∞–≤—á–æ—ó —Å–ª—É–∂–±–∏.</i>
"""
    ],
    
    # –°–∏—Ç—É–∞—Ü–∏—è: –í—Å–µ –º–∏—Ä–Ω–æ
    'no_children_yes_consent': [
        """
<i>üí° <b>–Ü–Ω—Å–∞–π—Ç –≤—ñ–¥ —Å–µ—Ä–≤—ñ—Å—É:</b>

–¶–µ –Ω–∞–π–ø—Ä–æ—Å—Ç—ñ—à–∞ –∫–∞—Ç–µ–≥–æ—Ä—ñ—è —Å–ø—Ä–∞–≤. –ê–ª–µ —Å–∞–º–µ —Ç—É—Ç –∫–ª—ñ—î–Ω—Ç–∏ —á–∞—Å—Ç–æ –ø–µ—Ä–µ–ø–ª–∞—á—É—é—Ç—å.

–í–µ–ª–∏–∫—ñ —é—Ä–∏–¥–∏—á–Ω—ñ –∫–æ–º–ø–∞–Ω—ñ—ó –º–æ–∂—É—Ç—å –≤–∏—Å—Ç–∞–≤–∏—Ç–∏ —á–µ–∫ 10-15 —Ç–∏—Å. –≥—Ä–Ω –∑–∞ —Ç–µ, —â–æ –ø—Ä–∏–≤–∞—Ç–Ω–∏–π –∞–¥–≤–æ–∫–∞—Ç –∑—Ä–æ–±–∏—Ç—å –∑–∞ 4-5 —Ç–∏—Å. –≥—Ä–Ω –∑ —Ç—ñ—î—é –∂ —è–∫—ñ—Å—Ç—é. –ù–∞—à–µ –∑–∞–≤–¥–∞–Ω–Ω—è ‚Äî –∑–Ω–∞–π—Ç–∏ –≤–∞–º <b>—á–µ—Å–Ω—É —Ü—ñ–Ω—É</b> –∑–∞ —Ü—é —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—É –ø—Ä–æ—Ü–µ–¥—É—Ä—É, —â–æ–± –≤–∏ –Ω–µ –ø–ª–∞—Ç–∏–ª–∏ –∑–∞ "–ø–æ–≤—ñ—Ç—Ä—è".</i>
"""
    ],
    
    # –°–∏—Ç—É–∞—Ü–∏—è: –ò–º—É—â–µ—Å—Ç–≤–æ
    'yes_property': [
        """
<i>üí° <b>–Ü–Ω—Å–∞–π—Ç –≤—ñ–¥ —Å–µ—Ä–≤—ñ—Å—É:</b>

–†–æ–∑–¥—ñ–ª –º–∞–π–Ω–∞ ‚Äî —Ü–µ –º–∞—Ç–µ–º–∞—Ç–∏–∫–∞, –∞ –Ω–µ –µ–º–æ—Ü—ñ—ó. –ì–æ–ª–æ–≤–Ω–∞ –ø–æ–º–∏–ª–∫–∞ —Ç—É—Ç ‚Äî –π—Ç–∏ –¥–æ —Å—É–¥—É –±–µ–∑ –ø–æ–ø–µ—Ä–µ–¥–Ω—å–æ—ó –æ—Ü—ñ–Ω–∫–∏ –∞–∫—Ç–∏–≤—ñ–≤.

–ú–∏ —Ä–µ–∫–æ–º–µ–Ω–¥—É—î–º–æ –∞–¥–≤–æ–∫–∞—Ç—ñ–≤, —è–∫—ñ –ø—Ä–∞—Ü—é—é—Ç—å —É –∑–≤'—è–∑—Ü—ñ –∑ –æ—Ü—ñ–Ω—é–≤–∞—á–∞–º–∏ —Ç–∞ –≤–º—ñ—é—Ç—å –∑–Ω–∞—Ö–æ–¥–∏—Ç–∏ –ø—Ä–∏—Ö–æ–≤–∞–Ω—ñ –∞–∫—Ç–∏–≤–∏. –¶–µ –æ–∫—É–ø–∞—î—Ç—å—Å—è –≤ 100% –≤–∏–ø–∞–¥–∫—ñ–≤. –í–∞–∂–ª–∏–≤–æ –Ω–µ –ø—Ä–æ—Å—Ç–æ "–ø–æ–¥—ñ–ª–∏—Ç–∏", –∞ –∑–∞–ª–∏—à–∏—Ç–∏—Å—è –∑ –ª—ñ–∫–≤—ñ–¥–Ω–∏–º –º–∞–π–Ω–æ–º.</i>
"""
    ],
    
    # –°–∏—Ç—É–∞—Ü–∏—è: –ó–∞ –≥—Ä–∞–Ω–∏—Ü–µ–π
    'abroad': [
        """
<i>üí° <b>–Ü–Ω—Å–∞–π—Ç –≤—ñ–¥ —Å–µ—Ä–≤—ñ—Å—É:</b>

–ë–∞–≥–∞—Ç–æ –∞–¥–≤–æ–∫–∞—Ç—ñ–≤ –¥–æ—Å—ñ –Ω–∞–º–∞–≥–∞—é—Ç—å—Å—è —Ç—è–≥–Ω—É—Ç–∏ –∫–ª—ñ—î–Ω—Ç—ñ–≤ –≤ –æ—Ñ—ñ—Å –¥–ª—è –ø—ñ–¥–ø–∏—Å–∞–Ω–Ω—è –ø–∞–ø–µ—Ä—ñ–≤. –¶–µ –º–∏–Ω—É–ª–µ —Å—Ç–æ–ª—ñ—Ç—Ç—è.

–î–ª—è —Ç–∏—Ö, —Ö—Ç–æ –∑–∞ –∫–æ—Ä–¥–æ–Ω–æ–º, –º–∏ –ø—ñ–¥–±–∏—Ä–∞—î–º–æ –≤–∏–∫–ª—é—á–Ω–æ <b>Digital-–∞–¥–≤–æ–∫–∞—Ç—ñ–≤</b>. –í–æ–Ω–∏ –≤–º—ñ—é—Ç—å –ø—Ä–∞—Ü—é–≤–∞—Ç–∏ —á–µ—Ä–µ–∑ –ï–ª–µ–∫—Ç—Ä–æ–Ω–Ω–∏–π –°—É–¥, –∑–Ω–∞—é—Ç—å –Ω—é–∞–Ω—Å–∏ –∫–æ–Ω—Å—É–ª—å—Å—å–∫–∏—Ö –¥–æ–≤—ñ—Ä–µ–Ω–æ—Å—Ç–µ–π —ñ –Ω–µ –≤–∏–º–∞–≥–∞—é—Ç—å –≤–∞—à–æ—ó —Ñ—ñ–∑–∏—á–Ω–æ—ó –ø—Ä–∏—Å—É—Ç–Ω–æ—Å—Ç—ñ. –¶–µ –µ–∫–æ–Ω–æ–º–∏—Ç—å –≤–∞–º —Å–æ—Ç–Ω—ñ —î–≤—Ä–æ –Ω–∞ –ø–æ—ó–∑–¥–∫–∞—Ö.</i>
"""
    ],
    
    # –°–∏—Ç—É–∞—Ü–∏—è: –ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ –≥–¥–µ
    'unknown_location': [
        """
<i>üí° <b>–Ü–Ω—Å–∞–π—Ç –≤—ñ–¥ —Å–µ—Ä–≤—ñ—Å—É:</b>

–°–ø—Ä–∞–≤–∏ "–±–µ–∑ –≤—ñ–¥–ø–æ–≤—ñ–¥–∞—á–∞" —á–∞—Å—Ç–æ –∑–∞—Ç—è–≥—É—é—Ç—å—Å—è, —è–∫—â–æ —é—Ä–∏—Å—Ç –Ω–µ –≤–º—ñ—î –ø—Ä–∞—Ü—é–≤–∞—Ç–∏ –∑ –ø—Ä–æ—Ü–µ–¥—É—Ä–æ—é —Ä–æ–∑—à—É–∫—É.

–í–∞–º –ø–æ—Ç—Ä—ñ–±–µ–Ω —Å–ø–µ—Ü—ñ–∞–ª—ñ—Å—Ç, —è–∫–∏–π –æ–¥—Ä–∞–∑—É –ø–æ–¥–∞—Å—Ç—å –ø—Ä–∞–≤–∏–ª—å–Ω—ñ –∫–ª–æ–ø–æ—Ç–∞–Ω–Ω—è –ø—Ä–æ –≤–∏–∫–ª–∏–∫ —á–µ—Ä–µ–∑ –æ–≥–æ–ª–æ—à–µ–Ω–Ω—è. –¶–µ –¥–æ–∑–≤–æ–ª–∏—Ç—å –æ—Ç—Ä–∏–º–∞—Ç–∏ –∑–∞–æ—á–Ω–µ —Ä—ñ—à–µ–Ω–Ω—è —Å—É–¥—É –≥–∞—Ä–∞–Ω—Ç–æ–≤–∞–Ω–æ, –Ω–∞–≤—ñ—Ç—å —è–∫—â–æ –¥—Ä—É–≥–∞ —Å—Ç–æ—Ä–æ–Ω–∞ —Ö–æ–≤–∞—î—Ç—å—Å—è.</i>
"""
    ],

    # üëá –û–°–¨ –¶–ï–ô –ü–£–ù–ö–¢ –ë–£–í –í–Ü–î–°–£–¢–ù–Ü–ô
    'default': [
        """
<i>üí° <b>–Ü–Ω—Å–∞–π—Ç –≤—ñ–¥ —Å–µ—Ä–≤—ñ—Å—É:</b>

–†–æ–∑—É–º—ñ—é, –ø—Ä–æ—Ü–µ—Å —Ä–æ–∑–ª—É—á–µ–Ω–Ω—è —á–∞—Å—Ç–æ –∑–¥–∞—î—Ç—å—Å—è —Å–∫–ª–∞–¥–Ω–∏–º —Ç–∞ –∑–∞–ø–ª—É—Ç–∞–Ω–∏–º.

–ê–ª–µ –Ω–∞—Å–ø—Ä–∞–≤–¥—ñ, –∫–æ–ª–∏ —î <b>—á—ñ—Ç–∫–∏–π —é—Ä–∏–¥–∏—á–Ω–∏–π –ø–ª–∞–Ω</b>, 90% —Å—Ç—Ä–∞—Ö—ñ–≤ –∑–Ω–∏–∫–∞—é—Ç—å. –í–∏ –±—É–¥–µ—Ç–µ —á—ñ—Ç–∫–æ —Ä–æ–∑—É–º—ñ—Ç–∏ –∫–æ–∂–µ–Ω –Ω–∞—Å—Ç—É–ø–Ω–∏–π –∫—Ä–æ–∫, –∞ –≤—Å—é —Å–∫–ª–∞–¥–Ω—É —é—Ä–∏–¥–∏—á–Ω—É —Ä–æ–±–æ—Ç—É –º–∏ –¥–µ–ª–µ–≥—É—î–º–æ –ø—Ä–æ—Ñ—ñ–ª—å–Ω–æ–º—É —Å–ø–µ—Ü—ñ–∞–ª—ñ—Å—Ç—É.</i>
"""
    ]
}

def get_mini_case(user_data):
    """–í–∏–±–∏—Ä–∞—î —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω–∏–π –¥–µ—Ç–∞–ª—å–Ω–∏–π –º–∏–Ω—ñ-–∫–µ–π—Å"""
    
    has_children = user_data.get('has_children') == 'yes'
    spouse_consent = user_data.get('spouse_consent')
    property_dispute = user_data.get('property_dispute')
    spouse_location = user_data.get('spouse_location')
    
    # –ü—Ä—ñ–æ—Ä–∏—Ç–µ—Ç 1: –ó–∞ –∫–æ—Ä–¥–æ–Ω–æ–º
    if spouse_location == 'abroad':
        cases = MINI_CASES['abroad']
        
    # –ü—Ä—ñ–æ—Ä–∏—Ç–µ—Ç 2: –ù–µ–≤—ñ–¥–æ–º–µ –º—ñ—Å—Ü–µ
    elif spouse_location == 'unknown':
        cases = MINI_CASES['unknown_location']
        
    # –ü—Ä—ñ–æ—Ä–∏—Ç–µ—Ç 3: –Ñ –º–∞–π–Ω–æ
    elif property_dispute == 'yes':
        cases = MINI_CASES['yes_property']
        
    # –ü—Ä—ñ–æ—Ä–∏—Ç–µ—Ç 4: –Ñ –¥—ñ—Ç–∏ + –Ω–µ–º–∞—î –∑–≥–æ–¥–∏
    elif has_children and spouse_consent == 'no':
        cases = MINI_CASES['yes_children_no_consent']
        
    # –ü—Ä—ñ–æ—Ä–∏—Ç–µ—Ç 5: –ù–µ–º–∞—î –¥—ñ—Ç–µ–π + —î –∑–≥–æ–¥–∞
    elif not has_children and spouse_consent == 'yes':
        cases = MINI_CASES['no_children_yes_consent']
        
    # –î–µ—Ñ–æ–ª—Ç–Ω–∏–π
    else:
        cases = MINI_CASES['default']
    
    return random.choice(cases)

DISCLAIMER_TEXT = "\n\n‚ö†Ô∏è <i>–¶–µ —Å–µ—Ä–µ–¥–Ω—å–æ—Ä–∏–Ω–∫–æ–≤–∏–π –æ—Ä—ñ—î–Ω—Ç–∏—Ä. –¢–æ—á–Ω–∞ –≤–∞—Ä—Ç—ñ—Å—Ç—å –∑–∞–ª–µ–∂–∏—Ç—å –≤—ñ–¥ –∫–≤–∞–ª—ñ—Ñ—ñ–∫–∞—Ü—ñ—ó –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ –∞–¥–≤–æ–∫–∞—Ç–∞.</i>"

# –î–∏—Å–∫–ª–µ–π–º–µ—Ä
DISCLAIMER_TEXT = "\n\n‚ö†Ô∏è <i>–†–æ–∑—Ä–∞—Ö—É–Ω–æ–∫ –±–∞–∑—É—î—Ç—å—Å—è –Ω–∞ –∞–Ω–∞–ª—ñ—Ç–∏—Ü—ñ —Ä–∏–Ω–∫—É 2025 —Ä–æ–∫—É. –í—Ä–∞—Ö–æ–≤–∞–Ω–æ —Å—É–¥–æ–≤–∏–π –∑–±—ñ—Ä (1211 –≥—Ä–Ω) —Ç–∞ —Ä–µ–∞–ª—å–Ω–µ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è —Å—É–¥—ñ–≤.</i>"

SEGMENT_MESSAGES = {
    'A1': """‚ö°Ô∏è <b>–¢–∏–ø —Å–ø—Ä–∞–≤–∏: {segment_name}</b>

–¶–µ –Ω–∞–π–ª–µ–≥—à–∏–π —Å—Ü–µ–Ω–∞—Ä—ñ–π (–°—Ü–µ–Ω–∞—Ä—ñ–π C –∑–∞ –∫–ª–∞—Å–∏—Ñ—ñ–∫–∞—Ü—ñ—î—é —Ä–∏–Ω–∫—É).

üí∞ <b>–ë—é–¥–∂–µ—Ç:</b> {cost}
‚è± <b>–†–µ–∞–ª—å–Ω—ñ —Å—Ç—Ä–æ–∫–∏:</b> {time}

<b>üí° –ê–Ω–∞–ª—ñ—Ç–∏–∫–∞ OPORA:</b>
–ù–∞ —Ä–∏–Ω–∫—É —î –ø—Ä–æ–ø–æ–∑–∏—Ü—ñ—ó –∑–∞ 4000 –≥—Ä–Ω ("–æ–Ω–ª–∞–π–Ω"), –∞–ª–µ —á–∞—Å—Ç–æ —Ü–µ –ª–∏—à–µ –≥–µ–Ω–µ—Ä–∞—Ü—ñ—è –¥–æ–∫—É–º–µ–Ω—Ç—ñ–≤ –±–µ–∑ –ø–æ–¥–∞–Ω–Ω—è –≤ —Å—É–¥.
–í—Ä–∞—Ö–æ–≤—É—é—á–∏, —â–æ —É 2025 —Ä–æ—Ü—ñ —Å—É–¥–æ–≤–∏–π –∑–±—ñ—Ä –∑—Ä—ñ—Å –¥–æ 1211 –≥—Ä–Ω, —è–∫—ñ—Å–Ω–∞ –ø–æ—Å–ª—É–≥–∞ "–ø—ñ–¥ –∫–ª—é—á" (–¥–µ –∞–¥–≤–æ–∫–∞—Ç —Ö–æ–¥–∏—Ç—å –≤ —Å—É–¥ –∑–∞–º—ñ—Å—Ç—å –≤–∞—Å) –Ω–µ –º–æ–∂–µ –∫–æ—à—Ç—É–≤–∞—Ç–∏ –¥–µ—à–µ–≤—à–µ –≤–∫–∞–∑–∞–Ω–æ–≥–æ –¥—ñ–∞–ø–∞–∑–æ–Ω—É.

<b>–©–æ –≤—Ö–æ–¥–∏—Ç—å —É —Ü–µ–π –±—é–¥–∂–µ—Ç:</b>
‚Ä¢ –°–ø–ª–∞—Ç–∞ —Å—É–¥–æ–≤–æ–≥–æ –∑–±–æ—Ä—É
‚Ä¢ –ö–æ–Ω—Ç—Ä–æ–ª—å —Å–ø—Ä–∞–≤–∏ (—â–æ–± –Ω–µ "–∑–∞–≥—É–±–∏–ª–∞—Å—è" –≤ –∫–∞–Ω—Ü–µ–ª—è—Ä—ñ—ó)
‚Ä¢ –û—Ç—Ä–∏–º–∞–Ω–Ω—è —Ä—ñ—à–µ–Ω–Ω—è —Å—É–¥—É""" + DISCLAIMER_TEXT,

    'A2': """‚úÖ <b>–¢–∏–ø —Å–ø—Ä–∞–≤–∏: {segment_name}</b>

–°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–∞ —Å—É–¥–æ–≤–∞ –ø—Ä–æ—Ü–µ–¥—É—Ä–∞.

üí∞ <b>–ë—é–¥–∂–µ—Ç:</b> {cost}
‚è± <b>–†–µ–∞–ª—å–Ω—ñ —Å—Ç—Ä–æ–∫–∏:</b> {time}

<b>üí° –ê–Ω–∞–ª—ñ—Ç–∏–∫–∞ OPORA:</b>
–†–µ–∞–ª—å–Ω–∏–π —Å—Ç—Ä–æ–∫ —Ä–æ–∑–≥–ª—è–¥—É –∑–∞—Ä–∞–∑ ‚Äî –Ω–µ 2 –º—ñ—Å—è—Ü—ñ (—è–∫ –≤ –∑–∞–∫–æ–Ω—ñ), –∞ 4-5 –º—ñ—Å—è—Ü—ñ–≤ —á–µ—Ä–µ–∑ –ø–æ–≤—ñ—Ç—Ä—è–Ω—ñ —Ç—Ä–∏–≤–æ–≥–∏ —Ç–∞ –≤—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è —Å–≤—ñ—Ç–ª–∞ –≤ —Å—É–¥–∞—Ö.
–í–∞–º –ø–æ—Ç—Ä—ñ–±–µ–Ω –∞–¥–≤–æ–∫–∞—Ç, —è–∫–∏–π –ø—Ä–∞—Ü—é—î —á–µ—Ä–µ–∑ —Å–∏—Å—Ç–µ–º—É "–ï–ª–µ–∫—Ç—Ä–æ–Ω–Ω–∏–π —Å—É–¥" ‚Äî —Ü–µ –ø—Ä–∏—à–≤–∏–¥—à—É—î –ø—Ä–æ—Ü–µ–¥—É—Ä—É –Ω–∞ 3-4 —Ç–∏–∂–Ω—ñ.

<b>–ö—Ä–∏—Ç–µ—Ä—ñ—ó –≤–∏–±–æ—Ä—É:</b>
‚Ä¢ –§—ñ–∫—Å–æ–≤–∞–Ω–∞ —Ü—ñ–Ω–∞ (–±–µ–∑ –¥–æ–ø–ª–∞—Ç –∑–∞ –∫–æ–∂–Ω–µ –∑–∞—Å—ñ–¥–∞–Ω–Ω—è)
‚Ä¢ –†–æ–±–æ—Ç–∞ –±–µ–∑ –≤–∞—à–æ—ó –ø—Ä–∏—Å—É—Ç–Ω–æ—Å—Ç—ñ""" + DISCLAIMER_TEXT,

    'B1': """üõ° <b>–¢–∏–ø —Å–ø—Ä–∞–≤–∏: {segment_name}</b>

–°–∫–ª–∞–¥–Ω–∞ –∫–∞—Ç–µ–≥–æ—Ä—ñ—è. –Ñ —Ä–∏–∑–∏–∫ –∑–∞—Ç—è–≥—É–≤–∞–Ω–Ω—è –ø—Ä–æ—Ü–µ—Å—É.

üí∞ <b>–ë—é–¥–∂–µ—Ç:</b> {cost}
‚è± <b>–†–µ–∞–ª—å–Ω—ñ —Å—Ç—Ä–æ–∫–∏:</b> {time}

<b>üí° –ê–Ω–∞–ª—ñ—Ç–∏–∫–∞ OPORA:</b>
–°–ø—Ä–∞–≤–∏ "–¥—ñ—Ç–∏ + –∫–æ–Ω—Ñ–ª—ñ–∫—Ç" ‚Äî –∑–æ–Ω–∞ –Ω–∞–π–≤–∏—â–æ–≥–æ —Ä–∏–∑–∏–∫—É. –¢—É—Ç –Ω–µ –ø—Ä–∞—Ü—é—é—Ç—å —à–∞–±–ª–æ–Ω–Ω—ñ –ø–æ–∑–æ–≤–∏.
–í–∞–º –ø–æ—Ç—Ä—ñ–±–µ–Ω –∞–¥–≤–æ–∫–∞—Ç, —è–∫–∏–π –æ–¥—Ä–∞–∑—É –ø–æ–¥–∞—Å—Ç—å –∫–ª–æ–ø–æ—Ç–∞–Ω–Ω—è –ø—Ä–æ –∑–∞–±–µ–∑–ø–µ—á–µ–Ω–Ω—è –ø–æ–∑–æ–≤—É (–≥—Ä–∞—Ñ—ñ–∫ –∑—É—Å—Ç—Ä—ñ—á–µ–π), —â–æ–± –≤–∏ –Ω–µ —á–µ–∫–∞–ª–∏ —Ñ—ñ–Ω–∞–ª—å–Ω–æ–≥–æ —Ä—ñ—à–µ–Ω–Ω—è 8 –º—ñ—Å—è—Ü—ñ–≤, –Ω–µ –±–∞—á–∞—á–∏ –¥–∏—Ç–∏–Ω–∏.

<b>–ù–∞ —â–æ –ø—ñ–¥–µ –±—é–¥–∂–µ—Ç:</b>
‚Ä¢ –û—Ä–≥–∞–Ω–∏ –æ–ø—ñ–∫–∏ (–ø—ñ–¥–≥–æ—Ç–æ–≤–∫–∞ –≤–∏—Å–Ω–æ–≤–∫—ñ–≤)
‚Ä¢ –£—á–∞—Å—Ç—å —É 3-5 —Å—É–¥–æ–≤–∏—Ö –∑–∞—Å—ñ–¥–∞–Ω–Ω—è—Ö
‚Ä¢ –ê–ª—ñ–º–µ–Ω—Ç–Ω–∞ —Å—Ç—Ä–∞—Ç–µ–≥—ñ—è""" + DISCLAIMER_TEXT,

    'B2': """üë®‚Äçüë©‚Äçüëß <b>–¢–∏–ø —Å–ø—Ä–∞–≤–∏: {segment_name}</b>

–ü–∞—Ä–∞–¥–æ–∫—Å–∞–ª—å–Ω–æ, –∞–ª–µ "–º–∏—Ä–Ω–∏–π" –≤–∞—Ä—ñ–∞–Ω—Ç –º–æ–∂–µ –±—É—Ç–∏ –¥–æ—Ä–æ–∂—á–∏–º –∑–∞ –∑–≤–∏—á–∞–π–Ω–∏–π —Å—É–¥.

üí∞ <b>–ë—é–¥–∂–µ—Ç:</b> {cost}
‚è± <b>–†–µ–∞–ª—å–Ω—ñ —Å—Ç—Ä–æ–∫–∏:</b> {time}

<b>üí° –ê–Ω–∞–ª—ñ—Ç–∏–∫–∞ OPORA:</b>
–ó–≥—ñ–¥–Ω–æ –∑—ñ —Å—Ç. 109 –°–ö –£–∫—Ä–∞—ó–Ω–∏, –¥–ª—è —Å–ø—ñ–ª—å–Ω–æ—ó –∑–∞—è–≤–∏ –≤–∏ –û–ë–û–í'–Ø–ó–ö–û–í–û –º—É—Å–∏—Ç–µ –ø–æ–¥–∞—Ç–∏ –Ω–æ—Ç–∞—Ä—ñ–∞–ª—å–Ω–∏–π –¥–æ–≥–æ–≤—ñ—Ä –ø—Ä–æ –¥—ñ—Ç–µ–π.
–ü–æ—Å–ª—É–≥–∏ –Ω–æ—Ç–∞—Ä—ñ—É—Å–∞ —É 2025 —Ä–æ—Ü—ñ –∫–æ—à—Ç—É—é—Ç—å 3000-6000 –≥—Ä–Ω. –¶–µ —á–∞—Å—Ç–æ —Å—Ç–∞—î —Å—é—Ä–ø—Ä–∏–∑–æ–º.
–ú–∏ –¥–æ–ø–æ–º–æ–∂–µ–º–æ –∑–Ω–∞–π—Ç–∏ –≤–∞—Ä—ñ–∞–Ω—Ç, –¥–µ —é—Ä–∏–¥–∏—á–Ω–∏–π —Å—É–ø—Ä–æ–≤—ñ–¥ + –Ω–æ—Ç–∞—Ä—ñ—É—Å –≤–ø–∏—à—É—Ç—å—Å—è –≤ –∞–¥–µ–∫–≤–∞—Ç–Ω–∏–π –±—é–¥–∂–µ—Ç.

<b>–ü–µ—Ä–µ–≤–∞–≥–∞:</b>
‚Ä¢ –ì–∞—Ä–∞–Ω—Ç–æ–≤–∞–Ω—ñ –∞–ª—ñ–º–µ–Ω—Ç–∏
‚Ä¢ –®–≤–∏–¥—à–∏–π —Ä–æ–∑–≥–ª—è–¥""" + DISCLAIMER_TEXT,

    'C1': """üíº <b>–¢–∏–ø —Å–ø—Ä–∞–≤–∏: {segment_name}</b>

–ù–∞–π–¥–æ—Ä–æ–∂—á–∞ —Ç–∞ –Ω–∞–π—Å–∫–ª–∞–¥–Ω—ñ—à–∞ –∫–∞—Ç–µ–≥–æ—Ä—ñ—è —Å–ø—Ä–∞–≤.

üí∞ <b>–ë—é–¥–∂–µ—Ç:</b> {cost}
‚è± <b>–†–µ–∞–ª—å–Ω—ñ —Å—Ç—Ä–æ–∫–∏:</b> {time}

<b>üí° –ê–Ω–∞–ª—ñ—Ç–∏–∫–∞ OPORA (–Ü–Ω—Å–∞–π–¥ –Ω–∞ –º—ñ–ª—å–π–æ–Ω):</b>
–°—É–¥–æ–≤–∏–π –∑–±—ñ—Ä –∑–∞ –ø–æ–¥—ñ–ª –º–∞–π–Ω–∞ –º–æ–∂–µ —Å—è–≥–∞—Ç–∏ 15 140 –≥—Ä–Ω.
–ê–õ–ï! –Ø–∫—â–æ –ø–æ–¥–∞—Ç–∏ –≤–∏–º–æ–≥—É –ø—Ä–æ –ø–æ–¥—ñ–ª <b>—Ä–∞–∑–æ–º</b> —ñ–∑ —Ä–æ–∑–ª—É—á–µ–Ω–Ω—è–º, "—Å—Ç–µ–ª—è" –∑–±–æ—Ä—É –∑–Ω–∏–∂—É—î—Ç—å—Å—è –¥–æ 9 084 –≥—Ä–Ω.
–¢—ñ–ª—å–∫–∏ —Ü–µ–π –Ω—é–∞–Ω—Å –µ–∫–æ–Ω–æ–º–∏—Ç—å –≤–∞–º 6000 –≥—Ä–Ω. –ë—ñ–ª—å—à—ñ—Å—Ç—å –∞–¥–≤–æ–∫–∞—Ç—ñ–≤ –ø—Ä–æ —Ü–µ –º–æ–≤—á–∞—Ç—å, –±–æ —ó–º –≤–∏–≥—ñ–¥–Ω—ñ—à–µ –ø–æ–¥–∞–≤–∞—Ç–∏ –¥–≤–∞ –æ–∫—Ä–µ–º–∏—Ö –ø–æ–∑–æ–≤–∏.

<b>–í–∏–º–æ–≥–∏ –¥–æ –∞–¥–≤–æ–∫–∞—Ç–∞:</b>
‚Ä¢ –î–æ—Å–≤—ñ–¥ —É —Å–ø—Ä–∞–≤–∞—Ö –≤—ñ–¥ 1 –º–ª–Ω –≥—Ä–Ω
‚Ä¢ –°—Ç—Ä–∞—Ç–µ–≥—ñ—è –∑–∞—Ö–∏—Å—Ç—É –∞–∫—Ç–∏–≤—ñ–≤""" + DISCLAIMER_TEXT,

    'C2': """üí∞ <b>–¢–∏–ø —Å–ø—Ä–∞–≤–∏: {segment_name}</b>

–§—ñ–Ω–∞–Ω—Å–æ–≤–µ –ø–∏—Ç–∞–Ω–Ω—è. –¢—É—Ç –≥–æ–ª–æ–≤–Ω–µ ‚Äî –º–∞—Ç–µ–º–∞—Ç–∏–∫–∞.

üí∞ <b>–ë—é–¥–∂–µ—Ç:</b> {cost}
‚è± <b>–†–µ–∞–ª—å–Ω—ñ —Å—Ç—Ä–æ–∫–∏:</b> {time}

<b>üí° –ê–Ω–∞–ª—ñ—Ç–∏–∫–∞ OPORA:</b>
–ì–æ–ª–æ–≤–Ω–∏–π —Ä–∏–∑–∏–∫ ‚Äî –Ω–æ—Ç–∞—Ä—ñ–∞–ª—å–Ω–∏–π –∑–±—ñ—Ä. –Ø–∫—â–æ –¥—ñ–ª–∏—Ç–∏ –º–∞–π–Ω–æ —á–µ—Ä–µ–∑ –Ω–æ—Ç–∞—Ä—ñ—É—Å–∞ (–º–∏—Ä–Ω–æ), –≤–∏ –∑–∞–ø–ª–∞—Ç–∏—Ç–µ 1% –¥–µ—Ä–∂–º–∏—Ç–∞ + 1% –ø–µ–Ω—Å—ñ–π–Ω–æ–≥–æ —Ñ–æ–Ω–¥—É + –ø–æ—Å–ª—É–≥–∏ –Ω–æ—Ç–∞—Ä—ñ—É—Å–∞. –î–ª—è –∫–≤–∞—Ä—Ç–∏—Ä–∏ –∑–∞ $50k —Ü–µ –±—É–¥–µ ~$1500 –≤–∏—Ç—Ä–∞—Ç –æ–¥—Ä–∞–∑—É.
–°—É–¥–æ–≤–∏–π –ø–æ–¥—ñ–ª —á–∞—Å—Ç–æ –≤–∏—Ö–æ–¥–∏—Ç—å –¥–µ—à–µ–≤—à–∏–º (—Ñ—ñ–∫—Å–æ–≤–∞–Ω–∏–π —Å—É–¥–æ–≤–∏–π –∑–±—ñ—Ä), —Ö–æ—á —ñ –¥–æ–≤—à–∏–º. –ú–∏ –ø—Ä–æ—Ä–∞—Ö—É—î–º–æ, —â–æ –≤–∏–≥—ñ–¥–Ω—ñ—à–µ —Å–∞–º–µ –≤–∞–º.

<b>–°—Ç—Ä–∞—Ç–µ–≥—ñ—è:</b>
‚Ä¢ –û—Ü—ñ–Ω–∫–∞ –∞–∫—Ç–∏–≤—ñ–≤
‚Ä¢ –ú—ñ–Ω—ñ–º—ñ–∑–∞—Ü—ñ—è –ø–æ–¥–∞—Ç–∫—ñ–≤""" + DISCLAIMER_TEXT,


    'C2_PEACE': """ü§ù <b>–¢–∏–ø —Å–ø—Ä–∞–≤–∏: –Æ—Ä–∏–¥–∏—á–Ω–µ –æ—Ñ–æ—Ä–º–ª–µ–Ω–Ω—è –ø–æ–¥—ñ–ª—É –º–∞–π–Ω–∞</b>

–í–∏ –¥–æ–º–æ–≤–∏–ª–∏—Å—è ‚Äî —Ü–µ —Å—É–ø–µ—Ä. –ó–∞–ª–∏—à–∏–ª–æ—Å—è –æ–±—Ä–∞—Ç–∏ –Ω–∞–π–¥–µ—à–µ–≤—à–∏–π —à–ª—è—Ö –æ—Ñ–æ—Ä–º–ª–µ–Ω–Ω—è, —â–æ–± –ø–æ—Ç—ñ–º –Ω—ñ—Ö—Ç–æ –Ω–µ "–ø–µ—Ä–µ–¥—É–º–∞–≤".

üí∞ <b>–ë—é–¥–∂–µ—Ç:</b> 10 000 ‚Äî 16 000 –≥—Ä–Ω
‚è± <b>–°—Ç—Ä–æ–∫–∏:</b> 3-5 –º—ñ—Å—è—Ü—ñ–≤

<b>üí° –ê–Ω–∞–ª—ñ—Ç–∏–∫–∞ OPORA:</b>
–Ñ –¥–≤–∞ —à–ª—è—Ö–∏: –ù–æ—Ç–∞—Ä—ñ—É—Å –∞–±–æ "–ú–∏—Ä–Ω–∏–π —Å—É–¥".
–ù–æ—Ç–∞—Ä—ñ—É—Å ‚Äî —Ü–µ —à–≤–∏–¥–∫–æ, –∞–ª–µ –¥–æ—Ä–æ–≥–æ (1% –¥–µ—Ä–∂–º–∏—Ç–∞ + 1% –ø–µ–Ω—Å—ñ–π–Ω–æ–≥–æ —Ñ–æ–Ω–¥—É + –ø–æ—Å–ª—É–≥–∏). –î–ª—è –∫–≤–∞—Ä—Ç–∏—Ä–∏ –∑–∞ $50k —Ü–µ ~$1500 –≤–∏—Ç—Ä–∞—Ç –æ–¥—Ä–∞–∑—É.
–ß–µ—Ä–µ–∑ —Å—É–¥ –º–æ–∂–Ω–∞ –ø–æ–¥—ñ–ª–∏—Ç–∏ –º–∞–π–Ω–æ –∑–Ω–∞—á–Ω–æ –¥–µ—à–µ–≤—à–µ (—Ñ—ñ–∫—Å–æ–≤–∞–Ω–∏–π —Å—É–¥–æ–≤–∏–π –∑–±—ñ—Ä). –ú–∏ –ø—Ä–æ—Ä–∞—Ö—É—î–º–æ, —â–æ –≤–∏–≥—ñ–¥–Ω—ñ—à–µ —Å–∞–º–µ –≤–∞–º.

<b>–©–æ –≤—Ö–æ–¥–∏—Ç—å:</b>
‚Ä¢ –ü—ñ–¥–≥–æ—Ç–æ–≤–∫–∞ –¥–æ–≥–æ–≤–æ—Ä—É/–ø–æ–∑–æ–≤—É
‚Ä¢ –ì–∞—Ä–∞–Ω—Ç—ñ—è, —â–æ –º–∞–π–Ω–æ –Ω–µ –∑–∞–±–µ—Ä—É—Ç—å —É –º–∞–π–±—É—Ç–Ω—å–æ–º—É""",

    'D1': """üåç <b>–¢–∏–ø —Å–ø—Ä–∞–≤–∏: {segment_name}</b>

–°–ø–µ—Ü–∏—Ñ—ñ–∫–∞: –ü–æ–≤–Ω–∞ –¥–∏—Å—Ç–∞–Ω—Ü—ñ–π–Ω—ñ—Å—Ç—å.

üí∞ <b>–ë—é–¥–∂–µ—Ç:</b> {cost}
‚è± <b>–†–µ–∞–ª—å–Ω—ñ —Å—Ç—Ä–æ–∫–∏:</b> {time}

<b>üí° –ê–Ω–∞–ª—ñ—Ç–∏–∫–∞ OPORA:</b>
–¶—ñ–Ω–∏ –Ω–∞ –º—ñ–∂–Ω–∞—Ä–æ–¥–Ω—ñ —Ä–æ–∑–ª—É—á–µ–Ω–Ω—è –∑—Ä–æ—Å–ª–∏ —á–µ—Ä–µ–∑ –ª–æ–≥—ñ—Å—Ç–∏–∫—É –¥–æ–∫—É–º–µ–Ω—Ç—ñ–≤.
–ö—Ä–∏—Ç–∏—á–Ω–æ –≤–∞–∂–ª–∏–≤–æ –æ–±—Ä–∞—Ç–∏ "Digital-–∞–¥–≤–æ–∫–∞—Ç–∞". –ó–≤–∏—á–∞–π–Ω–∏–π —é—Ä–∏—Å—Ç –∑–º—É—Å–∏—Ç—å –≤–∞—Å –ø–µ—Ä–µ—Å–∏–ª–∞—Ç–∏ –æ—Ä–∏–≥—ñ–Ω–∞–ª–∏ –ø–æ—à—Ç–æ—é (—Ü–µ –¥–æ–≤–≥–æ —ñ –¥–æ—Ä–æ–≥–æ). –ü—Ä–æ—Ñ—ñ–ª—å–Ω–∏–π —Å–ø–µ—Ü—ñ–∞–ª—ñ—Å—Ç –∑—Ä–æ–±–∏—Ç—å –≤—Å–µ —á–µ—Ä–µ–∑ –ï–ª–µ–∫—Ç—Ä–æ–Ω–Ω–∏–π –°—É–¥ —ñ –≤—ñ–¥–µ–æ–∫–æ–Ω—Ñ–µ—Ä–µ–Ω—Ü—ñ—é, –∑–∞–æ—â–∞–¥–∏–≤—à–∏ –≤–∞–º $200-300 –Ω–∞ –ø–µ—Ä–µ—Å–∏–ª–∞–Ω–Ω—è—Ö.

<b>–©–æ –≤—Ö–æ–¥–∏—Ç—å:</b>
‚Ä¢ –ö–æ–Ω—Å—É–ª—å—Å—å–∫—ñ –Ω—é–∞–Ω—Å–∏
‚Ä¢ –ê–ø–æ—Å—Ç–∏–ª—å –¥–æ–∫—É–º–µ–Ω—Ç—ñ–≤
‚Ä¢ –°—É–¥ –±–µ–∑ –≤—ñ–∑–∏—Ç—É –≤ –£–∫—Ä–∞—ó–Ω—É""" + DISCLAIMER_TEXT,

    'D2': """üåç <b>–¢–∏–ø —Å–ø—Ä–∞–≤–∏: {segment_name}</b>

–°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–∏–π –¥–∏—Å—Ç–∞–Ω—Ü—ñ–π–Ω–∏–π –ø—Ä–æ—Ü–µ—Å.

üí∞ <b>–ë—é–¥–∂–µ—Ç:</b> {cost}
‚è± <b>–†–µ–∞–ª—å–Ω—ñ —Å—Ç—Ä–æ–∫–∏:</b> {time}

<b>üí° –ê–Ω–∞–ª—ñ—Ç–∏–∫–∞ OPORA:</b>
–ì–æ–ª–æ–≤–Ω–∞ –ø—Ä–æ–±–ª–µ–º–∞ —Ç–∞–∫–∏—Ö —Å–ø—Ä–∞–≤ —É 2025 —Ä–æ—Ü—ñ ‚Äî –Ω–∞–ª–µ–∂–Ω–µ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è —Å—Ç–æ—Ä—ñ–Ω. –Ø–∫—â–æ –≤—ñ–¥–ø–æ–≤—ñ–¥–∞—á —Ç–µ–∂ –∑–∞ –∫–æ—Ä–¥–æ–Ω–æ–º, —Å—É–¥ –º–æ–∂–µ –≤—ñ–¥–∫–ª–∞–¥–∞—Ç–∏ —Å–ø—Ä–∞–≤—É –º—ñ—Å—è—Ü—è–º–∏.
–ú–∏ –ø—ñ–¥–±–µ—Ä–µ–º–æ —Å–ø–µ—Ü—ñ–∞–ª—ñ—Å—Ç–∞, —è–∫–∏–π –∑–Ω–∞—î, —è–∫ –ø—Ä–∞–≤–∏–ª—å–Ω–æ –æ—Ñ–æ—Ä–º–∏—Ç–∏ –≤–∏–∫–ª–∏–∫ —á–µ—Ä–µ–∑ —Å–∞–π—Ç —Å—É–¥—É, —â–æ–± –æ—Ç—Ä–∏–º–∞—Ç–∏ —Ä—ñ—à–µ–Ω–Ω—è –±–µ–∑ –∑–∞—Ç—Ä–∏–º–æ–∫.

<b>–ü–µ—Ä–µ–≤–∞–≥–∞:</b>
‚Ä¢ –í–∞–º –Ω–µ —Ç—Ä–µ–±–∞ –ø—Ä–∏—ó–∂–¥–∂–∞—Ç–∏
‚Ä¢ –í—Å–µ –∫–æ–Ω—Ç—Ä–æ–ª—é—î—Ç—å—Å—è —á–µ—Ä–µ–∑ Telegram""" + DISCLAIMER_TEXT,

    'E1': """üîç <b>–¢–∏–ø —Å–ø—Ä–∞–≤–∏: {segment_name}</b>

–ü—Ä–æ—Ü–µ–¥—É—Ä–Ω–∞ —Å–ø–µ—Ü–∏—Ñ—ñ–∫–∞: –ó–∞–æ—á–Ω–∏–π —Ä–æ–∑–≥–ª—è–¥.

üí∞ <b>–ë—é–¥–∂–µ—Ç:</b> {cost}
‚è± <b>–†–µ–∞–ª—å–Ω—ñ —Å—Ç—Ä–æ–∫–∏:</b> {time}

<b>üí° –ê–Ω–∞–ª—ñ—Ç–∏–∫–∞ OPORA:</b>
–°—É–¥–∏ –∑–∞—Ä–∞–∑ –ø–µ—Ä–µ–≤–∞–Ω—Ç–∞–∂–µ–Ω—ñ (–ø–æ–Ω–∞–¥ 1 –º–ª–Ω —Å–ø—Ä–∞–≤). –°–ø—Ä–∞–≤–∏ "–±–µ–∑ –∞–¥—Ä–µ—Å–∏" —á–∞—Å—Ç–æ –∑–∞–ª–∏—à–∞—é—Ç—å –±–µ–∑ —Ä—É—Ö—É.
–í–∞–º –ø–æ—Ç—Ä—ñ–±–µ–Ω —é—Ä–∏—Å—Ç, —è–∫–∏–π –æ–¥—Ä–∞–∑—É –ø–æ–¥–∞—Å—Ç—å –∫–ª–æ–ø–æ—Ç–∞–Ω–Ω—è –ø—Ä–æ –≤–∏–∫–ª–∏–∫ —á–µ—Ä–µ–∑ –æ–≥–æ–ª–æ—à–µ–Ω–Ω—è –Ω–∞ —Å–∞–π—Ç—ñ —Å—É–¥–æ–≤–æ—ó –≤–ª–∞–¥–∏. –¶–µ —î–¥–∏–Ω–∏–π —Å–ø–æ—Å—ñ–± –≥–∞—Ä–∞–Ω—Ç–æ–≤–∞–Ω–æ –æ—Ç—Ä–∏–º–∞—Ç–∏ —Ä–æ–∑–ª—É—á–µ–Ω–Ω—è, –∫–æ–ª–∏ –∞–¥—Ä–µ—Å–∞ –Ω–µ–≤—ñ–¥–æ–º–∞.

<b>–†–µ–∑—É–ª—å—Ç–∞—Ç:</b>
‚Ä¢ –û—Ñ—ñ—Ü—ñ–π–Ω–µ —Ä—ñ—à–µ–Ω–Ω—è —Å—É–¥—É
‚Ä¢ –ë–µ–∑ —Ä–æ–∑—à—É–∫—É –ø–æ–ª—ñ—Ü—ñ—î—é""" + DISCLAIMER_TEXT,

    'E2': """üîç <b>–¢–∏–ø —Å–ø—Ä–∞–≤–∏: {segment_name}</b>

–°–∫–ª–∞–¥–Ω–∏–π –≤–∏–ø–∞–¥–æ–∫: –°–∞–±–æ—Ç–∞–∂ –ø—Ä–æ—Ü–µ—Å—É.

üí∞ <b>–ë—é–¥–∂–µ—Ç:</b> {cost}
‚è± <b>–†–µ–∞–ª—å–Ω—ñ —Å—Ç—Ä–æ–∫–∏:</b> {time}

<b>üí° –ê–Ω–∞–ª—ñ—Ç–∏–∫–∞ OPORA:</b>
–Ø–∫—â–æ –≤—ñ–¥–ø–æ–≤—ñ–¥–∞—á –Ω–∞ –æ–∫—É–ø–æ–≤–∞–Ω—ñ–π —Ç–µ—Ä–∏—Ç–æ—Ä—ñ—ó –∞–±–æ —ñ–≥–Ω–æ—Ä—É—î —Å—É–¥, –ø—Ä–æ—Ü–µ—Å –º–æ–∂–µ –∑–∞—Ç—è–≥–Ω—É—Ç–∏—Å—è.
–ú–∏ —Ä–µ–∫–æ–º–µ–Ω–¥—É—î–º–æ –∞–¥–≤–æ–∫–∞—Ç—ñ–≤, —è–∫—ñ —Å–ø–µ—Ü—ñ–∞–ª—ñ–∑—É—é—Ç—å—Å—è –Ω–∞ –∑–∞–æ—á–Ω–∏—Ö —Ä—ñ—à–µ–Ω–Ω—è—Ö. –í–æ–Ω–∏ –∑–Ω–∞—é—Ç—å, —è–∫ –∑–∞–∫—Ä–∏—Ç–∏ —Å–ø—Ä–∞–≤—É –∑–∞ 3-4 –∑–∞—Å—ñ–¥–∞–Ω–Ω—è, –Ω–∞–≤—ñ—Ç—å —è–∫—â–æ –¥—Ä—É–≥–∞ —Å—Ç–æ—Ä–æ–Ω–∞ –∂–æ–¥–Ω–æ–≥–æ —Ä–∞–∑—É –Ω–µ –∑'—è–≤–∏—Ç—å—Å—è.

<b>–í–∏–º–æ–≥–∏:</b>
‚Ä¢ –ù–∞–ø–æ–ª–µ–≥–ª–∏–≤—ñ—Å—Ç—å
‚Ä¢ –ö–æ–Ω—Ç—Ä–æ–ª—å –∫–æ–∂–Ω–æ–≥–æ –∑–∞—Å—ñ–¥–∞–Ω–Ω—è""" + DISCLAIMER_TEXT
}

def get_consultation_booked_text(first_name, phone):
    return f"""
‚úÖ <b>–ó–∞–º–æ–≤–ª–µ–Ω–Ω—è –ø—Ä–∏–π–Ω—è—Ç–æ, {first_name}!</b>

–ú–∏ –∑–∞—Ñ—ñ–∫—Å—É–≤–∞–ª–∏ –∑–∞ –≤–∞–º–∏ –∞–∫—Ü—ñ–π–Ω—É —Ü—ñ–Ω—É ‚Äî <b>199 –≥—Ä–Ω</b>.

–ü—Ä–æ—Ç—è–≥–æ–º 15-30 —Ö–≤–∏–ª–∏–Ω (—É —Ä–æ–±–æ—á–∏–π —á–∞—Å) –Ω–∞—à –º–µ–Ω–µ–¥–∂–µ—Ä –∑–≤'—è–∂–µ—Ç—å—Å—è –∑ –≤–∞–º–∏ —É Telegram –∞–±–æ –ø–æ —Ç–µ–ª–µ—Ñ–æ–Ω—É, —â–æ–±:
1. –ù–∞–¥–∞—Ç–∏ —Ä–µ–∫–≤—ñ–∑–∏—Ç–∏ –¥–ª—è –æ–ø–ª–∞—Ç–∏.
2. –£—Ç–æ—á–Ω–∏—Ç–∏ –¥–µ—Ç–∞–ª—ñ –¥–ª—è —Å—Ç–∞—Ä—Ç—É —Ä–æ–±–æ—Ç–∏.

<i>–î—è–∫—É—î–º–æ –∑–∞ –¥–æ–≤—ñ—Ä—É –¥–æ —Å–µ—Ä–≤—ñ—Å—É OPORA!</i> üõ°
"""

# üìù –Ü–ù–®–Ü –¢–ï–ö–°–¢–ò (–Ω–µ–∑–º—ñ–Ω–Ω—ñ)
TEXT_UNKNOWN_MESSAGE = "–í–∏–±–∞—á—Ç–µ, –Ω–µ —Ä–æ–∑—É–º—ñ—é ü§î\n\n–ù–∞—Ç–∏—Å–Ω—ñ—Ç—å /start, —â–æ–± –ø–æ—á–∞—Ç–∏ —Ä–æ–∑—Ä–∞—Ö—É–Ω–æ–∫."

TEXT_PHONE_REMINDER = """
üëã –ó–¥–∞—î—Ç—å—Å—è, –≤–∏ –Ω–µ –Ω–∞—Ç–∏—Å–Ω—É–ª–∏ –∫–Ω–æ–ø–∫—É...

–©–æ–± –æ—Ç—Ä–∏–º–∞—Ç–∏ –≤–∞—à –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω–∏–π —Ä–æ–∑—Ä–∞—Ö—É–Ω–æ–∫, –±—É–¥—å –ª–∞—Å–∫–∞, –Ω–∞—Ç–∏—Å–Ω—ñ—Ç—å –∫–Ω–æ–ø–∫—É ¬´üì± –ü–æ–¥—ñ–ª–∏—Ç–∏—Å—è –Ω–æ–º–µ—Ä–æ–º¬ª.

–¶–µ –∞–±—Å–æ–ª—é—Ç–Ω–æ –±–µ–∑–ø–µ—á–Ω–æ —ñ –ø–æ—Ç—Ä—ñ–±–Ω–æ –ª–∏—à–µ –¥–ª—è —Ç–æ–≥–æ, —â–æ–± –≤—ñ–¥–ø—Ä–∞–≤–∏—Ç–∏ –≤–∞–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç.
"""

TEXT_QUIZ_REMINDER = """
üëã –ó–¥–∞—î—Ç—å—Å—è, –≤–∏ –≤—ñ–¥–≤–æ–ª—ñ–∫–ª–∏—Å—è...

–ú–∏ –∑—É–ø–∏–Ω–∏–ª–∏—Å—è –Ω–∞ –ø—ñ–≤–¥–æ—Ä–æ–∑—ñ –¥–æ —Ä–æ–∑—Ä–∞—Ö—É–Ω–∫—É –≤–∞—Ä—Ç–æ—Å—Ç—ñ. –ë–∞–∂–∞—î—Ç–µ –ø—Ä–æ–¥–æ–≤–∂–∏—Ç–∏?

–ü—Ä–æ—Å—Ç–æ –Ω–∞—Ç–∏—Å–Ω—ñ—Ç—å /start, —â–æ–± –ø–æ—á–∞—Ç–∏ –∑–∞–Ω–æ–≤–æ (—Ü–µ —à–≤–∏–¥–∫–æ!), –∞–±–æ –¥–∞–π—Ç–µ –≤—ñ–¥–ø–æ–≤—ñ–¥—å –Ω–∞ –æ—Å—Ç–∞–Ω–Ω—î –∑–∞–ø–∏—Ç–∞–Ω–Ω—è, —è–∫—â–æ –≤–æ–Ω–æ —â–µ –Ω–∞ –µ–∫—Ä–∞–Ω—ñ.
"""

# =====================================================
# –û–ë–†–û–ë–ù–ò–ö–ò –ö–û–ú–ê–ù–î
# =====================================================

async def start(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """–û–±—Ä–æ–±–Ω–∏–∫ –∫–æ–º–∞–Ω–¥–∏ /start"""
    
    user = update.effective_user

    await remove_quiz_reminder(context, user.id)
    
    # –ó–±–µ—Ä—ñ–≥–∞—î–º–æ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞ –≤ –±–∞–∑—É "All Users"
    await save_all_user(
        telegram_id=user.id,
        username=user.username,
        first_name=user.first_name,
        last_name=user.last_name
    )
    
    await log_event(user.id, user.username, "/start", "–ö–æ—Ä–∏—Å—Ç—É–≤–∞—á –ø–æ—á–∞–≤ –≤–∑–∞—î–º–æ–¥—ñ—é")
    
    # –Ü–Ω—ñ—Ü—ñ–∞–ª—ñ–∑—É—î–º–æ –¥–∞–Ω—ñ
    context.user_data.clear()
    context.user_data['telegram_id'] = user.id
    context.user_data['username'] = user.username or ''
    context.user_data['started_at'] = datetime.now().isoformat()
    
    keyboard = [[InlineKeyboardButton("‚úÖ –ü–æ—á–Ω—ñ–º–æ!", callback_data='start_quiz')]]
    reply_markup = InlineKeyboardMarkup(keyboard)
    
    await update.message.reply_text(
        TEXT_WELCOME,
        parse_mode='HTML',
        reply_markup=reply_markup
    )

# =====================================================
# –û–ë–†–û–ë–ù–ò–ö–ò –ö–í–Ü–ó–£ (FIXED v3.5 + INSIGHTS)
# =====================================================


async def question_1(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """Q1: –ß–∏ —î –¥—ñ—Ç–∏?"""
    query = update.callback_query
    await query.answer()
    
    user_id = update.effective_user.id
    username = update.effective_user.username
    await log_event(user_id, username, "quiz_started", "–ö–æ—Ä–∏—Å—Ç—É–≤–∞—á –ø–æ—á–∞–≤ –∫–≤—ñ–∑")
    
    keyboard = [
        [InlineKeyboardButton("üë∂ –¢–∞–∫, —î –¥—ñ—Ç–∏", callback_data='q1_yes')],
        [InlineKeyboardButton("‚ùå –ù–µ–º–∞—î –¥—ñ—Ç–µ–π", callback_data='q1_no')]
    ]
    await query.edit_message_text(TEXT_Q1, parse_mode='HTML', reply_markup=InlineKeyboardMarkup(keyboard))
    await schedule_quiz_reminder(context, user_id, query.message.chat_id)

async def question_1_clarify(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """–£—Ç–æ—á–Ω–µ–Ω–Ω—è: –ö–æ–Ω—Ñ–ª—ñ–∫—Ç –ø–æ –¥—ñ—Ç—è—Ö"""
    query = update.callback_query
    await query.answer()
    context.user_data['has_children'] = 'yes' # –§—ñ–∫—Å—É—î–º–æ —Ñ–∞–∫—Ç
    
    keyboard = [
        [InlineKeyboardButton("ü§ù –î–æ–º–æ–≤–∏–ª–∏—Å—è (–ú–∏—Ä–Ω–æ)", callback_data='q1_sub_peace')],
        [InlineKeyboardButton("‚öîÔ∏è –Ñ —Å—É–ø–µ—Ä–µ—á–∫–∏", callback_data='q1_sub_conflict')]
    ]
    await query.edit_message_text(TEXT_Q1_CLARIFY, parse_mode='HTML', reply_markup=InlineKeyboardMarkup(keyboard))

async def question_2_entry(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """–í—Ö—ñ–¥ —É Q2 (–ó–≥–æ–¥–∞). –û–±—Ä–æ–±–ª—è—î –ø–µ—Ä–µ—Ö–æ–¥–∏ –∑ —Ä—ñ–∑–Ω–∏—Ö –≥—ñ–ª–æ–∫."""
    query = update.callback_query
    await query.answer()
    data = query.data
    
    # –õ–æ–≥—ñ–∫–∞ –∑–±–µ—Ä–µ–∂–µ–Ω–Ω—è —Å—Ç–∞–Ω—É –∫–æ–Ω—Ñ–ª—ñ–∫—Ç—É
    if data == 'q1_no':
        context.user_data['has_children'] = 'no'
        context.user_data['conflict_children'] = 'no'
        microcommit = "‚úÖ –ó—Ä–æ–∑—É–º—ñ–ª–æ, –¥—ñ—Ç–µ–π –Ω–µ–º–∞—î.\n\n"
    elif data == 'q1_sub_peace':
        context.user_data['conflict_children'] = 'no'
        microcommit = "‚úÖ –ß—É–¥–æ–≤–æ, —â–æ –¥–æ–º–æ–≤–∏–ª–∏—Å—è –ø—Ä–æ –¥—ñ—Ç–µ–π.\n\n"
    elif data == 'q1_sub_conflict':
        context.user_data['conflict_children'] = 'yes'
        microcommit = "‚ö†Ô∏è –ó—Ä–æ–∑—É–º—ñ–ª–æ, –ø–∏—Ç–∞–Ω–Ω—è –¥—ñ—Ç–µ–π –∑–∞—Ö–∏—Å—Ç–∏–º–æ.\n\n"
    else:
        microcommit = ""

    keyboard = [
        [InlineKeyboardButton("‚úÖ –¢–∞–∫, –∑–≥–æ–¥–µ–Ω/–Ω–∞", callback_data='q2_yes')],
        [InlineKeyboardButton("‚ùå –ù—ñ, –ø—Ä–æ—Ç–∏", callback_data='q2_no')],
        [InlineKeyboardButton("ü§∑ –ù–µ –∑–Ω–∞—é", callback_data='q2_unknown')]
    ]
    await query.edit_message_text(microcommit + TEXT_Q2, parse_mode='HTML', reply_markup=InlineKeyboardMarkup(keyboard))

async def question_3(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """Q3: –ú–∞–π–Ω–æ"""
    query = update.callback_query
    await query.answer()
    
    consent = query.data.replace('q2_', '')
    context.user_data['spouse_consent'] = consent
    
    # –ú—ñ–∫—Ä–æ–∫–æ–º—ñ—Ç –∑–∞–ª–µ–∂–Ω–æ –≤—ñ–¥ –∑–≥–æ–¥–∏
    if consent == 'yes': m = MICROCOMMIT_Q2_YES
    elif consent == 'no': m = MICROCOMMIT_Q2_NO
    else: m = MICROCOMMIT_Q2_UNKNOWN

    keyboard = [
        [InlineKeyboardButton("üè† –¢–∞–∫, —î –º–∞–π–Ω–æ", callback_data='q3_yes')],
        [InlineKeyboardButton("‚ùå –ù–µ–º–∞—î –º–∞–π–Ω–∞", callback_data='q3_no')]
    ]
    await query.edit_message_text(m + TEXT_Q3, parse_mode='HTML', reply_markup=InlineKeyboardMarkup(keyboard))

async def question_3_clarify(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """–£—Ç–æ—á–Ω–µ–Ω–Ω—è: –ö–æ–Ω—Ñ–ª—ñ–∫—Ç –ø–æ –º–∞–π–Ω—É"""
    query = update.callback_query
    await query.answer()
    context.user_data['property_dispute'] = 'yes' # –§—ñ–∫—Å—É—î–º–æ —Ñ–∞–∫—Ç
    
    keyboard = [
        [InlineKeyboardButton("ü§ù –í–∂–µ –ø–æ–¥—ñ–ª–∏–ª–∏ / –î–æ–º–æ–≤–∏–ª–∏—Å—è", callback_data='q3_sub_peace')],
        [InlineKeyboardButton("‚öîÔ∏è –Ñ –∫–æ–Ω—Ñ–ª—ñ–∫—Ç / –ù–µ –¥—ñ–ª–∏—Ç—å—Å—è", callback_data='q3_sub_conflict')]
    ]
    await query.edit_message_text(TEXT_Q3_CLARIFY, parse_mode='HTML', reply_markup=InlineKeyboardMarkup(keyboard))

async def question_4_entry(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """–í—Ö—ñ–¥ —É Q4 (–õ–æ–∫–∞—Ü—ñ—è) + –ü–†–û–ì–†–Ü–í (INSIGHTS)"""
    query = update.callback_query
    await query.answer()
    chat_id = query.message.chat_id
    data = query.data
    
    # 1. –õ–æ–≥—ñ–∫–∞ –∑–±–µ—Ä–µ–∂–µ–Ω–Ω—è —Å—Ç–∞–Ω—É –º–∞–π–Ω–∞
    if data == 'q3_no':
        context.user_data['property_dispute'] = 'no'
        context.user_data['conflict_property'] = 'no'
        microcommit = "‚úÖ –ó—Ä–æ–∑—É–º—ñ–ª–æ, –±–µ–∑ –º–∞–π–Ω–∞.\n\n"
    elif data == 'q3_sub_peace':
        context.user_data['conflict_property'] = 'no'
        microcommit = "‚úÖ –î–æ–±—Ä–µ, —â–æ —î –∑–≥–æ–¥–∞ –ø–æ –º–∞–π–Ω—É.\n\n"
    elif data == 'q3_sub_conflict':
        context.user_data['conflict_property'] = 'yes'
        microcommit = "‚ö†Ô∏è –ó—Ä–æ–∑—É–º—ñ–ª–æ, –º–∞–π–Ω–æ–≤–∏–π —Å–ø—ñ—Ä.\n\n"
    else:
        microcommit = ""

    # 2. –í—ñ–¥–ø—Ä–∞–≤–ª—è—î–º–æ –º—ñ–∫—Ä–æ–∫–æ–º—ñ—Ç
    await query.edit_message_text(microcommit, parse_mode='HTML')
    
    # 3. üî• –ü–†–û–ì–†–Ü–í: –í–∏–±–∏—Ä–∞—î–º–æ —Ç–∞ –≤—ñ–¥–ø—Ä–∞–≤–ª—è—î–º–æ –Ü–Ω—Å–∞–π—Ç (Mini Case)
    trust_text = get_mini_case(context.user_data)
    
    await asyncio.sleep(1)
    await context.bot.send_chat_action(chat_id=chat_id, action=ChatAction.TYPING)
    await context.bot.send_message(chat_id=chat_id, text=trust_text, parse_mode='HTML')
    
    # –ü–∞—É–∑–∞ –Ω–∞ —á–∏—Ç–∞–Ω–Ω—è
    await asyncio.sleep(4)
    
    # 4. –ü–æ–∫–∞–∑—É—î–º–æ –ø–∏—Ç–∞–Ω–Ω—è Q4
    keyboard = [
        [InlineKeyboardButton("üá∫üá¶ –ú–∏ –æ–±–æ—î –≤ –£–∫—Ä–∞—ó–Ω—ñ", callback_data='q4_ukraine')],
        [InlineKeyboardButton("‚úàÔ∏è –•—Ç–æ—Å—å —ñ–∑ –Ω–∞—Å –∑–∞ –∫–æ—Ä–¥–æ–Ω–æ–º", callback_data='q4_abroad')],
        [InlineKeyboardButton("‚ùì –ù–µ –∑–Ω–∞—é –¥–µ —á–æ–ª–æ–≤—ñ–∫/–¥—Ä—É–∂–∏–Ω–∞", callback_data='q4_unknown')]
    ]
    await context.bot.send_message(chat_id=chat_id, text=TEXT_Q4, parse_mode='HTML', reply_markup=InlineKeyboardMarkup(keyboard))

async def question_5(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """Q5: –¢–µ—Ä–º—ñ–Ω–æ–≤—ñ—Å—Ç—å"""
    query = update.callback_query
    await query.answer()
    
    location = query.data.replace('q4_', '')
    context.user_data['spouse_location'] = location
    
    if location == 'ukraine': m = MICROCOMMIT_Q4_UKRAINE
    elif location == 'abroad': m = MICROCOMMIT_Q4_ABROAD
    else: m = MICROCOMMIT_Q4_UNKNOWN
    
    keyboard = [
        [InlineKeyboardButton("‚ö°Ô∏è –î—É–∂–µ —Ç–µ—Ä–º—ñ–Ω–æ–≤–æ (2-3 –º—ñ—Å)", callback_data='q5_high')],
        [InlineKeyboardButton("‚è≥ –ú–æ–∂—É –ø–æ—á–µ–∫–∞—Ç–∏ (4-6 –º—ñ—Å)", callback_data='q5_medium')],
        [InlineKeyboardButton("ü§∑ –ù–µ –∫—Ä–∏—Ç–∏—á–Ω–æ", callback_data='q5_low')]
    ]
    await query.edit_message_text(m + TEXT_Q5, parse_mode='HTML', reply_markup=InlineKeyboardMarkup(keyboard))

async def question_6_phone(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """Q6: –ó–∞–ø–∏—Ç —Ç–µ–ª–µ—Ñ–æ–Ω—É"""
    query = update.callback_query
    await query.answer()
    
    urgency = query.data.replace('q5_', '')
    context.user_data['urgency'] = urgency
    user_id = update.effective_user.id
    
    await remove_quiz_reminder(context, user_id)
    
    # –Ü–º–ø–æ—Ä—Ç —Ç—É—Ç, —â–æ–± –Ω–µ –ª–∞–º–∞–ª–æ—Å—å —è–∫—â–æ –Ω–∞–≥–æ—Ä—ñ –Ω–µ–º–∞—î
    from telegram import KeyboardButton, ReplyKeyboardMarkup
    keyboard = [[KeyboardButton("üì± –ü–æ–¥—ñ–ª–∏—Ç–∏—Å—è –Ω–æ–º–µ—Ä–æ–º", request_contact=True)]]
    reply_markup = ReplyKeyboardMarkup(keyboard, one_time_keyboard=True, resize_keyboard=True)
    
    await query.edit_message_text(TEXT_Q6_PHONE, parse_mode='HTML')
    await context.bot.send_message(chat_id=query.message.chat_id, text="üëá –ù–∞—Ç–∏—Å–Ω—ñ—Ç—å –∫–Ω–æ–ø–∫—É –Ω–∏–∂—á–µ:", reply_markup=reply_markup)

    context.job_queue.run_once(phone_reminder_callback, 60, chat_id=query.message.chat_id, user_id=user_id, name=f"phone_reminder_{user_id}")

async def finalize_lead_processing(update: Update, context: ContextTypes.DEFAULT_TYPE, phone_number: str):
    """–°–ø—ñ–ª—å–Ω–∞ –ª–æ–≥—ñ–∫–∞ –¥–ª—è –æ–±—Ä–æ–±–∫–∏ –æ—Ç—Ä–∏–º–∞–Ω–æ–≥–æ –Ω–æ–º–µ—Ä–∞"""
    
    user = update.effective_user
    chat_id = update.effective_chat.id
    
    first_name = context.user_data.get('first_name') or user.first_name or "–ö–ª—ñ—î–Ω—Ç"
    last_name = context.user_data.get('last_name') or user.last_name or ""
    
    context.user_data['first_name'] = first_name
    context.user_data['last_name'] = last_name
    context.user_data['phone_number'] = phone_number
    context.user_data['completed_at'] = datetime.now().isoformat()
    
    try:
        job_name = f"phone_reminder_{user.id}"
        current_jobs = context.job_queue.get_jobs_by_name(job_name)
        for job in current_jobs:
            job.schedule_removal()
    except:
        pass

    user_id = user.id
    username = user.username
    
    await log_event(user_id, username, "phone_shared", f"{first_name} - {phone_number}")
    
    if SHEETS_ALL_USERS:
        try:
            cell = SHEETS_ALL_USERS.find(str(user_id), in_column=2)
            if cell:
                SHEETS_ALL_USERS.update_cell(cell.row, 6, "–¢–∞–∫")
        except:
            pass
    
    # –°–µ–≥–º–µ–Ω—Ç–∞—Ü—ñ—è (–≤–∂–µ –∑ –¥—ñ–∞–ø–∞–∑–æ–Ω–∞–º–∏ —Ü—ñ–Ω)
    segment, segment_name, cost, time = determine_segment(context.user_data)
    context.user_data['segment'] = segment
    context.user_data['segment_name'] = segment_name
    context.user_data['cost_estimate'] = cost
    context.user_data['time_estimate'] = time
    context.user_data['status'] = 'new'
    
    logger.info(f"üìä –ù–æ–≤–∏–π –ª—ñ–¥: {first_name} ({segment} - {segment_name})")
    
    # 1. –ó–±–µ—Ä—ñ–≥–∞—î–º–æ (Sheets + Make)
    await save_to_sheets(context.user_data)
    await send_to_make(context.user_data)
    
    # –ü–æ–¥—è–∫–∞
    thanks_text = f"""
‚úÖ <b>–î—è–∫—É—é, {first_name}!</b>

–û—Å—å –ø—Ä–∏–±–ª–∏–∑–Ω–∏–π —Ä–æ–∑—Ä–∞—Ö—É–Ω–æ–∫ –í–∞—à–æ—ó —Å–∏—Ç—É–∞—Ü—ñ—ó. 
–°–ª—ñ–¥ –ø–∞–º º—è—Ç–∏—Ç–∏, —â–æ —Ü–µ —Å–µ—Ä–µ–¥–Ω—è –≤–∞—Ä—Ç—ñ—Å—Ç—å –ø–æ —Ä–∏–Ω–∫—É, –∞ –Ω–µ –æ—Å—Ç–∞—Ç–æ—á–Ω–∞ —Ü—ñ–Ω–∞
"""
    from telegram import ReplyKeyboardRemove
    await context.bot.send_message(
        chat_id=chat_id,
        text=thanks_text,
        parse_mode='HTML',
        reply_markup=ReplyKeyboardRemove()
    )
    
    # –ü–∞—É–∑–∞
    await asyncio.sleep(2)
    
    # –†–µ–∑—É–ª—å—Ç–∞—Ç (–≤–∂–µ –∑ –¥–∏—Å–∫–ª–µ–π–º–µ—Ä–æ–º)
    await send_result(update, context, segment, segment_name, cost, time)
    
    # –ü–∞—É–∑–∞ (—Ç—Ä–æ—Ö–∏ –¥–æ–≤—à–∞, –±–æ —Ç–µ–∫—Å—Ç—É –±—ñ–ª—å—à–µ)
    await asyncio.sleep(8)
    
    # –û—Ñ—Ñ–µ—Ä (Tripwire 199)
    await send_first_offer(update, context)
    
    # –ù–∞–≥–∞–¥—É–≤–∞–Ω–Ω—è –ø—Ä–æ –æ—Ñ—Ñ–µ—Ä
    job_name = f"offer_reminder_{user_id}"
    context.job_queue.run_once(
        offer_reminder_callback,
        7200, 
        chat_id=chat_id,
        user_id=user_id,
        name=job_name,
        data=first_name
    )
    logger.info(f"‚è∞ –ó–∞–ø–ª–∞–Ω–æ–≤–∞–Ω–æ –Ω–∞–≥–∞–¥—É–≤–∞–Ω–Ω—è –ø—Ä–æ –æ—Ñ—Ñ–µ—Ä –¥–ª—è {user_id} —á–µ—Ä–µ–∑ 2 –≥–æ–¥–∏–Ω–∏")
    
async def process_contact(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """–û–±—Ä–æ–±–∫–∞ –∫–æ–Ω—Ç–∞–∫—Ç—É —á–µ—Ä–µ–∑ –∫–Ω–æ–ø–∫—É"""
    contact = update.message.contact
    # –í–∏–∫–ª–∏–∫–∞—î–º–æ —Å–ø—ñ–ª—å–Ω—É —Ñ—É–Ω–∫—Ü—ñ—é
    await finalize_lead_processing(update, context, contact.phone_number)

async def save_to_sheets(user_data):
    """–ó–±–µ—Ä—ñ–≥–∞—î –¥–∞–Ω—ñ –ª—ñ–¥–∞ –≤ Google Sheets"""
    
    if SHEETS_LEADS is None:
        logger.warning("‚ö†Ô∏è Google Sheets –Ω–µ –ø—ñ–¥–∫–ª—é—á–µ–Ω–æ")
        return
    
    try:
        row = [
            user_data.get('completed_at', ''),
            str(user_data.get('telegram_id', '')),
            user_data.get('username', ''),
            user_data.get('first_name', ''),
            user_data.get('phone_number', ''),
            user_data.get('has_children', ''),
            user_data.get('spouse_consent', ''),
            user_data.get('property_dispute', ''),
            user_data.get('spouse_location', ''),
            user_data.get('urgency', ''),
            user_data.get('segment', ''),
            user_data.get('segment_name', ''),  # –î–û–î–ê–ù–û
            user_data.get('cost_estimate', ''),
            user_data.get('time_estimate', ''),
            user_data.get('status', 'new')
        ]
        
        SHEETS_LEADS.append_row(row)
        logger.info(f"‚úÖ –õ—ñ–¥ –∑–±–µ—Ä–µ–∂–µ–Ω–æ: {user_data.get('first_name')}")
        
    except Exception as e:
        logger.error(f"‚ùå –ü–æ–º–∏–ª–∫–∞ –∑–±–µ—Ä–µ–∂–µ–Ω–Ω—è: {e}")

async def send_to_make(user_data):
    """–í—ñ–¥–ø—Ä–∞–≤–ª—è—î webhook –≤ Make.com (–Ø–ö–©–û –ù–ê–õ–ê–®–¢–û–í–ê–ù–û)"""
    
    # üëá –ü–†–ï–î–û–•–†–ê–ù–ò–¢–ï–õ–¨: –ï—Å–ª–∏ —Å—Å—ã–ª–∫–∏ –Ω–µ—Ç, –ø—Ä–æ—Å—Ç–æ –≤—ã—Ö–æ–¥–∏–º
    if not MAKE_WEBHOOK_URL:
        return 
    
    try:
        payload = {
            'event': 'new_lead',
            'telegram_id': user_data.get('telegram_id'),
            'first_name': user_data.get('first_name'),
            'phone_number': user_data.get('phone_number'),
            'segment': user_data.get('segment'),
            'segment_name': user_data.get('segment_name'),
            'cost_estimate': user_data.get('cost_estimate'),
            'time_estimate': user_data.get('time_estimate'),
            'completed_at': user_data.get('completed_at')
        }
        
        # –í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î–º–æ run_in_executor, —â–æ–± requests –Ω–µ –±–ª–æ–∫—É–≤–∞–≤ –±–æ—Ç–∞
        loop = asyncio.get_running_loop()
        await loop.run_in_executor(None, lambda: requests.post(MAKE_WEBHOOK_URL, json=payload, timeout=5))
        logger.info("‚úÖ –î–∞–Ω—ñ –≤—ñ–¥–ø—Ä–∞–≤–ª–µ–Ω–æ –≤ Make")
            
    except Exception as e:
        logger.error(f"‚ö†Ô∏è Make Error (–Ω–µ –∫—Ä–∏—Ç–∏—á–Ω–æ): {e}")

async def send_lead_to_admin(context: ContextTypes.DEFAULT_TYPE, user_data):
    """–í—ñ–¥–ø—Ä–∞–≤–ª—è—î –∫—Ä–∞—Å–∏–≤—É –∫–∞—Ä—Ç–æ—á–∫—É –ª—ñ–¥–∞ –∞–¥–º—ñ–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—É –≤ Telegram"""
    
    if not ADMIN_ID:
        logger.warning("‚ö†Ô∏è ADMIN_ID –Ω–µ –≤—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ!")
        return

    text = f"""
üí∞ <b>–ó–ê–ú–û–í–õ–ï–ù–ù–Ø (199 –≥—Ä–Ω)!</b>

üë§ <b>{user_data.get('first_name')} {user_data.get('last_name')}</b>
üì± <code>{user_data.get('phone_number')}</code>
üîó @{user_data.get('username', '–Ω–µ–º–∞—î')}

üìä <b>–°–µ–≥–º–µ–Ω—Ç: {user_data.get('segment')}</b>
‚îî {user_data.get('segment_name')}

üí∞ <b>–û—Ä—ñ—î–Ω—Ç–∏—Ä:</b> {user_data.get('cost_estimate')}
‚è± <b>–°—Ç—Ä–æ–∫–∏:</b> {user_data.get('time_estimate')}

üìù <b>–í—ñ–¥–ø–æ–≤—ñ–¥—ñ:</b>
‚Ä¢ –î—ñ—Ç–∏: {user_data.get('has_children')}
‚Ä¢ –ó–≥–æ–¥–∞: {user_data.get('spouse_consent')}
‚Ä¢ –ú–∞–π–Ω–æ: {user_data.get('property_dispute')}
‚Ä¢ –õ–æ–∫–∞—Ü—ñ—è: {user_data.get('spouse_location')}
‚Ä¢ –¢–µ—Ä–º—ñ–Ω–æ–≤—ñ—Å—Ç—å: {user_data.get('urgency')}

<i>–î–∑–≤–æ–Ω–∏ —à–≤–∏–¥—à–µ! üöÄ</i>
"""

    try:
        await context.bot.send_message(chat_id=ADMIN_ID, text=text, parse_mode='HTML')
        logger.info(f"‚úÖ –õ—ñ–¥ –≤—ñ–¥–ø—Ä–∞–≤–ª–µ–Ω–æ –∞–¥–º—ñ–Ω—É ({ADMIN_ID})")
    except Exception as e:
        logger.error(f"‚ùå –ù–µ –≤–¥–∞–ª–æ—Å—è –≤—ñ–¥–ø—Ä–∞–≤–∏—Ç–∏ –ª—ñ–¥–∞ –∞–¥–º—ñ–Ω—É: {e}")
    try:
        # –í—ñ–¥–ø—Ä–∞–≤–ª—è—î–º–æ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è –∞–¥–º—ñ–Ω—É
        await context.bot.send_message(chat_id=ADMIN_ID, text=text, parse_mode='HTML')
        logger.info(f"‚úÖ –õ—ñ–¥ –≤—ñ–¥–ø—Ä–∞–≤–ª–µ–Ω–æ –∞–¥–º—ñ–Ω—É ({ADMIN_ID})")
    except Exception as e:
        logger.error(f"‚ùå –ù–µ –≤–¥–∞–ª–æ—Å—è –≤—ñ–¥–ø—Ä–∞–≤–∏—Ç–∏ –ª—ñ–¥–∞ –∞–¥–º—ñ–Ω—É: {e}")

async def send_result(update: Update, context: ContextTypes.DEFAULT_TYPE, segment, segment_name, cost, time):
    """–í—ñ–¥–ø—Ä–∞–≤–ª—è—î —Ä–µ–∑—É–ª—å—Ç–∞—Ç + –õ–ï–ì–ö–£ –î–æ—Ä–æ–∂–Ω—é –∫–∞—Ä—Ç—É (Hook)"""
    
    # 1. –û—Å–Ω–æ–≤–Ω–∏–π —Ä–æ–∑—Ä–∞—Ö—É–Ω–æ–∫
    message_template = SEGMENT_MESSAGES.get(segment, SEGMENT_MESSAGES['B2'])
    result_text = message_template.format(
        segment_name=segment_name,
        cost=cost, 
        time=time
    )
    
    await update.message.reply_text(result_text, parse_mode='HTML')
    
    # –ü–∞—É–∑–∞ –¥–ª—è —á–∏—Ç–∞–Ω–Ω—è
    await asyncio.sleep(4)
    
    # 2. –õ–ï–ì–ö–ê –î–æ—Ä–æ–∂–Ω—è –∫–∞—Ä—Ç–∞ (Hook –Ω–∞ –æ—Å–Ω–æ–≤—ñ –¥–æ—Å–ª—ñ–¥–∂–µ–Ω—å)
    roadmap_text = ""
    
    # –°—Ü–µ–Ω–∞—Ä—ñ–π: –ó–ê –ö–û–†–î–û–ù–û–ú (D1, D2)
    if 'D' in segment:
        roadmap_text = """
üìã <b>–í–∞—à –ß–µ–∫-–ª–∏—Å—Ç –¥–ª—è —Å—Ç–∞—Ä—Ç—É (–î–∏—Å—Ç–∞–Ω—Ü—ñ–π–Ω–æ):</b>
1. –ï–ª–µ–∫—Ç—Ä–æ–Ω–Ω–∏–π –∫–ª—é—á (–ö–ï–ü) ‚Äî –æ–±–æ–≤'—è–∑–∫–æ–≤–æ –ø–µ—Ä–µ–≤—ñ—Ä—Ç–µ —Ç–µ—Ä–º—ñ–Ω –¥—ñ—ó.
2. –î–æ–≤—ñ—Ä–µ–Ω—ñ—Å—Ç—å: —è–∫—â–æ —Ä–æ–±–∏—Ç–µ –∑–∞ –∫–æ—Ä–¥–æ–Ω–æ–º, –æ–±–æ–≤'—è–∑–∫–æ–≤–∏–π <b>–ê–ø–æ—Å—Ç–∏–ª—å</b> —Ç–∞ –ø–µ—Ä–µ–∫–ª–∞–¥.
3. EasyCon: –∑–∞—Ä–µ—î—Å—Ç—Ä—É–π—Ç–µ—Å—å —É —Å–∏—Å—Ç–µ–º—ñ –≤—ñ–¥–µ–æ–∑–≤'—è–∑–∫—É —Å—É–¥—É (–ø–æ—Ç—Ä—ñ–±–Ω–∞ –∫–∞–º–µ—Ä–∞).

‚ö†Ô∏è <b>–ì–æ–ª–æ–≤–Ω–∞ –ø–∞—Å—Ç–∫–∞:</b>
–°—É–¥–∏ —á–∞—Å—Ç–æ –≤—ñ–¥–∫–ª–∞–¥–∞—é—Ç—å —Å–ø—Ä–∞–≤–∏ "–±–µ–∑ –∞–¥—Ä–µ—Å–∏ –≤—ñ–¥–ø–æ–≤—ñ–¥–∞—á–∞". –ü–æ—Ç—Ä—ñ–±–Ω–æ –æ–¥—Ä–∞–∑—É –ø–æ–¥–∞–≤–∞—Ç–∏ –∫–ª–æ–ø–æ—Ç–∞–Ω–Ω—è –ø—Ä–æ –≤–∏–∫–ª–∏–∫ —á–µ—Ä–µ–∑ —Å–∞–π—Ç —Å—É–¥—É, —ñ–Ω–∞–∫—à–µ –ø—Ä–æ—Ü–µ—Å –∑–∞—Ç—è–≥–Ω–µ—Ç—å—Å—è –Ω–∞ 8+ –º—ñ—Å—è—Ü—ñ–≤.
"""

    # –°—Ü–µ–Ω–∞—Ä—ñ–π: –î–Ü–¢–ò + –ó–ì–û–î–ê (B2)
    elif 'B2' in segment:
        roadmap_text = """
üìã <b>–í–∞—à –ß–µ–∫-–ª–∏—Å—Ç (–ú–∏—Ä–Ω–∏–π —à–ª—è—Ö):</b>
1. –°–ø—ñ–ª—å–Ω–∞ –∑–∞—è–≤–∞ (–ø—ñ–¥–ø–∏—Å–∞–Ω–∞ –æ–±–æ–º–∞).
2. –û—Ä–∏–≥—ñ–Ω–∞–ª —Å–≤—ñ–¥–æ—Ü—Ç–≤–∞ –ø—Ä–æ —à–ª—é–±.
3. <b>–ù–æ—Ç–∞—Ä—ñ–∞–ª—å–Ω–∏–π –¥–æ–≥–æ–≤—ñ—Ä</b> –ø—Ä–æ –≤–∏—Ö–æ–≤–∞–Ω–Ω—è –¥—ñ—Ç–µ–π (—Å—Ç. 109 –°–ö).

‚ö†Ô∏è <b>–ì–æ–ª–æ–≤–Ω–∞ –ø–∞—Å—Ç–∫–∞:</b>
–ë–µ–∑ –Ω–æ—Ç–∞—Ä—ñ–∞–ª—å–Ω–æ–≥–æ –¥–æ–≥–æ–≤–æ—Ä—É —Å—É–¥ –ü–û–í–ï–†–ù–ï –∑–∞—è–≤—É.
–ê–ª–µ –Ω–æ—Ç–∞—Ä—ñ—É—Å–∏ –±–µ—Ä—É—Ç—å –∑–∞ –Ω—å–æ–≥–æ 4-6 —Ç–∏—Å. –≥—Ä–Ω. –ú–∏ –∑–Ω–∞—î–º–æ, —è–∫ –æ–ø—Ç–∏–º—ñ–∑—É–≤–∞—Ç–∏ —Ü–µ–π –ø—Ä–æ—Ü–µ—Å.
"""

    # –°—Ü–µ–Ω–∞—Ä—ñ–π: –ú–ê–ô–ù–û (C1, C2)
    elif 'C' in segment:
        roadmap_text = """
üìã <b>–í–∞—à –ß–µ–∫-–ª–∏—Å—Ç (–ü–æ–¥—ñ–ª –º–∞–π–Ω–∞):</b>
1. –î–æ–∫—É–º–µ–Ω—Ç–∏ –Ω–∞ –º–∞–π–Ω–æ (–í–∏—Ç—è–≥–∏ –∑ —Ä–µ—î—Å—Ç—Ä—ñ–≤).
2. –û—Ü—ñ–Ω–∫–∞ –≤–∞—Ä—Ç–æ—Å—Ç—ñ (–¥–ª—è —Ä–æ–∑—Ä–∞—Ö—É–Ω–∫—É –∑–±–æ—Ä—É).
3. –ö–≤–∏—Ç–∞–Ω—Ü—ñ—è –ø—Ä–æ —Å–ø–ª–∞—Ç—É –∑–±–æ—Ä—É (1% —Ü—ñ–Ω–∏ –ø–æ–∑–æ–≤—É).

‚ö†Ô∏è <b>–ì–æ–ª–æ–≤–Ω–∞ –ø–∞—Å—Ç–∫–∞ (–Ü–Ω—Å–∞–π–¥):</b>
–Ø–∫—â–æ —á–æ–ª–æ–≤—ñ–∫/–¥—Ä—É–∂–∏–Ω–∞ –ø—Ä–æ–¥–∞—Å—Ç—å –∞–≤—Ç–æ –¥–æ —Å—É–¥—É ‚Äî –≤–∏ –æ—Ç—Ä–∏–º–∞—î—Ç–µ 0.
–ü–æ—Ç—Ä—ñ–±–Ω–æ –ø–æ–¥–∞–≤–∞—Ç–∏ –∑–∞—è–≤—É –ø—Ä–æ <b>–ê–†–ï–®–¢ –ú–ê–ô–ù–ê</b> —â–µ –¥–æ –ø–æ–¥–∞–Ω–Ω—è –æ—Å–Ω–æ–≤–Ω–æ–≥–æ –ø–æ–∑–æ–≤—É. –¶–µ –±–ª–æ–∫—É—î –ø—Ä–æ–¥–∞–∂.
"""

    # –°—Ü–µ–Ω–∞—Ä—ñ–π: –ë–ï–ó –î–Ü–¢–ï–ô (A1, A2)
    elif 'A' in segment:
        roadmap_text = """
üìã <b>–í–∞—à –ß–µ–∫-–ª–∏—Å—Ç (–°–ø—Ä–æ—â–µ–Ω–∏–π):</b>
1. –ü–æ–∑–æ–≤–Ω–∞ –∑–∞—è–≤–∞ (—É 2 –ø—Ä–∏–º—ñ—Ä–Ω–∏–∫–∞—Ö).
2. –û—Ä–∏–≥—ñ–Ω–∞–ª —Å–≤—ñ–¥–æ—Ü—Ç–≤–∞ –ø—Ä–æ —à–ª—é–± (—Å—É–¥ –π–æ–≥–æ –∑–∞–±–µ—Ä–µ).
3. –ö–≤–∏—Ç–∞–Ω—Ü—ñ—è –ø—Ä–æ —Å–ø–ª–∞—Ç—É 1211 –≥—Ä–Ω.

‚ö†Ô∏è <b>–ì–æ–ª–æ–≤–Ω–∞ –ø–∞—Å—Ç–∫–∞:</b>
–ù–∞–≤—ñ—Ç—å —è–∫—â–æ —î –∑–≥–æ–¥–∞, —Å—É–¥ –¥–∞—Å—Ç—å "—Å—Ç—Ä–æ–∫ –Ω–∞ –ø—Ä–∏–º–∏—Ä–µ–Ω–Ω—è" (–¥–æ 6 –º—ñ—Å), —è–∫—â–æ –≤–∏ –≥—Ä–∞–º–æ—Ç–Ω–æ –Ω–µ –æ–±“ë—Ä—É–Ω—Ç—É—î—Ç–µ, —á–æ–º—É —à–ª—é–± –Ω–µ–º–æ–∂–ª–∏–≤–æ –∑–±–µ—Ä–µ–≥—Ç–∏.
"""

    # –°—Ü–µ–Ω–∞—Ä—ñ–π: –ö–û–ù–§–õ–Ü–ö–¢ (B1, E1, E2)
    else:
        roadmap_text = """
üìã <b>–í–∞—à –ß–µ–∫-–ª–∏—Å—Ç (–°—É–¥–æ–≤–∏–π —Å–ø—ñ—Ä):</b>
1. –ü–æ–∑–æ–≤–Ω–∞ –∑–∞—è–≤–∞ –∑ —á—ñ—Ç–∫–∏–º–∏ –≤–∏–º–æ–≥–∞–º–∏.
2. –î–æ–∫–∞–∑–∏ –¥–æ—Ö–æ–¥—ñ–≤ (–¥–ª—è –∞–ª—ñ–º–µ–Ω—Ç—ñ–≤).
3. –î–æ–∫–∞–∑–∏ –ø—Ä–æ–∂–∏–≤–∞–Ω–Ω—è –¥—ñ—Ç–µ–π –∑ –≤–∞–º–∏.

‚ö†Ô∏è <b>–ì–æ–ª–æ–≤–Ω–∞ –ø–∞—Å—Ç–∫–∞:</b>
–ü—ñ–¥—Å—É–¥–Ω—ñ—Å—Ç—å. –Ø–∫—â–æ –ø–æ–¥–∞—Å—Ç–µ –Ω–µ –≤ —Ç–æ–π —Å—É–¥ (–∑–∞ –º—ñ—Å—Ü–µ–º —Ä–µ—î—Å—Ç—Ä–∞—Ü—ñ—ó), —Å–ø—Ä–∞–≤—É –±—É–¥—É—Ç—å –ø–µ—Ä–µ—Å–∏–ª–∞—Ç–∏ 2 –º—ñ—Å—è—Ü—ñ.
–Ø–∫—â–æ –¥—ñ—Ç–∏ –∑ –≤–∞–º–∏ ‚Äî –º–æ–∂–Ω–∞ —Å—É–¥–∏—Ç–∏—Å—è –∑–∞ –í–ê–®–û–Æ –∞–¥—Ä–µ—Å–æ—é (—Ü–µ –∑—Ä—É—á–Ω—ñ—à–µ).
"""

    # –í—ñ–¥–ø—Ä–∞–≤–ª—è—î–º–æ –∫–∞—Ä—Ç—É
    if roadmap_text:
        await context.bot.send_message(
            chat_id=update.effective_chat.id,
            text=roadmap_text,
            parse_mode='HTML'
        )

async def send_first_offer(update: Update, context: ContextTypes.DEFAULT_TYPE):
    chat_id = update.effective_chat.id if update.effective_chat else context.user_data.get('telegram_id')
    user_id = context.user_data.get('telegram_id') # –û—Ç—Ä–∏–º—É—î–º–æ ID –∫–æ—Ä–µ–∫—Ç–Ω–æ
    first_name = context.user_data.get('first_name', '–ö–ª—ñ—î–Ω—Ç')
    
   # üëá –ù–û–í–ò–ô –¢–ï–ö–°–¢ –ó –ú'–Ø–ö–ò–ú –ü–ï–†–ï–•–û–î–û–ú üëá
    text_part_1 = f"""
{first_name}, –≤–∏ –ø–æ–±–∞—á–∏–ª–∏ –ª–∏—à–µ —á–∞—Å—Ç–∏–Ω—É –Ω—é–∞–Ω—Å—ñ–≤ (–∞—Ä–µ—à—Ç–∏, —Å—Ç—Ä–æ–∫–∏, –¥–æ–∫—É–º–µ–Ω—Ç–∏).

–ù–∞—Å–ø—Ä–∞–≤–¥—ñ –ø—ñ–¥–≤–æ–¥–Ω–∏—Ö –∫–∞–º–µ–Ω—ñ–≤ —â–µ –±—ñ–ª—å—à–µ. –ü—Ä–æ–π—Ç–∏ —Ü–µ–π —à–ª—è—Ö —Å–∞–º–æ—Å—Ç—ñ–π–Ω–æ —ñ –Ω–µ –≤—Ç—Ä–∞—Ç–∏—Ç–∏ –≥—Ä–æ—à—ñ —á–∏ –º–∞–π–Ω–æ ‚Äî —Å–∫–ª–∞–¥–Ω–µ –∑–∞–≤–¥–∞–Ω–Ω—è.

<b>–°–∞–º–µ —Ç—É—Ç –º–∏ –≤—Å—Ç—É–ø–∞—î–º–æ –≤ –≥—Ä—É.</b>
–ú–∏ –±–µ—Ä–µ–º–æ –Ω–∞ —Å–µ–±–µ –ø–æ—à—É–∫ –Ω–∞–¥—ñ–π–Ω–æ–≥–æ –∑–∞—Ö–∏—Å—Ç—É –¥–ª—è –≤–∞—Å.

–ë—ñ–ª—å—à—ñ—Å—Ç—å "–±–µ–∑–∫–æ—à—Ç–æ–≤–Ω–∏—Ö" —Å–∞–π—Ç—ñ–≤ –ø—Ä–æ—Å—Ç–æ –ø—Ä–æ–¥–∞—é—Ç—å –≤–∞—à –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω—É –±—É–¥—å-—è–∫–∏–º –∞–¥–≤–æ–∫–∞—Ç–∞–º, –∞–±–∏ –∑–∞—Ä–æ–±–∏—Ç–∏. –á–º –±–∞–π–¥—É–∂–µ –Ω–∞ —è–∫—ñ—Å—Ç—å.

<b>–ú–∏ –ø—Ä–∞—Ü—é—î–º–æ —ñ–Ω–∞–∫—à–µ.</b>
–ú–∏ –±–µ—Ä–µ–º–æ —Å–∏–º–≤–æ–ª—ñ—á–Ω—É –ø–ª–∞—Ç—É –∑ –í–ê–°, —â–æ–± –ø—Ä–∞—Ü—é–≤–∞—Ç–∏ –≤ –í–ê–®–ò–• —ñ–Ω—Ç–µ—Ä–µ—Å–∞—Ö. –¶–µ –≥–∞—Ä–∞–Ω—Ç—ñ—è –Ω–∞—à–æ—ó –Ω–µ–∑–∞–ª–µ–∂–Ω–æ—Å—Ç—ñ —Ç–∞ –æ–±'—î–∫—Ç–∏–≤–Ω–æ—Å—Ç—ñ.
"""
    await context.bot.send_message(chat_id=chat_id, text=text_part_1, parse_mode='HTML')
    
    # –î–∞–ª—ñ –∫–æ–¥ –±–µ–∑ –∑–º—ñ–Ω...
    await asyncio.sleep(7) # –¢—Ä–æ—Ö–∏ –∑–±—ñ–ª—å—à–∏–º–æ –ø–∞—É–∑—É, –±–æ —Ç–µ–∫—Å—Ç—É —Å—Ç–∞–ª–æ –±—ñ–ª—å—à–µ
    
    text_part_2 = """
üíé <b>–ü–û–°–õ–£–ì–ê "–ü–ï–†–°–û–ù–ê–õ–¨–ù–ò–ô –ü–Ü–î–ë–Ü–†"</b>

‚úÖ <b>–©–æ –≤—Ö–æ–¥–∏—Ç—å:</b>
1. <b>–ü–µ—Ä—Å–æ–Ω–∞–ª—å–Ω–∏–π –ø—ñ–¥–±—ñ—Ä:</b> 2 –ø–µ—Ä–µ–≤—ñ—Ä–µ–Ω–∏—Ö –∞–¥–≤–æ–∫–∞—Ç–∏ —Å–∞–º–µ –ø—ñ–¥ –≤–∞—à –±—é–¥–∂–µ—Ç.
2. <b>–ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ —Ä–µ–ø—É—Ç–∞—Ü—ñ—ó:</b> –ú–∏ –∑–Ω–∞—î–º–æ —ó—Ö–Ω—ñ —Ä–µ–∞–ª—å–Ω—ñ –≤–∏–≥—Ä–∞–Ω—ñ —Å–ø—Ä–∞–≤–∏.
3. <b>100% –ì–∞—Ä–∞–Ω—Ç—ñ—è:</b> –Ø–∫—â–æ –Ω–µ —Å–ø—Ä–∞—Ü—é—î—Ç–µ—Å—å ‚Äî –ø–æ–≤–µ—Ä–Ω–µ–º–æ –≥—Ä–æ—à—ñ.

üí∞ <b>–í–∞—Ä—Ç—ñ—Å—Ç—å:</b>
–°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–∞: <s>1200 –≥—Ä–Ω</s>.
üî• <b>–ó–∞—Ä–∞–∑: 199 –≥—Ä–Ω.</b>

üëá <b>–ù–∞—Ç–∏—Å–Ω—ñ—Ç—å –∫–Ω–æ–ø–∫—É, —â–æ–± –∑–∞–º–æ–≤–∏—Ç–∏:</b>
"""
    keyboard = [[InlineKeyboardButton("‚úÖ –ó–∞–º–æ–≤–∏—Ç–∏ –∑–∞ 199 –≥—Ä–Ω", callback_data='book_consultation')]]
    await context.bot.send_message(chat_id=chat_id, text=text_part_2, parse_mode='HTML', reply_markup=InlineKeyboardMarkup(keyboard))

    # üëá –ù–û–í–ï: –ü–ª–∞–Ω—É—î–º–æ –∫–Ω–æ–ø–∫—É "–ó–∞–ª–∏—à–∏–ª–∏—Å—å –ø–∏—Ç–∞–Ω–Ω—è?" —á–µ—Ä–µ–∑ 2 —Ö–≤–∏–ª–∏–Ω–∏
    context.job_queue.run_once(
        send_contact_button_job,
        120, # 120 —Å–µ–∫—É–Ω–¥ = 2 —Ö–≤–∏–ª–∏–Ω–∏
        chat_id=chat_id,
        user_id=user_id,
        name=f"contact_btn_{user_id}",
        data=context.user_data.get('first_name')
    )
    
    # –°—Ç–∞—Ä–µ –Ω–∞–≥–∞–¥—É–≤–∞–Ω–Ω—è –Ω–∞ 2 –≥–æ–¥–∏–Ω–∏ –º–æ–∂–Ω–∞ –∑–∞–ª–∏—à–∏—Ç–∏ –∞–±–æ –ø—Ä–∏–±—Ä–∞—Ç–∏, –Ω–∞ –≤–∞—à —Ä–æ–∑—Å—É–¥.
    # –Ø –± —Ä–∞–¥–∏–≤ –∑–∞–ª–∏—à–∏—Ç–∏ –π–æ–≥–æ —è–∫ "–æ—Å—Ç–∞–Ω–Ω—ñ–π —à–∞–Ω—Å", –∞–ª–µ –∑–±—ñ–ª—å—à–∏—Ç–∏ —á–∞—Å –¥–æ 3 –≥–æ–¥–∏–Ω.

async def book_consultation(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """–û–±—Ä–æ–±–∫–∞ –∑–∞–ø–∏—Å—É –Ω–∞ –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü—ñ—é (–ó –ö–û–ù–§–ï–¢–Ü —Ç–∞ –±–æ–Ω—É—Å–æ–º)"""
    
    query = update.callback_query
    await query.answer()
    
    user_data = context.user_data
    user_id = update.effective_user.id
    username = update.effective_user.username
    first_name = user_data.get('first_name', '–ö–ª—ñ—î–Ω—Ç')

    # –°–∫–∞—Å–æ–≤—É—î–º–æ –Ω–∞–≥–∞–¥—É–≤–∞–Ω–Ω—è –ø—Ä–æ –æ—Ñ—Ñ–µ—Ä
    job_name = f"offer_reminder_{user_id}"
    current_jobs = context.job_queue.get_jobs_by_name(job_name)
    if current_jobs:
        for job in current_jobs:
            job.schedule_removal()
        logger.info(f"‚è∞ –í–∏–¥–∞–ª–µ–Ω–æ –Ω–∞–≥–∞–¥—É–≤–∞–Ω–Ω—è –ø—Ä–æ –æ—Ñ—Ñ–µ—Ä –¥–ª—è {user_id} (—é–∑–µ—Ä –∑–∞–ø–∏—Å–∞–≤—Å—è)")
    
    context.user_data['status'] = 'scheduled'
    
    logger.info(f"üî• –ì–ê–†–Ø–ß–ò–ô –õ–Ü–î! {first_name} —Ö–æ—á–µ –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü—ñ—é!")
    
    # üëá –ù–û–í–ï: –í–Ü–î–ü–†–ê–í–õ–Ø–Ñ–ú–û –õ–Ü–î–ê –¢–û–ë–Ü –¢–£–¢ (–í –ú–û–ú–ï–ù–¢ –ó–ê–ü–ò–°–£)
    await send_lead_to_admin(context, user_data)
    
    await log_event(user_id, username, "consultation_booked", "–ó–∞–ø–∏—Å –Ω–∞ –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü—ñ—é!")
    
    # –û–Ω–æ–≤–ª—é—î–º–æ —Å—Ç–∞—Ç—É—Å –≤ All_Users
    if SHEETS_ALL_USERS:
        try:
            cell = SHEETS_ALL_USERS.find(str(user_id), in_column=2)
            if cell:
                SHEETS_ALL_USERS.update_cell(cell.row, 7, "scheduled")
        except:
            pass
    
    # Webhook –≤ Make (–ø–æ–≤—Ç–æ—Ä–Ω–æ, —è–∫ –ø–æ–¥—ñ—è 'consultation_request')
    if MAKE_WEBHOOK_URL:
        try:
            payload = {
                'event': 'consultation_request',
                'telegram_id': user_data.get('telegram_id'),
                'first_name': first_name,
                'phone_number': user_data.get('phone_number'),
                'segment': user_data.get('segment'),
                'segment_name': user_data.get('segment_name')
            }
            # –í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î–º–æ run_in_executor
            loop = asyncio.get_running_loop()
            await loop.run_in_executor(None, lambda: requests.post(MAKE_WEBHOOK_URL, json=payload, timeout=5))
        except:
            pass
    
    text = get_consultation_booked_text(first_name, user_data.get('phone_number'))
    
    await query.edit_message_text(text, parse_mode='HTML')
    
    # –î–∞—î–º–æ –º–∏—Ç—Ç—î–≤—É —Ü—ñ–Ω–Ω—ñ—Å—Ç—å + –ü–û–ó–ò–¢–ò–í–ù–£ –Ü–ù–°–¢–†–£–ö–¶–Ü–Æ
    await asyncio.sleep(60)
    await context.bot.send_message(
        chat_id=query.message.chat_id,
        text=f"""
üí° <b>{first_name}, –ø–æ–∫–∏ –≤–∏ –æ—á—ñ–∫—É—î—Ç–µ –¥–∑–≤—ñ–Ω–æ–∫</b> (—Ü–µ 15-30 —Ö–≤), –æ—Å—å —á–µ–∫-–ª–∏—Å—Ç '3 –≥–æ–ª–æ–≤–Ω—ñ –ø–æ–º–∏–ª–∫–∏ –ø—Ä–∏ —Ä–æ–∑–ª—É—á–µ–Ω–Ω—ñ':

<b>1. –ï–º–æ—Ü—ñ–π–Ω—ñ —Ä—ñ—à–µ–Ω–Ω—è:</b> –ü–æ—á–∏–Ω–∞—Ç–∏ –¥—ñ–ª–∏—Ç–∏ –º–∞–π–Ω–æ —á–∏ –ø—ñ–¥–ø–∏—Å—É–≤–∞—Ç–∏ –¥–æ–∫—É–º–µ–Ω—Ç–∏ –Ω–∞ –µ–º–æ—Ü—ñ—è—Ö. 
<i>(–†–µ–∑—É–ª—å—Ç–∞—Ç: –≤—Ç—Ä–∞—Ç–∞ –∞–∫—Ç–∏–≤—ñ–≤, –ø—Ä–æ —è–∫—ñ '–∑–∞–±—É–ª–∏').</i>

<b>2. –£—Å–Ω—ñ –¥–æ–º–æ–≤–ª–µ–Ω–æ—Å—Ç—ñ:</b> –í—ñ—Ä–∏—Ç–∏ –æ–±—ñ—Ü—è–Ω–∫–∞–º –ø—Ä–æ –∞–ª—ñ–º–µ–Ω—Ç–∏/–º–∞–π–Ω–æ '–Ω–∞ —Å–ª–æ–≤–∞—Ö'. 
<i>(–†–µ–∑—É–ª—å—Ç–∞—Ç: —á–µ—Ä–µ–∑ —Ä—ñ–∫ –Ω—ñ—Ö—Ç–æ –Ω—ñ—á–æ–≥–æ –Ω–µ –ø–ª–∞—Ç–∏—Ç—å, –¥–æ–≤–µ—Å—Ç–∏ –Ω–µ–º–æ–∂–ª–∏–≤–æ).</i>

<b>3. –ó–∞—Ç—è–≥—É–≤–∞–Ω–Ω—è:</b> –î—É–º–∞—Ç–∏, —â–æ '–≤—Å–µ —Å–∞–º–æ –≤–∏—Ä—ñ—à–∏—Ç—å—Å—è', —ñ –Ω–µ —Ñ—ñ–∫—Å—É–≤–∞—Ç–∏ —Å—Ç–∞—Ç—É—Å-–∫–≤–æ. 
<i>(–†–µ–∑—É–ª—å—Ç–∞—Ç: —á–æ–ª–æ–≤—ñ–∫/–¥—Ä—É–∂–∏–Ω–∞ –º–æ–∂–µ –≤–∏–≤–µ—Å—Ç–∏ –∞–∫—Ç–∏–≤–∏ –∞–±–æ –Ω–∞–±—Ä–∞—Ç–∏ –±–æ—Ä–≥—ñ–≤, —è–∫—ñ —Å—Ç–∞–Ω—É—Ç—å —Å–ø—ñ–ª—å–Ω–∏–º–∏).</i>

üìù <b>–©–û –ü–Ü–î–ì–û–¢–£–í–ê–¢–ò –î–û –†–û–ó–ú–û–í–ò:</b>
–©–æ–± –Ω–∞—à–∞ –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü—ñ—è –±—É–ª–∞ –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ –µ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—é, –∑–≥–∞–¥–∞–π—Ç–µ (–∞–±–æ –∑–∞–ø–∏—à—ñ—Ç—å) –æ—Ä—ñ—î–Ω—Ç–æ–≤–Ω—ñ –¥–∞—Ç–∏ —à–ª—é–±—É, —Å–ø–∏—Å–æ–∫ —Å–ø—ñ–ª—å–Ω–æ–≥–æ –º–∞–π–Ω–∞ —Ç–∞ –≤—ñ–∫ –¥—ñ—Ç–µ–π. –Ø–∫—â–æ —î –¥–æ–∫—É–º–µ–Ω—Ç–∏ –ø—ñ–¥ —Ä—É–∫–æ—é ‚Äî —á—É–¥–æ–≤–æ, –∞–ª–µ —Ü–µ –Ω–µ –æ–±–æ–≤'—è–∑–∫–æ–≤–æ –¥–ª—è –ø–µ—Ä—à–æ—ó —Ä–æ–∑–º–æ–≤–∏.
""",
        parse_mode='HTML'
    )

async def contact_support_handler(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """–ö–ª—ñ—î–Ω—Ç –Ω–∞—Ç–∏—Å–Ω—É–≤ '–ó–≤'—è–∑–∞—Ç–∏—Å—è –∑ –Ω–∞–º–∏'"""
    query = update.callback_query
    await query.answer()
    
    user = update.effective_user
    user_data = context.user_data
    
    # 1. –ü–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è –ö–ª—ñ—î–Ω—Ç—É
    client_text = """
‚úÖ <b>–ó–∞–ø–∏—Ç –ø—Ä–∏–π–Ω—è—Ç–æ.</b>

–ù–∞—à –º–µ–Ω–µ–¥–∂–µ—Ä –≤–∂–µ –æ—Ç—Ä–∏–º–∞–≤ —Å–ø–æ–≤—ñ—â–µ–Ω–Ω—è. 
–ú–∏ –Ω–∞–ø–∏—à–µ–º–æ –≤–∞–º –≤ –æ—Å–æ–±–∏—Å—Ç—ñ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è –≤ Telegram –ø—Ä–æ—Ç—è–≥–æ–º 30 —Ö–≤–∏–ª–∏–Ω (—É —Ä–æ–±–æ—á–∏–π —á–∞—Å).

–ü–æ–∫–∏ —á–µ–∫–∞—î—Ç–µ, –º–æ–∂–µ—Ç–µ –ø—ñ–¥–≥–æ—Ç—É–≤–∞—Ç–∏ –≤–∞—à—ñ –∑–∞–ø–∏—Ç–∞–Ω–Ω—è.
"""
    await query.edit_message_text(text=client_text, parse_mode='HTML')
    
    # 2. –ü–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è –ê–¥–º—ñ–Ω—É
    if ADMIN_ID:
        # –§–æ—Ä–º—É—î–º–æ –∫–ª—ñ–∫–∞–±–µ–ª—å–Ω–µ –ø–æ—Å–∏–ª–∞–Ω–Ω—è –Ω–∞ –∫–ª—ñ—î–Ω—Ç–∞
        user_link = f"@{user.username}" if user.username else f"<a href='tg://user?id={user.id}'>{user.first_name}</a>"
        phone = user_data.get('phone_number', '–ù–µ –≤–∫–∞–∑–∞–Ω–æ')
        
        admin_text = f"""
üôã‚Äç‚ôÇÔ∏è <b>–ö–õ–Ü–Ñ–ù–¢ –ú–ê–Ñ –ü–ò–¢–ê–ù–ù–Ø!</b>
(–ù–∞—Ç–∏—Å–Ω—É–≤ –∫–Ω–æ–ø–∫—É "–ó–≤'—è–∑–∞—Ç–∏—Å—è")

üë§ <b>–•—Ç–æ:</b> {user_link}
üì± <b>–¢–µ–ª–µ—Ñ–æ–Ω:</b> <code>{phone}</code>
üìä <b>–°–µ–≥–º–µ–Ω—Ç:</b> {user_data.get('segment_name', '–ù–µ –≤–∏–∑–Ω–∞—á–µ–Ω–æ')}

üëâ <i>–ù–∞–ø–∏—à—ñ—Ç—å –π–æ–º—É –ø–µ—Ä—à–∏–º!</i>
"""
        try:
            await context.bot.send_message(chat_id=ADMIN_ID, text=admin_text, parse_mode='HTML')
        except Exception as e:
            logger.error(f"–ù–µ –≤–¥–∞–ª–æ—Å—è —Å–ø–æ–≤—ñ—Å—Ç–∏—Ç–∏ –∞–¥–º—ñ–Ω–∞: {e}")

async def handle_text(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """–û–±—Ä–æ–±–∫–∞ —Ç–µ–∫—Å—Ç—É: –∞–±–æ —Ç–µ–ª–µ—Ñ–æ–Ω, –∞–±–æ –ø–∏—Ç–∞–Ω–Ω—è –º–µ–Ω–µ–¥–∂–µ—Ä—É"""
    text = update.message.text
    user = update.effective_user
    chat_id = update.effective_chat.id
    
    # 1. –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞: —á–∏ —Ü–µ –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω—É? (–¢—ñ–ª—å–∫–∏ —è–∫—â–æ –º–∏ –π–æ–≥–æ —á–µ–∫–∞—î–º–æ)
    urgency = context.user_data.get('urgency')
    phone_exists = context.user_data.get('phone_number')
    
    phone_pattern = re.compile(r'[\+\(\)\s\-\d]{9,20}')
    is_potential_phone = phone_pattern.search(text) and len(re.sub(r'[^\d\+]', '', text)) >= 9

    if urgency and not phone_exists and is_potential_phone:
        clean_phone = re.sub(r'[^\d\+]', '', text)
        await finalize_lead_processing(update, context, clean_phone)
        return

    # 2. –Ø–∫—â–æ —Ü–µ –ù–ï –Ω–æ–º–µ—Ä ‚Äî –∑–Ω–∞—á–∏—Ç—å —Ü–µ –ø–∏—Ç–∞–Ω–Ω—è –º–µ–Ω–µ–¥–∂–µ—Ä—É
    if ADMIN_ID:
        # –§–æ—Ä–º—É—î–º–æ –ø–æ—Å–∏–ª–∞–Ω–Ω—è –Ω–∞ —é–∑–µ—Ä–∞, —â–æ–± —Ç–∏ –º—ñ–≥ –π–æ–º—É –≤—ñ–¥–ø–∏—Å–∞—Ç–∏
        user_link = f"@{user.username}" if user.username else f"<a href='tg://user?id={user.id}'>{user.first_name}</a>"
        
        admin_text = f"""
üì© <b>–ù–û–í–ï –ü–û–í–Ü–î–û–ú–õ–ï–ù–ù–Ø –í–Ü–î –ö–õ–Ü–Ñ–ù–¢–ê!</b>

üë§ <b>–ö–ª—ñ—î–Ω—Ç:</b> {user_link}
üÜî ID: <code>{user.id}</code>

üí¨ <b>–¢–µ–∫—Å—Ç:</b>
<i>{text}</i>

üëâ <i>–ù–∞—Ç–∏—Å–Ω—ñ—Ç—å –Ω–∞ —ñ–º'—è –∞–±–æ —é–∑–µ—Ä–Ω–µ–π–º –≤–∏—â–µ, —â–æ–± –≤—ñ–¥–ø–∏—Å–∞—Ç–∏ –π–æ–º—É –≤ –æ—Å–æ–±–∏—Å—Ç—ñ.</i>
"""
        try:
            # –°–ø–æ–≤—ñ—â–∞—î–º–æ –∞–¥–º—ñ–Ω–∞
            await context.bot.send_message(chat_id=ADMIN_ID, text=admin_text, parse_mode='HTML')
            
            # –¢–∞–∫–æ–∂ –º–æ–∂–Ω–∞ –ø–µ—Ä–µ—Å–ª–∞—Ç–∏ –æ—Ä–∏–≥—ñ–Ω–∞–ª (—â–æ–± –±–∞—á–∏—Ç–∏ –∫–æ–Ω—Ç–µ–∫—Å—Ç/–º–µ–¥—ñ–∞)
            # await context.bot.forward_message(chat_id=ADMIN_ID, from_chat_id=chat_id, message_id=update.message.message_id)

            # –í—ñ–¥–ø–æ–≤—ñ–¥–∞—î–º–æ –∫–ª—ñ—î–Ω—Ç—É, —â–æ –ø—Ä–∏–π–Ω—è–ª–∏
            await update.message.reply_text("‚úÖ –ü–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è –ø—Ä–∏–π–Ω—è—Ç–æ. –ú–µ–Ω–µ–¥–∂–µ—Ä —Å–µ—Ä–≤—ñ—Å—É OPORA –æ—Ç—Ä–∏–º–∞–≤ –≤–∞—à–µ –ø–∏—Ç–∞–Ω–Ω—è —ñ –∑–≤'—è–∂–µ—Ç—å—Å—è –∑ –≤–∞–º–∏ –Ω–∞–π–±–ª–∏–∂—á–∏–º —á–∞—Å–æ–º.")
            
        except Exception as e:
            logger.error(f"–ù–µ –≤–¥–∞–ª–æ—Å—è –ø–µ—Ä–µ—Å–ª–∞—Ç–∏ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è –∞–¥–º—ñ–Ω—É: {e}")
    else:
        # –Ø–∫—â–æ –∞–¥–º—ñ–Ω –Ω–µ –Ω–∞–ª–∞—à—Ç–æ–≤–∞–Ω–∏–π
        await update.message.reply_text("–í–∏–±–∞—á—Ç–µ, –∑–∞—Ä–∞–∑ –Ω–µ–º–∞—î –∑–≤'—è–∑–∫—É –∑ –º–µ–Ω–µ–¥–∂–µ—Ä–æ–º. –°–ø—Ä–æ–±—É–π—Ç–µ –ø—ñ–∑–Ω—ñ—à–µ.")

# =====================================================
# –ù–ê–ì–ê–î–£–í–ê–ù–ù–Ø (–ó–ë–ï–†–ï–ñ–ï–ù–û –ó v3.0)
# =====================================================

def get_quiz_job_name(user_id: int) -> str:
    return f"quiz_reminder_{user_id}"

async def schedule_quiz_reminder(context: ContextTypes.DEFAULT_TYPE, user_id: int, chat_id: int):
    """–ü–ª–∞–Ω—É—î –Ω–∞–≥–∞–¥—É–≤–∞–Ω–Ω—è –ø—Ä–æ –∫–≤—ñ–∑ —á–µ—Ä–µ–∑ 5 —Ö–≤–∏–ª–∏–Ω"""
    job_name = get_quiz_job_name(user_id)
    
    # –í–∏–¥–∞–ª—è—î–º–æ —Å—Ç–∞—Ä—ñ
    current_jobs = context.job_queue.get_jobs_by_name(job_name)
    if current_jobs:
        for job in current_jobs:
            job.schedule_removal()
            logger.info(f"‚è∞ –°–∫–∞—Å–æ–≤–∞–Ω–æ —Å—Ç–∞—Ä–µ –Ω–∞–≥–∞–¥—É–≤–∞–Ω–Ω—è {job_name}")

    # –°—Ç–∞–≤–∏–º–æ –Ω–æ–≤—É
    context.job_queue.run_once(
        quiz_reminder_callback,
        300,  # 5 —Ö–≤–∏–ª–∏–Ω
        chat_id=chat_id,
        user_id=user_id,
        name=job_name
    )
    logger.info(f"‚è∞ –ó–∞–ø–ª–∞–Ω–æ–≤–∞–Ω–æ –Ω–∞–≥–∞–¥—É–≤–∞–Ω–Ω—è —á–µ—Ä–µ–∑ 5 —Ö–≤")

async def remove_quiz_reminder(context: ContextTypes.DEFAULT_TYPE, user_id: int):
    """–í–∏–¥–∞–ª—è—î –Ω–∞–≥–∞–¥—É–≤–∞–Ω–Ω—è –ø—Ä–æ –∫–≤—ñ–∑"""
    job_name = get_quiz_job_name(user_id)
    current_jobs = context.job_queue.get_jobs_by_name(job_name)
    if current_jobs:
        for job in current_jobs:
            job.schedule_removal()
        logger.info(f"‚è∞ –í–∏–¥–∞–ª–µ–Ω–æ –Ω–∞–≥–∞–¥—É–≤–∞–Ω–Ω—è {job_name}")

async def phone_reminder_callback(context: ContextTypes.DEFAULT_TYPE):
    """–ù–∞–≥–∞–¥—É–≤–∞–Ω–Ω—è –ø—Ä–æ –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω—É"""
    job = context.job
    user_id = job.user_id
    
    user_data = context.application.user_data.get(user_id)
    phone_exists = user_data and 'phone_number' in user_data
    
    if phone_exists:
        logger.info(f"‚è∞ –ù–∞–≥–∞–¥—É–≤–∞–Ω–Ω—è —Å–∫–∞—Å–æ–≤–∞–Ω–æ (–≤–∂–µ —î –Ω–æ–º–µ—Ä)")
        return
    
    logger.info(f"‚è∞ –í–Ü–î–ü–†–ê–í–õ–Ø–Æ –Ω–∞–≥–∞–¥—É–≤–∞–Ω–Ω—è –ø—Ä–æ –Ω–æ–º–µ—Ä –¥–ª—è {user_id}")
    
    from telegram import KeyboardButton, ReplyKeyboardMarkup
    keyboard = [[KeyboardButton("üì± –ü–æ–¥—ñ–ª–∏—Ç–∏—Å—è –Ω–æ–º–µ—Ä–æ–º", request_contact=True)]]
    reply_markup = ReplyKeyboardMarkup(keyboard, one_time_keyboard=True, resize_keyboard=True)

    await context.bot.send_message(
        chat_id=job.chat_id,
        text=TEXT_PHONE_REMINDER,
        parse_mode='HTML',
        reply_markup=reply_markup
    )

async def quiz_reminder_callback(context: ContextTypes.DEFAULT_TYPE):
    """–ù–∞–≥–∞–¥—É–≤–∞–Ω–Ω—è, —è–∫—â–æ –∫–∏–Ω—É–ª–∏ –∫–≤—ñ–∑ –Ω–∞ –ø—ñ–≤–¥–æ—Ä–æ–∑—ñ"""
    job = context.job
    user_id = job.user_id
    
    user_data = context.application.user_data.get(user_id, {})
    if 'phone_number' in user_data:
        return # –í–∂–µ –ø—Ä–æ–π—à–æ–≤

    # –ù–æ–≤–∏–π —Ç–µ–∫—Å—Ç: –°–µ—Ä–≤—ñ—Å–Ω–∏–π, –¥–æ–ø–æ–º–∞–≥–∞—é—á–∏–π
    text = """
üëã <b>–í–∏ –Ω–µ –∑–∞–≤–µ—Ä—à–∏–ª–∏ –¥—ñ–∞–≥–Ω–æ—Å—Ç–∏–∫—É...</b>

–ú–∏ –∑—É–ø–∏–Ω–∏–ª–∏—Å—è –Ω–∞ –≤–∞–∂–ª–∏–≤–æ–º—É –µ—Ç–∞–ø—ñ. –ë–µ–∑ –≤—ñ–¥–ø–æ–≤—ñ–¥–µ–π –Ω–∞ –æ—Å—Ç–∞–Ω–Ω—ñ –ø–∏—Ç–∞–Ω–Ω—è –º–∏ –Ω–µ –∑–º–æ–∂–µ–º–æ —Ä–æ–∑—Ä–∞—Ö—É–≤–∞—Ç–∏ —Ç–æ—á–Ω–∏–π –±—é–¥–∂–µ—Ç —Ç–∞ –ø—ñ–¥—ñ–±—Ä–∞—Ç–∏ —Å—Ç—Ä–∞—Ç–µ–≥—ñ—é.

üëá <b>–ù–∞—Ç–∏—Å–Ω—ñ—Ç—å /start, —â–æ–± –ø—Ä–æ–¥–æ–≤–∂–∏—Ç–∏ –∑ –º—ñ—Å—Ü—è –∑—É–ø–∏–Ω–∫–∏.</b>

<i>–Ø–∫—â–æ —É –≤–∞—Å –≤–∏–Ω–∏–∫–ª–∏ —Ç–µ—Ö–Ω—ñ—á–Ω—ñ —Ç—Ä—É–¥–Ω–æ—â—ñ ‚Äî –ø—Ä–æ—Å—Ç–æ –Ω–∞–ø–∏—à—ñ—Ç—å —Å–≤–æ—î –ø–∏—Ç–∞–Ω–Ω—è —Å—é–¥–∏ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è–º. –ú–µ–Ω–µ–¥–∂–µ—Ä –≤—ñ–¥–ø–æ–≤—ñ—Å—Ç—å.</i>
"""
    await context.bot.send_message(chat_id=job.chat_id, text=text, parse_mode='HTML')

async def offer_reminder_callback(context: ContextTypes.DEFAULT_TYPE):
    """–ù–∞–≥–∞–¥—É–≤–∞–Ω–Ω—è —á–µ—Ä–µ–∑ 1 –≥–æ–¥–∏–Ω—É"""
    job = context.job
    user_id = job.user_id
    chat_id = job.chat_id
    first_name = job.data

    user_data = context.application.user_data.get(user_id, {})
    status = user_data.get('status', 'new')

    if status == 'scheduled':
        return

    # –ù–æ–≤–∏–π —Ç–µ–∫—Å—Ç: –ó–∞–º—ñ—Å—Ç—å "—á–æ–º—É –Ω–µ –∫—É–ø–∏–ª–∏" -> "—á–∏ –ø–æ—Ç—Ä—ñ–±–Ω–∞ –¥–æ–ø–æ–º–æ–≥–∞?"
    text = f"""
{first_name}, —Ü–µ –º–µ–Ω–µ–¥–∂–µ—Ä —Å–µ—Ä–≤—ñ—Å—É OPORA.

–ë–∞—á—É, —â–æ –≤–∏ –æ—Ç—Ä–∏–º–∞–ª–∏ —Ä–æ–∑—Ä–∞—Ö—É–Ω–æ–∫, –∞–ª–µ –ø–æ–∫–∏ –Ω–µ –∑–∞–º–æ–≤–∏–ª–∏ <b>"Smart-–°—Ç–∞—Ä—Ç"</b>.

–ú–æ–∂–ª–∏–≤–æ, —É –≤–∞—Å –∑–∞–ª–∏—à–∏–ª–∏—Å—è –ø–∏—Ç–∞–Ω–Ω—è —â–æ–¥–æ –ø—Ä–æ—Ü–µ–¥—É—Ä–∏ –∞–±–æ –≤–∏ —Å—É–º–Ω—ñ–≤–∞—î—Ç–µ—Å—å, —á–∏ –ø—ñ–¥—ñ–π–¥–µ —Ü–µ –≤–∞–º?

‚úçÔ∏è <b>–ù–∞–ø–∏—à—ñ—Ç—å –≤–∞—à–µ –ø–∏—Ç–∞–Ω–Ω—è –ø—Ä—è–º–æ —Å—é–¥–∏ —É —á–∞—Ç.</b>
–Ø –æ—Ç—Ä–∏–º–∞—é –π–æ–≥–æ —ñ –≤—ñ–¥–ø–∏—à—É –≤–∞–º –æ—Å–æ–±–∏—Å—Ç–æ, —â–æ–± –¥–æ–ø–æ–º–æ–≥—Ç–∏ —Ä–æ–∑—ñ–±—Ä–∞—Ç–∏—Å—è.
"""
    
    await context.bot.send_message(chat_id=chat_id, text=text, parse_mode='HTML')

async def send_contact_button_job(context: ContextTypes.DEFAULT_TYPE):
    """–í—ñ–¥–ø—Ä–∞–≤–ª—è—î –∫–Ω–æ–ø–∫—É –∑–≤'—è–∑–∫—É, —è–∫—â–æ –∫–ª—ñ—î–Ω—Ç –º–æ–≤—á–∏—Ç—å 2 —Ö–≤–∏–ª–∏–Ω–∏"""
    job = context.job
    user_id = job.user_id
    first_name = job.data

    # –ü–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ, —á–∏ —é–∑–µ—Ä –≤–∂–µ –∑–∞–º–æ–≤–∏–≤ –ø–æ—Å–ª—É–≥—É
    user_data = context.application.user_data.get(user_id, {})
    if user_data.get('status') == 'scheduled':
        return

    text = f"""
{first_name}, —è –±–∞—á—É, –≤–∏ –æ–∑–Ω–∞–π–æ–º–∏–ª–∏—Å—è –∑ –ø—Ä–æ–ø–æ–∑–∏—Ü—ñ—î—é, –∞–ª–µ –ø–æ–∫–∏ –Ω–µ –Ω–∞—Ç–∏—Å–Ω—É–ª–∏ –∫–Ω–æ–ø–∫—É –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è.

–ú–æ–∂–ª–∏–≤–æ, —É –≤–∞—Å –≤–∏–Ω–∏–∫–ª–∏ —Å—É–º–Ω—ñ–≤–∏ —á–∏ –ø–∏—Ç–∞–Ω–Ω—è —â–æ–¥–æ –ø—Ä–æ—Ü–µ–¥—É—Ä–∏?
–ú–∏ –Ω–∞ –∑–≤'—è–∑–∫—É —ñ –≥–æ—Ç–æ–≤—ñ –ø—ñ–¥–∫–∞–∑–∞—Ç–∏.
"""
    keyboard = [[InlineKeyboardButton("üí¨ –ó–∞–ª–∏—à–∏–ª–∏—Å—å –ø–∏—Ç–∞–Ω–Ω—è? –ó–≤ º—è–∂—ñ—Ç—å—Å—è –∑ –Ω–∞–º–∏", callback_data='contact_support')]]
    
    await context.bot.send_message(
        chat_id=job.chat_id, 
        text=text, 
        parse_mode='HTML', 
        reply_markup=InlineKeyboardMarkup(keyboard)
    )

# =====================================================
# –û–ë–†–û–ë–ù–ò–ö –ü–û–ú–ò–õ–û–ö (Global Error Handler)
# =====================================================

async def error_handler(update: object, context: ContextTypes.DEFAULT_TYPE) -> None:
    """–õ–æ–≥—É—î –ø–æ–º–∏–ª–∫—É —Ç–∞ –ø–æ–≤—ñ–¥–æ–º–ª—è—î –∞–¥–º—ñ–Ω–∞"""
    logger.error(msg="Exception while handling an update:", exc_info=context.error)

    # –Ø–∫—â–æ —î ADMIN_ID, –ø–æ–≤—ñ–¥–æ–º–ª—è—î–º–æ –π–æ–≥–æ –ø—Ä–æ –∑–±—ñ–π
    if ADMIN_ID:
        try:
            # –§–æ—Ä–º—É—î–º–æ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è –ø—Ä–æ –ø–æ–º–∏–ª–∫—É
            error_message = f"‚ö†Ô∏è <b>–£ –±–æ—Ç–∞ —Å—Ç–∞–ª–∞—Å—è –ø–æ–º–∏–ª–∫–∞!</b>\n\n<code>{context.error}</code>"
            
            # –û–±—Ä—ñ–∑–∞—î–º–æ, —è–∫—â–æ –∑–∞–Ω–∞–¥—Ç–æ –¥–æ–≤–≥–µ
            if len(error_message) > 2000:
                error_message = error_message[:2000]
            
            await context.bot.send_message(chat_id=ADMIN_ID, text=error_message, parse_mode='HTML')
        except:
            # –Ø–∫—â–æ –Ω–µ –≤–¥–∞–ª–æ—Å—è –≤—ñ–¥–ø—Ä–∞–≤–∏—Ç–∏ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è –∞–¥–º—ñ–Ω—É, –ø—Ä–æ—Å—Ç–æ –º–æ–≤—á–∏–º–æ (–ø–æ–º–∏–ª–∫–∞ –≤–∂–µ –≤ –ª–æ–≥–∞—Ö)
            pass

# =====================================================
# –ì–û–õ–û–í–ù–ê –§–£–ù–ö–¶–Ü–Ø
# =====================================================

def main():
    """–ó–∞–ø—É—Å–∫ –±–æ—Ç–∞"""
    
    logger.info("=" * 60)
    logger.info("ü§ñ –ó–ê–ü–£–°–ö –ë–û–¢–ê v3.1 ULTIMATE IMPROVED")
    logger.info("=" * 60)
    
    # –ó–∞–ø—É—Å–∫–∞—î–º–æ Flask
    flask_thread = threading.Thread(target=run_flask, daemon=True)
    flask_thread.start()
    logger.info("üåê Flask web-server –∑–∞–ø—É—â–µ–Ω–æ")
    
    # –°—Ç–≤–æ—Ä—é—î–º–æ Application
    application = Application.builder().token(BOT_TOKEN).build()
    
    # –†–µ—î—Å—Ç—Ä—É—î–º–æ –æ–±—Ä–æ–±–Ω–∏–∫–∏
    application.add_handler(CommandHandler("start", start))
 # === –û–ù–û–í–õ–ï–ù–Ü –•–ï–ù–î–õ–ï–†–ò –ö–í–Ü–ó–£ ===
    
    # 1. –°—Ç–∞—Ä—Ç –∫–≤—ñ–∑—É
    application.add_handler(CallbackQueryHandler(question_1, pattern='^start_quiz$'))
    
    # 2. –ì—ñ–ª–∫–∞ –¥—ñ—Ç–µ–π
    # –Ø–∫—â–æ "–¢–∞–∫, –¥—ñ—Ç–∏ —î" -> –π–¥–µ–º–æ –Ω–∞ —É—Ç–æ—á–Ω–µ–Ω–Ω—è
    application.add_handler(CallbackQueryHandler(question_1_clarify, pattern='^q1_yes$'))
    
    # –ü–µ—Ä–µ—Ö—ñ–¥ –Ω–∞ –ü–∏—Ç–∞–Ω–Ω—è 2 (–ó–≥–æ–¥–∞): —Å–ø—Ä–∞—Ü—å–æ–≤—É—î —è–∫—â–æ –¥—ñ—Ç–µ–π –Ω–µ–º–∞—î –ê–ë–û –ø—Ä–æ–π—à–ª–∏ —É—Ç–æ—á–Ω–µ–Ω–Ω—è
    application.add_handler(CallbackQueryHandler(question_2_entry, pattern='^(q1_no|q1_sub_.*)$'))
    
    # 3. –ü–∏—Ç–∞–Ω–Ω—è 3 (–ú–∞–π–Ω–æ)
    application.add_handler(CallbackQueryHandler(question_3, pattern='^q2_'))
    
    # –ì—ñ–ª–∫–∞ –º–∞–π–Ω–∞
    # –Ø–∫—â–æ "–¢–∞–∫, –º–∞–π–Ω–æ —î" -> –π–¥–µ–º–æ –Ω–∞ —É—Ç–æ—á–Ω–µ–Ω–Ω—è
    application.add_handler(CallbackQueryHandler(question_3_clarify, pattern='^q3_yes$'))
    
    # –ü–µ—Ä–µ—Ö—ñ–¥ –Ω–∞ –ü–∏—Ç–∞–Ω–Ω—è 4 (–õ–æ–∫–∞—Ü—ñ—è): —Å–ø—Ä–∞—Ü—å–æ–≤—É—î —è–∫—â–æ –º–∞–π–Ω–∞ –Ω–µ–º–∞—î –ê–ë–û –ø—Ä–æ–π—à–ª–∏ —É—Ç–æ—á–Ω–µ–Ω–Ω—è
    application.add_handler(CallbackQueryHandler(question_4_entry, pattern='^(q3_no|q3_sub_.*)$'))
    
    # 4. –†–µ—à—Ç–∞ (–±–µ–∑ –∑–º—ñ–Ω)
    application.add_handler(CallbackQueryHandler(question_5, pattern='^q4_'))
    application.add_handler(CallbackQueryHandler(question_6_phone, pattern='^q5_'))
    application.add_handler(CallbackQueryHandler(book_consultation, pattern='^book_consultation$'))
    application.add_handler(CallbackQueryHandler(contact_support_handler, pattern='^contact_support$'))
    application.add_handler(MessageHandler(filters.CONTACT, process_contact))
    application.add_handler(MessageHandler(filters.TEXT & ~filters.COMMAND, handle_text))

    application.add_error_handler(error_handler)
    
    logger.info("üöÄ –ë–æ—Ç v3.1 –∑–∞–ø—É—â–µ–Ω–æ!")
    logger.info("üìä 10 —Å–µ–≥–º–µ–Ω—Ç—ñ–≤ –∞–∫—Ç–∏–≤–æ–≤–∞–Ω–æ")
    logger.info("üí¨ –î–µ—Ç–∞–ª—å–Ω—ñ –º–∏–Ω—ñ-–∫–µ–π—Å–∏ –∞–∫—Ç–∏–≤–æ–≤–∞–Ω–æ")
    logger.info("=" * 60)
    
    application.run_polling(allowed_updates=Update.ALL_TYPES)

if __name__ == '__main__':
    main()
