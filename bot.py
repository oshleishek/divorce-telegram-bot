"""
Telegram Bot: OPORA | –°–µ—Ä–≤—ñ—Å –ø—ñ–¥–±–æ—Ä—É –∞–¥–≤–æ–∫–∞—Ç—ñ–≤
–í–µ—Ä—Å—ñ—è: 3.5 FINAL (Stable Render Fix + Deep Diagnostic + Market Data 2025)
"""

import os
import logging
import random
import re
import threading
import asyncio
from datetime import datetime

from telegram import Update, InlineKeyboardButton, InlineKeyboardMarkup, ReactionTypeEmoji, KeyboardButton, ReplyKeyboardMarkup
from telegram.ext import Application, CommandHandler, CallbackQueryHandler, MessageHandler, filters, ContextTypes
from telegram.constants import ChatAction

import gspread
from oauth2client.service_account import ServiceAccountCredentials
import requests
from flask import Flask

# =====================================================
# 1. –ù–ê–õ–ê–®–¢–£–í–ê–ù–ù–Ø
# =====================================================

logging.basicConfig(
    format='%(asctime)s - %(name)s - %(levelname)s - %(message)s',
    level=logging.INFO
)
logger = logging.getLogger(__name__)

BOT_TOKEN = os.environ.get('BOT_TOKEN')
GOOGLE_SHEET_URL = os.environ.get('GOOGLE_SHEET_URL')
ADMIN_ID = os.environ.get('ADMIN_ID')
MAKE_WEBHOOK_URL = os.environ.get('MAKE_WEBHOOK_URL')

# =====================================================
# 2. GOOGLE SHEETS
# =====================================================

def init_google_sheets():
    try:
        required_vars = ['GOOGLE_PROJECT_ID', 'GOOGLE_PRIVATE_KEY', 'GOOGLE_CLIENT_EMAIL', 'GOOGLE_SHEET_URL']
        missing_vars = [var for var in required_vars if not os.environ.get(var)]
        
        if missing_vars:
            logger.warning(f"‚ö†Ô∏è Google Sheets –Ω–µ –Ω–∞–ª–∞—à—Ç–æ–≤–∞–Ω–æ (–Ω–µ–º–∞—î: {', '.join(missing_vars)})")
            return None, None, None
        
        scope = ['https://spreadsheets.google.com/feeds', 'https://www.googleapis.com/auth/drive']
        
        creds_dict = {
            "type": "service_account",
            "project_id": os.environ.get('GOOGLE_PROJECT_ID'),
            "private_key_id": os.environ.get('GOOGLE_PRIVATE_KEY_ID'),
            "private_key": os.environ.get('GOOGLE_PRIVATE_KEY', '').replace('\\n', '\n'),
            "client_email": os.environ.get('GOOGLE_CLIENT_EMAIL'),
            "client_id": os.environ.get('GOOGLE_CLIENT_ID'),
            "auth_uri": "https://accounts.google.com/o/oauth2/auth",
            "token_uri": "https://oauth2.googleapis.com/token",
            "auth_provider_x509_cert_url": "https://www.googleapis.com/oauth2/v1/certs",
            "client_x509_cert_url": os.environ.get('GOOGLE_CERT_URL')
        }
        
        creds = ServiceAccountCredentials.from_json_keyfile_dict(creds_dict, scope)
        client = gspread.authorize(creds)
        spreadsheet = client.open_by_url(GOOGLE_SHEET_URL)
        
        try:
            leads_sheet = spreadsheet.worksheet("Leads")
        except gspread.WorksheetNotFound:
            leads_sheet = spreadsheet.add_worksheet("Leads", rows=1000, cols=20)
            leads_sheet.append_row(["–î–∞—Ç–∞", "ID", "Username", "–Ü–º'—è", "–¢–µ–ª–µ—Ñ–æ–Ω", "–î—ñ—Ç–∏", "–ö–æ–Ω—Ñ–ª—ñ–∫—Ç_–î—ñ—Ç–∏", "–ó–≥–æ–¥–∞", "–ú–∞–π–Ω–æ", "–ö–æ–Ω—Ñ–ª—ñ–∫—Ç_–ú–∞–π–Ω–æ", "–õ–æ–∫–∞—Ü—ñ—è", "–¢–µ—Ä–º—ñ–Ω–æ–≤—ñ—Å—Ç—å", "–°–µ–≥–º–µ–Ω—Ç", "–ù–∞–∑–≤–∞", "–í–∞—Ä—Ç—ñ—Å—Ç—å", "–°—Ç—Ä–æ–∫–∏", "–°—Ç–∞—Ç—É—Å"])
        
        try:
            analytics_sheet = spreadsheet.worksheet("Analytics")
        except gspread.WorksheetNotFound:
            analytics_sheet = spreadsheet.add_worksheet("Analytics", rows=5000, cols=10)
            analytics_sheet.append_row(["Timestamp", "ID", "Username", "Event", "Details"])
        
        try:
            all_users_sheet = spreadsheet.worksheet("All_Users")
        except gspread.WorksheetNotFound:
            all_users_sheet = spreadsheet.add_worksheet("All_Users", rows=5000, cols=10)
            all_users_sheet.append_row(["–î–∞—Ç–∞", "ID", "Username", "First Name", "Last Name", "–ó–∞–≤–µ—Ä—à–∏–≤", "–°—Ç–∞—Ç—É—Å"])
            
        logger.info("‚úÖ Google Sheets –ø—ñ–¥–∫–ª—é—á–µ–Ω–æ —É—Å–ø—ñ—à–Ω–æ")
        return leads_sheet, analytics_sheet, all_users_sheet
        
    except Exception as e:
        logger.error(f"‚ùå –ü–æ–º–∏–ª–∫–∞ Google Sheets: {e}")
        return None, None, None

SHEETS_LEADS, SHEETS_ANALYTICS, SHEETS_ALL_USERS = init_google_sheets()

# =====================================================
# 3. –¢–ï–ö–°–¢–ò –¢–ê –Ü–ù–°–ê–ô–¢–ò
# =====================================================

TEXT_WELCOME = """
–ú–∏ –≥–æ—Ç–æ–≤—ñ –ø—Ä–æ–∞–Ω–∞–ª—ñ–∑—É–≤–∞—Ç–∏ –≤–∞—à—É —Å–∏—Ç—É–∞—Ü—ñ—é.

–¶–µ –∑–∞–π–º–µ 2 —Ö–≤–∏–ª–∏–Ω–∏:
1. –í–∏ –≤—ñ–¥–ø–æ–≤—ñ–¥–∞—î—Ç–µ –Ω–∞ 5 –ø—Ä–æ—Å—Ç–∏—Ö –ø–∏—Ç–∞–Ω—å.
2. –Ø–∫—â–æ –ø–æ—Ç—Ä—ñ–±–Ω–æ ‚Äî –º–∏ —É—Ç–æ—á–Ω—é—î–º–æ –¥–µ—Ç–∞–ª—ñ (—â–æ–± –Ω–µ –ø–æ–º–∏–ª–∏—Ç–∏—Å—è).
3. –°–∏—Å—Ç–µ–º–∞ —Ñ–æ—Ä–º—É—î —Ç–æ—á–Ω–∏–π —é—Ä–∏–¥–∏—á–Ω–∏–π —Ç–∞ —Ñ—ñ–Ω–∞–Ω—Å–æ–≤–∏–π –ø—Ä–æ–≥–Ω–æ–∑.

<i>–ù–∞—Ç–∏—Å–Ω—ñ—Ç—å –∫–Ω–æ–ø–∫—É –Ω–∏–∂—á–µ, —â–æ–± —Ä–æ–∑–ø–æ—á–∞—Ç–∏ –¥—ñ–∞–≥–Ω–æ—Å—Ç–∏–∫—É.</i> üëá
"""

# –ü–∏—Ç–∞–Ω–Ω—è
TEXT_Q1 = "<b>–ü–∏—Ç–∞–Ω–Ω—è 1 –∑ 5:</b>\n\n–ß–∏ —î —É –≤–∞—Å —Å–ø—ñ–ª—å–Ω—ñ –¥—ñ—Ç–∏ (–¥–æ 18 —Ä–æ–∫—ñ–≤)?"
TEXT_Q1_CLARIFY = "<b>–£—Ç–æ—á–Ω–µ–Ω–Ω—è –ø–æ –¥—ñ—Ç—è—Ö:</b>\n\n–ß–∏ —î —É –≤–∞—Å —Å–ø—ñ—Ä –∑ —á–æ–ª–æ–≤—ñ–∫–æ–º/–¥—Ä—É–∂–∏–Ω–æ—é —â–æ–¥–æ —Ç–æ–≥–æ, –∑ –∫–∏–º –∂–∏—Ç–∏–º—É—Ç—å –¥—ñ—Ç–∏, –∞–±–æ —â–æ–¥–æ —Ä–æ–∑–º—ñ—Ä—É –∞–ª—ñ–º–µ–Ω—Ç—ñ–≤?\n\n<i>–¶–µ –∫–∞—Ä–¥–∏–Ω–∞–ª—å–Ω–æ –≤–ø–ª–∏–≤–∞—î –Ω–∞ —Å–∫–ª–∞–¥–Ω—ñ—Å—Ç—å —Å–ø—Ä–∞–≤–∏.</i>"

TEXT_Q2 = "<b>–ü–∏—Ç–∞–Ω–Ω—è 2 –∑ 5:</b>\n\n–ß–∏ –∑–≥–æ–¥–µ–Ω(–Ω–∞) –≤–∞—à —á–æ–ª–æ–≤—ñ–∫/–¥—Ä—É–∂–∏–Ω–∞ –Ω–∞ —Ä–æ–∑–ª—É—á–µ–Ω–Ω—è?"

TEXT_Q3 = "<b>–ü–∏—Ç–∞–Ω–Ω—è 3 –∑ 5:</b>\n\n–ß–∏ —î —Å–ø—ñ–ª—å–Ω–µ –º–∞–π–Ω–æ, —è–∫–µ –≤–∏ –ø–ª–∞–Ω—É—î—Ç–µ –¥—ñ–ª–∏—Ç–∏?\n<i>(–ö–≤–∞—Ä—Ç–∏—Ä–∞, –∞–≤—Ç–æ, –±—ñ–∑–Ω–µ—Å, –∫—Ä–µ–¥–∏—Ç–∏)</i>"
TEXT_Q3_CLARIFY = "<b>–£—Ç–æ—á–Ω–µ–Ω–Ω—è –ø–æ –º–∞–π–Ω—É:</b>\n\n–ß–∏ —î –º—ñ–∂ –≤–∞–º–∏ –∫–æ–Ω—Ñ–ª—ñ–∫—Ç —â–æ–¥–æ –ø–æ–¥—ñ–ª—É?\n\n<i>–¢–æ–±—Ç–æ: –≤–∏ –≤–∂–µ –¥–æ–º–æ–≤–∏–ª–∏—Å—è, –∫–æ–º—É —â–æ –¥—ñ—Å—Ç–∞–Ω–µ—Ç—å—Å—è (–º–∏—Ä–Ω–æ), —á–∏ –∫–æ–∂–µ–Ω —Ç—è–≥–Ω–µ –∫–æ–≤–¥—Ä—É –Ω–∞ —Å–µ–±–µ (—Å—É–¥)?</i>"

TEXT_Q4 = "<b>–ü–∏—Ç–∞–Ω–Ω—è 4 –∑ 5:</b>\n\n–î–µ –∑–∞—Ä–∞–∑ –ø–µ—Ä–µ–±—É–≤–∞—î—Ç–µ –≤–∏ —Ç–∞ –≤–∞—à —á–æ–ª–æ–≤—ñ–∫/–¥—Ä—É–∂–∏–Ω–∞?"
TEXT_Q5 = "<b>–ü–∏—Ç–∞–Ω–Ω—è 5 –∑ 5:</b>\n\n–ù–∞—Å–∫—ñ–ª—å–∫–∏ —Ç–µ—Ä–º—ñ–Ω–æ–≤–æ –≤–∞–º –ø–æ—Ç—Ä—ñ–±–Ω–æ —Ä–æ–∑–ª—É—á–µ–Ω–Ω—è?"

TEXT_Q6_PHONE = """
‚úÖ <b>–î—ñ–∞–≥–Ω–æ—Å—Ç–∏–∫—É –∑–∞–≤–µ—Ä—à–µ–Ω–æ!</b>

–°–∏—Å—Ç–µ–º–∞ –ø—Ä–æ–∞–Ω–∞–ª—ñ–∑—É–≤–∞–ª–∞ –≤–∞—à—ñ –≤—ñ–¥–ø–æ–≤—ñ–¥—ñ (–≤–∫–ª—é—á–∞—é—á–∏ –Ω—é–∞–Ω—Å–∏ –ø–æ –¥—ñ—Ç—è—Ö —Ç–∞ –º–∞–π–Ω—É) —ñ —Å—Ñ–æ—Ä–º—É–≤–∞–ª–∞:
1. <b>–†–∏–Ω–∫–æ–≤–∏–π –±—é–¥–∂–µ—Ç</b> (—â–æ–± –≤–∏ –Ω–µ –ø–µ—Ä–µ–ø–ª–∞—Ç–∏–ª–∏).
2. <b>–†–µ–∞–ª—å–Ω—ñ —Å—Ç—Ä–æ–∫–∏</b> (–∑ —É—Ä–∞—Ö—É–≤–∞–Ω–Ω—è–º –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è —Å—É–¥—ñ–≤).
3. <b>–ü–µ—Ä—Å–æ–Ω–∞–ª—å–Ω–∏–π –ø–ª–∞–Ω –¥—ñ–π</b>.

üëá <b>–ù–∞—Ç–∏—Å–Ω—ñ—Ç—å –∫–Ω–æ–ø–∫—É "–ü–æ–¥—ñ–ª–∏—Ç–∏—Å—è –Ω–æ–º–µ—Ä–æ–º", —â–æ–± –ø–æ–±–∞—á–∏—Ç–∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç.</b>
"""

TEXT_UNKNOWN_MESSAGE = "–í–∏–±–∞—á—Ç–µ, –Ω–µ —Ä–æ–∑—É–º—ñ—é ü§î\n–ù–∞—Ç–∏—Å–Ω—ñ—Ç—å /start."
TEXT_PHONE_REMINDER = "üëã –í–∏ –∑–∞–±—É–ª–∏ –Ω–∞—Ç–∏—Å–Ω—É—Ç–∏ –∫–Ω–æ–ø–∫—É ¬´–ü–æ–¥—ñ–ª–∏—Ç–∏—Å—è –Ω–æ–º–µ—Ä–æ–º¬ª..."
TEXT_QUIZ_REMINDER = "üëã –ú–∏ –∑—É–ø–∏–Ω–∏–ª–∏—Å—è –Ω–∞ –ø—ñ–≤–¥–æ—Ä–æ–∑—ñ. –ù–∞—Ç–∏—Å–Ω—ñ—Ç—å /start."

# –ú—ñ–∫—Ä–æ–∫–æ–º—ñ—Ç–∏
MC_YES = "‚úÖ –¢–∞–∫."
MC_NO = "‚úÖ –ù—ñ."
MC_AGREED = "‚úÖ –ú–∏ –¥–æ–º–æ–≤–∏–ª–∏—Å—è."
MC_CONFLICT = "‚ö†Ô∏è –Ñ –∫–æ–Ω—Ñ–ª—ñ–∫—Ç."

# –Ü–Ω—Å–∞–π—Ç–∏ (–û–Ω–æ–≤–ª–µ–Ω—ñ –ø—ñ–¥ –ª–æ–≥—ñ–∫—É —É—Ç–æ—á–Ω–µ–Ω—å)
MINI_CASES = {
    'conflict_children': [
        "<i>üí° <b>–Ü–Ω—Å–∞–π—Ç OPORA:</b>\n\n–°–ø—Ä–∞–≤–∏ –ø—Ä–æ –¥—ñ—Ç–µ–π ‚Äî –Ω–∞–π—Å–∫–ª–∞–¥–Ω—ñ—à—ñ –µ–º–æ—Ü—ñ–π–Ω–æ. –ê–ª–µ —é—Ä–∏–¥–∏—á–Ω–æ —Ç—É—Ç –ø—Ä–∞—Ü—é—î –º–∞—Ç–µ–º–∞—Ç–∏–∫–∞: —Ö—Ç–æ –Ω–∞–¥–∞—Å—Ç—å –∫—Ä–∞—â—ñ –¥–æ–∫–∞–∑–∏ —É–º–æ–≤ –ø—Ä–æ–∂–∏–≤–∞–Ω–Ω—è —Ç–∞ –ø—Ä–∏—Ö–∏–ª—å–Ω–æ—Å—Ç—ñ –¥–∏—Ç–∏–Ω–∏, —Ç–æ–π —ñ –≤–∏–≥—Ä–∞—î. –ú–∏ –∑–Ω–∞—î–º–æ –∞–¥–≤–æ–∫–∞—Ç—ñ–≤, —è–∫—ñ –≤–∏–≥—Ä–∞–≤–∞–ª–∏ –æ–ø—ñ–∫—É –Ω–∞–≤—ñ—Ç—å –¥–ª—è –±–∞—Ç—å–∫—ñ–≤ (—á–æ–ª–æ–≤—ñ–∫—ñ–≤), —â–æ —î —Ä—ñ–¥–∫—ñ—Å—Ç—é.</i>"
    ],
    'peace_children': [
        "<i>üí° <b>–Ü–Ω—Å–∞–π—Ç OPORA:</b>\n\n–ß—É–¥–æ–≤–æ, —â–æ –≤–∏ –¥–æ–º–æ–≤–∏–ª–∏—Å—è. –ê–ª–µ –º–∞–π—Ç–µ –Ω–∞ —É–≤–∞–∑—ñ: —Å—É–¥ –≤–∏–º–∞–≥–∞—Ç–∏–º–µ –ø–∏—Å—å–º–æ–≤–∏–π –¥–æ–≥–æ–≤—ñ—Ä –ø—Ä–æ –≤–∏—Ö–æ–≤–∞–Ω–Ω—è –¥—ñ—Ç–µ–π. –ù–æ—Ç–∞—Ä—ñ—É—Å–∏ –±–µ—Ä—É—Ç—å –∑–∞ –Ω—å–æ–≥–æ –≤—ñ–¥ 3 –¥–æ 6 —Ç–∏—Å. –≥—Ä–Ω. –ù–∞—à–µ –∑–∞–≤–¥–∞–Ω–Ω—è ‚Äî –∑–Ω–∞–π—Ç–∏ —Å–ø–æ—Å—ñ–± –º—ñ–Ω—ñ–º—ñ–∑—É–≤–∞—Ç–∏ —Ü—ñ –≤–∏—Ç—Ä–∞—Ç–∏.</i>"
    ],
    'conflict_property': [
        "<i>üí° <b>–Ü–Ω—Å–∞–π—Ç OPORA:</b>\n\n–ü—Ä–∏ –ø–æ–¥—ñ–ª—ñ –º–∞–π–Ω–∞ –≥–æ–ª–æ–≤–Ω–∞ –ø–æ–º–∏–ª–∫–∞ ‚Äî –π—Ç–∏ –≤ —Å—É–¥ –±–µ–∑ –ø–æ–ø–µ—Ä–µ–¥–Ω—å–æ–≥–æ –∞—Ä–µ—à—Ç—É –∞–∫—Ç–∏–≤—ñ–≤. –£ 40% –≤–∏–ø–∞–¥–∫—ñ–≤ —á–æ–ª–æ–≤—ñ–∫/–¥—Ä—É–∂–∏–Ω–∞ –≤—Å—Ç–∏–≥–∞—î –ø—Ä–æ–¥–∞—Ç–∏ –∞–≤—Ç–æ —á–∏ –ø–µ—Ä–µ–ø–∏—Å–∞—Ç–∏ –∫–≤–∞—Ä—Ç–∏—Ä—É –¥–æ –ø–µ—Ä—à–æ–≥–æ –∑–∞—Å—ñ–¥–∞–Ω–Ω—è. –ú–∏ –ø—ñ–¥–±–µ—Ä–µ–º–æ —é—Ä–∏—Å—Ç–∞, —è–∫–∏–π –¥—ñ—î –Ω–∞ –≤–∏–ø–µ—Ä–µ–¥–∂–µ–Ω–Ω—è.</i>"
    ],
    'peace_property': [
        "<i>üí° <b>–ó–∞—Å—Ç–µ—Ä–µ–∂–µ–Ω–Ω—è –≤—ñ–¥ OPORA:</b>\n\n–í–∏ –¥–æ–º–æ–≤–∏–ª–∏—Å—è ‚Äî —Ü–µ —á—É–¥–æ–≤–æ. –ê–ª–µ –ø–∞–º'—è—Ç–∞–π—Ç–µ: <b>—É—Å–Ω—ñ –¥–æ–º–æ–≤–ª–µ–Ω–æ—Å—Ç—ñ –Ω–µ –º–∞—é—Ç—å —é—Ä–∏–¥–∏—á–Ω–æ—ó —Å–∏–ª–∏.</b>\n\n–ß–∞—Å—Ç–æ –±—É–≤–∞—î —Ç–∞–∫: —Å—å–æ–≥–æ–¥–Ω—ñ –¥–æ–º–æ–≤–∏–ª–∏—Å—è, –∞ —á–µ—Ä–µ–∑ —Ä—ñ–∫ –µ–∫—Å-—á–æ–ª–æ–≤—ñ–∫/–¥—Ä—É–∂–∏–Ω–∞ –ø–æ–¥–∞—î –ø–æ–∑–æ–≤, –±–æ \"–ø–µ—Ä–µ–¥—É–º–∞–≤\". –¢–æ–º—É –º–∏ –Ω–∞–ø–æ–ª–µ–≥–ª–∏–≤–æ —Ä–∞–¥–∏–º–æ –∑–∞–∫—Ä—ñ–ø–∏—Ç–∏ –ø–æ–¥—ñ–ª –º–∞–π–Ω–∞ –Ω–æ—Ç–∞—Ä—ñ–∞–ª—å–Ω–æ –∞–±–æ —á–µ—Ä–µ–∑ —Å—É–¥. –¶–µ –≤–∞—à–∞ —Å—Ç—Ä–∞—Ö–æ–≤–∫–∞.</i>"
    ],
    'default': [
        "<i>üí° <b>–Ü–Ω—Å–∞–π—Ç OPORA:</b>\n\n–£ –≤–∞—à—ñ–π —Å–∏—Ç—É–∞—Ü—ñ—ó –≥–æ–ª–æ–≤–Ω–µ ‚Äî –Ω–µ —É—Å–∫–ª–∞–¥–Ω—é–≤–∞—Ç–∏. –Ñ —á—ñ—Ç–∫–∏–π –∞–ª–≥–æ—Ä–∏—Ç–º –¥—ñ–π, —è–∫–∏–π –¥–æ–∑–≤–æ–ª—è—î –æ—Ç—Ä–∏–º–∞—Ç–∏ —Ä—ñ—à–µ–Ω–Ω—è —Å—É–¥—É –∑–∞ 3-4 –º—ñ—Å—è—Ü—ñ –±–µ–∑ –≤–∞—à–æ—ó –ø—Ä–∏—Å—É—Ç–Ω–æ—Å—Ç—ñ –≤ –∑–∞—Å—ñ–¥–∞–Ω–Ω—è—Ö.</i>"
    ]
}

# –î–∏—Å–∫–ª–µ–π–º–µ—Ä
DISCLAIMER_TEXT = "\n\n‚ö†Ô∏è <i>–†–æ–∑—Ä–∞—Ö—É–Ω–æ–∫ –±–∞–∑—É—î—Ç—å—Å—è –Ω–∞ –∞–Ω–∞–ª—ñ—Ç–∏—Ü—ñ —Ä–∏–Ω–∫—É 2025. –í—Ä–∞—Ö–æ–≤–∞–Ω–æ —Å—É–¥–æ–≤–∏–π –∑–±—ñ—Ä (1211 –≥—Ä–Ω) —Ç–∞ —Ä–µ–∞–ª—å–Ω–µ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è —Å—É–¥—ñ–≤.</i>"

# –†–µ–∑—É–ª—å—Ç–∞—Ç–∏ (–ü–æ–≥–ª–∏–±–ª–µ–Ω—ñ —Ç–∞ –†–æ–∑—à–∏—Ä–µ–Ω—ñ)
SEGMENT_MESSAGES = {
    # –ê1/–ê2 (–ü—Ä–æ—Å—Ç—ñ)
    'A1': """‚ö°Ô∏è <b>–°—Ü–µ–Ω–∞—Ä—ñ–π: –ï–∫—Å–ø—Ä–µ—Å (–ë–µ–∑ –¥—ñ—Ç–µ–π —Ç–∞ –º–∞–π–Ω–∞)</b>

–¶–µ –Ω–∞–π–ª–µ–≥—à–∏–π —Å—Ü–µ–Ω–∞—Ä—ñ–π –¥–ª—è —é—Ä–∏—Å—Ç–∞, –∞–ª–µ –Ω–∞–≤—ñ—Ç—å —Ç—É—Ç —î —Ä–∏–∑–∏–∫–∏.

üí∞ <b>–ë—é–¥–∂–µ—Ç:</b> 5 500 ‚Äî 7 500 –≥—Ä–Ω
‚è± <b>–°—Ç—Ä–æ–∫–∏:</b> 2-3 –º—ñ—Å—è—Ü—ñ

<b>üí° –ê–Ω–∞–ª—ñ—Ç–∏–∫–∞ OPORA:</b>
–ù–∞ —Ä–∏–Ω–∫—É —î –ø—Ä–æ–ø–æ–∑–∏—Ü—ñ—ó –∑–∞ 4000 –≥—Ä–Ω ("–æ–Ω–ª–∞–π–Ω"), –∞–ª–µ —á–∞—Å—Ç–æ —Ü–µ –ª–∏—à–µ –≥–µ–Ω–µ—Ä–∞—Ü—ñ—è –¥–æ–∫—É–º–µ–Ω—Ç—ñ–≤ –±–µ–∑ –ø–æ–¥–∞–Ω–Ω—è –≤ —Å—É–¥. –í—Ä–∞—Ö–æ–≤—É—é—á–∏, —â–æ —Å—É–¥–æ–≤–∏–π –∑–±—ñ—Ä –∑—Ä—ñ—Å –¥–æ 1211 –≥—Ä–Ω, —è–∫—ñ—Å–Ω–∞ –ø–æ—Å–ª—É–≥–∞ "–ø—ñ–¥ –∫–ª—é—á" (–¥–µ –∞–¥–≤–æ–∫–∞—Ç —Ö–æ–¥–∏—Ç—å –≤ —Å—É–¥ –∑–∞–º—ñ—Å—Ç—å –≤–∞—Å) –∫–æ—à—Ç—É—î –¥–æ—Ä–æ–∂—á–µ.

<b>–©–æ –≤—Ö–æ–¥–∏—Ç—å —É —Ü–µ–π –±—é–¥–∂–µ—Ç:</b>
‚Ä¢ –°–ø–ª–∞—Ç–∞ —Å—É–¥–æ–≤–æ–≥–æ –∑–±–æ—Ä—É —Ç–∞ —Ñ–æ—Ä–º—É–≤–∞–Ω–Ω—è –∫–≤–∏—Ç–∞–Ω—Ü—ñ–π.
‚Ä¢ –ö–æ–Ω—Ç—Ä–æ–ª—å –∫–∞–Ω—Ü–µ–ª—è—Ä—ñ—ó —Å—É–¥—É (—â–æ–± —Å–ø—Ä–∞–≤—É –Ω–µ "–∑–∞–≥—É–±–∏–ª–∏").
‚Ä¢ –û—Ç—Ä–∏–º–∞–Ω–Ω—è —Ä—ñ—à–µ–Ω–Ω—è —Å—É–¥—É –∑ –≤—ñ–¥–º—ñ—Ç–∫–æ—é –ø—Ä–æ –Ω–∞–±—Ä–∞–Ω–Ω—è —Å–∏–ª–∏.""" + DISCLAIMER_TEXT,

    'A2': """‚úÖ <b>–°—Ü–µ–Ω–∞—Ä—ñ–π: –°—Ç–∞–Ω–¥–∞—Ä—Ç (–ë–µ–∑ –¥—ñ—Ç–µ–π —Ç–∞ –º–∞–π–Ω–∞)</b>

–ö–ª–∞—Å–∏—á–Ω–µ —Ä–æ–∑–ª—É—á–µ–Ω–Ω—è. –ì–æ–ª–æ–≤–Ω–µ –∑–∞–≤–¥–∞–Ω–Ω—è ‚Äî –º—ñ–Ω—ñ–º—ñ–∑—É–≤–∞—Ç–∏ –≤–∞—à—É —É—á–∞—Å—Ç—å.

üí∞ <b>–ë—é–¥–∂–µ—Ç:</b> 4 500 ‚Äî 6 500 –≥—Ä–Ω
‚è± <b>–°—Ç—Ä–æ–∫–∏:</b> 3-5 –º—ñ—Å—è—Ü—ñ–≤

<b>üí° –ê–Ω–∞–ª—ñ—Ç–∏–∫–∞ OPORA:</b>
–†–µ–∞–ª—å–Ω–∏–π —Å—Ç—Ä–æ–∫ —Ä–æ–∑–≥–ª—è–¥—É –∑–∞—Ä–∞–∑ ‚Äî –Ω–µ 2 –º—ñ—Å—è—Ü—ñ (—è–∫ –≤ –∑–∞–∫–æ–Ω—ñ), –∞ 3-5 –º—ñ—Å—è—Ü—ñ–≤ —á–µ—Ä–µ–∑ –ø–æ–≤—ñ—Ç—Ä—è–Ω—ñ —Ç—Ä–∏–≤–æ–≥–∏ —Ç–∞ –≤—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è —Å–≤—ñ—Ç–ª–∞ –≤ —Å—É–¥–∞—Ö.
–í–∞–º –ø–æ—Ç—Ä—ñ–±–µ–Ω –∞–¥–≤–æ–∫–∞—Ç, —è–∫–∏–π –ø—Ä–∞—Ü—é—î —á–µ—Ä–µ–∑ —Å–∏—Å—Ç–µ–º—É "–ï–ª–µ–∫—Ç—Ä–æ–Ω–Ω–∏–π —Å—É–¥" ‚Äî —Ü–µ –ø—Ä–∏—à–≤–∏–¥—à—É—î –ø—Ä–æ—Ü–µ–¥—É—Ä—É –Ω–∞ 3-4 —Ç–∏–∂–Ω—ñ –ø–æ—Ä—ñ–≤–Ω—è–Ω–æ –∑ –£–∫—Ä–ø–æ—à—Ç–æ—é.

<b>–ö—Ä–∏—Ç–µ—Ä—ñ—ó –≤–∏–±–æ—Ä—É —Å–ø–µ—Ü—ñ–∞–ª—ñ—Å—Ç–∞:</b>
‚Ä¢ –§—ñ–∫—Å–æ–≤–∞–Ω–∞ —Ü—ñ–Ω–∞ (–±–µ–∑ –¥–æ–ø–ª–∞—Ç –∑–∞ "–∫–æ–∂–Ω–µ –∑–∞—Å—ñ–¥–∞–Ω–Ω—è").
‚Ä¢ –†–æ–±–æ—Ç–∞ –±–µ–∑ –≤–∞—à–æ—ó —Ñ—ñ–∑–∏—á–Ω–æ—ó –ø—Ä–∏—Å—É—Ç–Ω–æ—Å—Ç—ñ.""" + DISCLAIMER_TEXT,
    
    # B1 (–î—ñ—Ç–∏ + –ö–æ–Ω—Ñ–ª—ñ–∫—Ç)
    'B1': """üõ° <b>–°—Ü–µ–Ω–∞—Ä—ñ–π: –°—É–¥–æ–≤–∏–π —Å–ø—ñ—Ä –∑–∞ –¥—ñ—Ç–µ–π</b>

–¶–µ –∑–æ–Ω–∞ –Ω–∞–π–≤–∏—â–æ–≥–æ —Ä–∏–∑–∏–∫—É. –®–∞–±–ª–æ–Ω–Ω—ñ –ø–æ–∑–æ–≤–∏ —Ç—É—Ç –Ω–µ –ø—Ä–∞—Ü—é—é—Ç—å.

üí∞ <b>–ë—é–¥–∂–µ—Ç:</b> 14 000 ‚Äî 22 000 –≥—Ä–Ω
‚è± <b>–°—Ç—Ä–æ–∫–∏:</b> 5-8 –º—ñ—Å—è—Ü—ñ–≤

<b>üí° –ê–Ω–∞–ª—ñ—Ç–∏–∫–∞ OPORA:</b>
–í–∞–º –ø–æ—Ç—Ä—ñ–±–µ–Ω –∞–¥–≤–æ–∫–∞—Ç, —è–∫–∏–π –æ–¥—Ä–∞–∑—É –ø–æ–¥–∞—Å—Ç—å –∫–ª–æ–ø–æ—Ç–∞–Ω–Ω—è –ø—Ä–æ "–ó–∞–±–µ–∑–ø–µ—á–µ–Ω–Ω—è –ø–æ–∑–æ–≤—É" (–≤—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—è –≥—Ä–∞—Ñ—ñ–∫—É –∑—É—Å—Ç—Ä—ñ—á–µ–π –Ω–∞ —á–∞—Å —Å—É–¥—É). –Ü–Ω–∞–∫—à–µ –≤–∏ –º–æ–∂–µ—Ç–µ —á–µ–∫–∞—Ç–∏ —Ä—ñ—à–µ–Ω–Ω—è 8 –º—ñ—Å—è—Ü—ñ–≤, –Ω–µ –±–∞—á–∞—á–∏ –¥–∏—Ç–∏–Ω–∏.

<b>–ù–∞ —â–æ –ø—ñ–¥–µ –±—é–¥–∂–µ—Ç:</b>
‚Ä¢ –†–æ–±–æ—Ç–∞ –∑ –æ—Ä–≥–∞–Ω–æ–º –æ–ø—ñ–∫–∏ (–æ—Ç—Ä–∏–º–∞–Ω–Ω—è –≤–∏—Å–Ω–æ–≤–∫—É).
‚Ä¢ –£—á–∞—Å—Ç—å —É 3-5 —Å—É–¥–æ–≤–∏—Ö –∑–∞—Å—ñ–¥–∞–Ω–Ω—è—Ö.
‚Ä¢ –°—Ç—Ä–∞—Ç–µ–≥—ñ—è –ø–æ –∞–ª—ñ–º–µ–Ω—Ç–∞—Ö (–¥–æ–≤–µ–¥–µ–Ω–Ω—è –ø—Ä–∏—Ö–æ–≤–∞–Ω–∏—Ö –¥–æ—Ö–æ–¥—ñ–≤).""" + DISCLAIMER_TEXT,
    
    # B2 (–î—ñ—Ç–∏ + –ó–≥–æ–¥–∞)
    'B2': """üë®‚Äçüë©‚Äçüëß <b>–°—Ü–µ–Ω–∞—Ä—ñ–π: –ú–∏—Ä–Ω–µ —Ä–æ–∑–ª—É—á–µ–Ω–Ω—è –∑ –¥—ñ—Ç—å–º–∏</b>

–í–∏ –º–æ–ª–æ–¥—Ü—ñ, —â–æ –¥–æ–º–æ–≤–∏–ª–∏—Å—è. –ê–ª–µ —î —é—Ä–∏–¥–∏—á–Ω–∏–π –Ω—é–∞–Ω—Å.

üí∞ <b>–ë—é–¥–∂–µ—Ç:</b> 8 000 ‚Äî 12 000 –≥—Ä–Ω
‚è± <b>–°—Ç—Ä–æ–∫–∏:</b> 3-4 –º—ñ—Å—è—Ü—ñ

<b>üí° –ê–Ω–∞–ª—ñ—Ç–∏–∫–∞ OPORA:</b>
–ó–≥—ñ–¥–Ω–æ –∑—ñ —Å—Ç. 109 –°—ñ–º–µ–π–Ω–æ–≥–æ –ö–æ–¥–µ–∫—Å—É, –¥–ª—è "—à–≤–∏–¥–∫–æ–≥–æ" —Å—É–¥—É –æ–±–æ–≤'—è–∑–∫–æ–≤–æ –ø–æ—Ç—Ä—ñ–±–µ–Ω <b>–Ω–æ—Ç–∞—Ä—ñ–∞–ª—å–Ω–∏–π –¥–æ–≥–æ–≤—ñ—Ä</b> –ø—Ä–æ –≤–∏—Ö–æ–≤–∞–Ω–Ω—è –¥—ñ—Ç–µ–π.
–ü–æ—Å–ª—É–≥–∏ –Ω–æ—Ç–∞—Ä—ñ—É—Å–∞ —É 2025 —Ä–æ—Ü—ñ –∫–æ—à—Ç—É—é—Ç—å 3000-6000 –≥—Ä–Ω. –¶–µ —á–∞—Å—Ç–æ —Å—Ç–∞—î —Å—é—Ä–ø—Ä–∏–∑–æ–º –¥–ª—è –∫–ª—ñ—î–Ω—Ç—ñ–≤.
–ú–∏ –¥–æ–ø–æ–º–æ–∂–µ–º–æ –∑–Ω–∞–π—Ç–∏ –≤–∞—Ä—ñ–∞–Ω—Ç, –¥–µ —é—Ä–∏–¥–∏—á–Ω–∏–π —Å—É–ø—Ä–æ–≤—ñ–¥ + –Ω–æ—Ç–∞—Ä—ñ—É—Å –≤–ø–∏—à—É—Ç—å—Å—è –≤ –∞–¥–µ–∫–≤–∞—Ç–Ω–∏–π –±—é–¥–∂–µ—Ç.

<b>–ü–µ—Ä–µ–≤–∞–≥–∞:</b>
‚Ä¢ –ì–∞—Ä–∞–Ω—Ç–æ–≤–∞–Ω—ñ –∞–ª—ñ–º–µ–Ω—Ç–∏.
‚Ä¢ –í–∏ –Ω–µ —Ö–æ–¥–∏—Ç–µ –≤ —Å—É–¥.""" + DISCLAIMER_TEXT,
    
    # C1 (–ú–∞–π–Ω–æ + –ö–æ–Ω—Ñ–ª—ñ–∫—Ç)
    'C1': """üíº <b>–°—Ü–µ–Ω–∞—Ä—ñ–π: –°–∫–ª–∞–¥–Ω–∏–π –ø–æ–¥—ñ–ª –º–∞–π–Ω–∞</b>

–ù–∞–π–¥–æ—Ä–æ–∂—á–∞ –∫–∞—Ç–µ–≥–æ—Ä—ñ—è —Å–ø—Ä–∞–≤. –¢—É—Ç –ø–æ–º–∏–ª–∫–∞ –∫–æ—à—Ç—É—î —Ç–∏—Å—è—á—ñ –¥–æ–ª–∞—Ä—ñ–≤.

üí∞ <b>–ë—é–¥–∂–µ—Ç:</b> 25 000 ‚Äî 50 000+ –≥—Ä–Ω
‚è± <b>–°—Ç—Ä–æ–∫–∏:</b> 8-16 –º—ñ—Å—è—Ü—ñ–≤

<b>üí° –ê–Ω–∞–ª—ñ—Ç–∏–∫–∞ OPORA (–Ü–Ω—Å–∞–π–¥):</b>
–°—É–¥–æ–≤–∏–π –∑–±—ñ—Ä –∑–∞ –ø–æ–¥—ñ–ª –º–∞–π–Ω–∞ –º–æ–∂–µ —Å—è–≥–∞—Ç–∏ 15 140 –≥—Ä–Ω.
–ê–õ–ï! –Ø–∫—â–æ –ø–æ–¥–∞—Ç–∏ –≤–∏–º–æ–≥—É –ø—Ä–æ –ø–æ–¥—ñ–ª <b>—Ä–∞–∑–æ–º</b> —ñ–∑ —Ä–æ–∑–ª—É—á–µ–Ω–Ω—è–º, "—Å—Ç–µ–ª—è" –∑–±–æ—Ä—É –∑–Ω–∏–∂—É—î—Ç—å—Å—è –¥–æ 9 084 –≥—Ä–Ω. –¢—ñ–ª—å–∫–∏ —Ü–µ–π –Ω—é–∞–Ω—Å –µ–∫–æ–Ω–æ–º–∏—Ç—å –≤–∞–º 6000 –≥—Ä–Ω. –ë—ñ–ª—å—à—ñ—Å—Ç—å –∞–¥–≤–æ–∫–∞—Ç—ñ–≤ –ø—Ä–æ —Ü–µ –º–æ–≤—á–∞—Ç—å.

<b>–°—Ç—Ä–∞—Ç–µ–≥—ñ—è –∑–∞—Ö–∏—Å—Ç—É:</b>
‚Ä¢ –ù–µ–≥–∞–π–Ω–∏–π –∞—Ä–µ—à—Ç –∞–∫—Ç–∏–≤—ñ–≤ (–¥–æ –ø–µ—Ä—à–æ–≥–æ –∑–∞—Å—ñ–¥–∞–Ω–Ω—è).
‚Ä¢ –ü–æ—à—É–∫ –ø—Ä–∏—Ö–æ–≤–∞–Ω–æ–≥–æ –º–∞–π–Ω–∞.
‚Ä¢ –ë–æ—Ä–æ—Ç—å–±–∞ –∑–∞ –∑–±—ñ–ª—å—à–µ–Ω–Ω—è —á–∞—Å—Ç–∫–∏.""" + DISCLAIMER_TEXT,
    
    # C2_PEACE (–ú–∞–π–Ω–æ + –ó–≥–æ–¥–∞)
    'C2_PEACE': """ü§ù <b>–°—Ü–µ–Ω–∞—Ä—ñ–π: –Æ—Ä–∏–¥–∏—á–Ω–µ –æ—Ñ–æ—Ä–º–ª–µ–Ω–Ω—è –ø–æ–¥—ñ–ª—É –º–∞–π–Ω–∞</b>

–í–∏ –¥–æ–º–æ–≤–∏–ª–∏—Å—è ‚Äî —Ü–µ —Å—É–ø–µ—Ä. –ó–∞–ª–∏—à–∏–ª–æ—Å—è –æ–±—Ä–∞—Ç–∏ –Ω–∞–π–¥–µ—à–µ–≤—à–∏–π —à–ª—è—Ö –æ—Ñ–æ—Ä–º–ª–µ–Ω–Ω—è.

üí∞ <b>–ë—é–¥–∂–µ—Ç:</b> 10 000 ‚Äî 16 000 –≥—Ä–Ω
‚è± <b>–°—Ç—Ä–æ–∫–∏:</b> 3-5 –º—ñ—Å—è—Ü—ñ–≤

<b>üí° –ê–Ω–∞–ª—ñ—Ç–∏–∫–∞ OPORA:</b>
–Ñ –¥–≤–∞ —à–ª—è—Ö–∏: –ù–æ—Ç–∞—Ä—ñ—É—Å –∞–±–æ –°—É–¥.
–ù–æ—Ç–∞—Ä—ñ—É—Å ‚Äî —Ü–µ —à–≤–∏–¥–∫–æ, –∞–ª–µ –¥–æ—Ä–æ–≥–æ (1% –¥–µ—Ä–∂–º–∏—Ç–∞ + 1% –ø–µ–Ω—Å—ñ–π–Ω–æ–≥–æ —Ñ–æ–Ω–¥—É + –ø–æ—Å–ª—É–≥–∏). –î–ª—è –∫–≤–∞—Ä—Ç–∏—Ä–∏ –∑–∞ $50k —Ü–µ ~$1500 –≤–∏—Ç—Ä–∞—Ç –æ–¥—Ä–∞–∑—É.
"–ú–∏—Ä–Ω–∏–π —Å—É–¥" —á–∞—Å—Ç–æ –≤–∏—Ö–æ–¥–∏—Ç—å –¥–µ—à–µ–≤—à–∏–º (—Ñ—ñ–∫—Å–æ–≤–∞–Ω–∏–π —Å—É–¥–æ–≤–∏–π –∑–±—ñ—Ä), —Ö–æ—á —ñ –¥–æ–≤—à–∏–º. –ú–∏ –ø—Ä–æ—Ä–∞—Ö—É—î–º–æ, —â–æ –≤–∏–≥—ñ–¥–Ω—ñ—à–µ —Å–∞–º–µ –≤–∞–º.""" + DISCLAIMER_TEXT,
    
    # C3_WAR (–ú–∞–π–Ω–æ + –ö–æ–Ω—Ñ–ª—ñ–∫—Ç, –±–µ–∑ –¥—ñ—Ç–µ–π)
    'C3_WAR': """üí∞ <b>–°—Ü–µ–Ω–∞—Ä—ñ–π: –°—É–¥–æ–≤–∏–π –ø–æ–¥—ñ–ª –º–∞–π–Ω–∞</b>

–ß–∏—Å—Ç–∞ –º–∞—Ç–µ–º–∞—Ç–∏–∫–∞ —Ç–∞ –±–æ—Ä–æ—Ç—å–±–∞ –∑–∞ –∞–∫—Ç–∏–≤–∏.

üí∞ <b>–ë—é–¥–∂–µ—Ç:</b> 18 000 ‚Äî 30 000 –≥—Ä–Ω
‚è± <b>–°—Ç—Ä–æ–∫–∏:</b> 6-10 –º—ñ—Å—è—Ü—ñ–≤

<b>üí° –í–∞–∂–ª–∏–≤–æ:</b>
–°—É–¥–∏ –∑–∞—Ä–∞–∑ –∞–∫—Ç–∏–≤–Ω–æ –¥—ñ–ª—è—Ç—å –Ω–µ —Ç—ñ–ª—å–∫–∏ –º–∞–π–Ω–æ, –∞ –π <b>–±–æ—Ä–≥–∏</b>. –Ø–∫—â–æ –≤–∞—à –ø–∞—Ä—Ç–Ω–µ—Ä –≤—ñ–∑—å–º–µ –∫—Ä–µ–¥–∏—Ç –¥–æ —Ä–æ–∑–ª—É—á–µ–Ω–Ω—è, –ø–æ–ª–æ–≤–∏–Ω—É –º–æ–∂—É—Ç—å –ø–æ–≤—ñ—Å–∏—Ç–∏ –Ω–∞ –≤–∞—Å.
–ü–æ—Ç—Ä—ñ–±–Ω–æ —Ç–µ—Ä–º—ñ–Ω–æ–≤–æ —Ñ—ñ–∫—Å—É–≤–∞—Ç–∏ –¥–∞—Ç—É –ø—Ä–∏–ø–∏–Ω–µ–Ω–Ω—è —à–ª—é–±–Ω–∏—Ö –≤—ñ–¥–Ω–æ—Å–∏–Ω —á–µ—Ä–µ–∑ —Å—É–¥.""" + DISCLAIMER_TEXT,

    # D (–ó–∞ –∫–æ—Ä–¥–æ–Ω–æ–º)
    'D1': """üåç <b>–°—Ü–µ–Ω–∞—Ä—ñ–π: –ú—ñ–∂–Ω–∞—Ä–æ–¥–Ω–∏–π VIP</b>

–ü–æ–≤–Ω–∏–π —Å—É–ø—Ä–æ–≤—ñ–¥ –±–µ–∑ –≤–∞—à–æ–≥–æ –ø—Ä–∏—ó–∑–¥—É –≤ –£–∫—Ä–∞—ó–Ω—É.

üí∞ <b>–ë—é–¥–∂–µ—Ç:</b> 18 000 ‚Äî 26 000 –≥—Ä–Ω
‚è± <b>–°—Ç—Ä–æ–∫–∏:</b> 4-5 –º—ñ—Å—è—Ü—ñ–≤

<b>üí° –ê–Ω–∞–ª—ñ—Ç–∏–∫–∞ OPORA:</b>
–ö—Ä–∏—Ç–∏—á–Ω–æ –≤–∞–∂–ª–∏–≤–æ –æ–±—Ä–∞—Ç–∏ "Digital-–∞–¥–≤–æ–∫–∞—Ç–∞". –ó–≤–∏—á–∞–π–Ω–∏–π —é—Ä–∏—Å—Ç –∑–º—É—Å–∏—Ç—å –≤–∞—Å –ø–µ—Ä–µ—Å–∏–ª–∞—Ç–∏ –ø–∞–ø–µ—Ä–æ–≤—ñ –æ—Ä–∏–≥—ñ–Ω–∞–ª–∏ –ø–æ—à—Ç–æ—é (—Ü–µ –¥–æ–≤–≥–æ —ñ –¥–æ—Ä–æ–≥–æ). –ü—Ä–æ—Ñ—ñ–ª—å–Ω–∏–π —Å–ø–µ—Ü—ñ–∞–ª—ñ—Å—Ç –∑—Ä–æ–±–∏—Ç—å –≤—Å–µ —á–µ—Ä–µ–∑ –ï–ª–µ–∫—Ç—Ä–æ–Ω–Ω–∏–π –°—É–¥ —ñ –≤—ñ–¥–µ–æ–∫–æ–Ω—Ñ–µ—Ä–µ–Ω—Ü—ñ—é, –∑–∞–æ—â–∞–¥–∏–≤—à–∏ –≤–∞–º $200-300 –Ω–∞ –ª–æ–≥—ñ—Å—Ç–∏—Ü—ñ.""" + DISCLAIMER_TEXT,

    'D2': """üåç <b>–°—Ü–µ–Ω–∞—Ä—ñ–π: –ú—ñ–∂–Ω–∞—Ä–æ–¥–Ω–∏–π –°—Ç–∞–Ω–¥–∞—Ä—Ç</b>

–î–∏—Å—Ç–∞–Ω—Ü—ñ–π–Ω–µ —Ä–æ–∑–ª—É—á–µ–Ω–Ω—è –¥–ª—è —Ç–∏—Ö, —Ö—Ç–æ –∑–∞ –∫–æ—Ä–¥–æ–Ω–æ–º.

üí∞ <b>–ë—é–¥–∂–µ—Ç:</b> 14 000 ‚Äî 20 000 –≥—Ä–Ω
‚è± <b>–°—Ç—Ä–æ–∫–∏:</b> 4-6 –º—ñ—Å—è—Ü—ñ–≤

<b>üí° –ì–æ–ª–æ–≤–Ω–∞ –ø—Ä–æ–±–ª–µ–º–∞:</b>
–ù–∞–ª–µ–∂–Ω–µ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è –≤—ñ–¥–ø–æ–≤—ñ–¥–∞—á–∞. –Ø–∫—â–æ –≤—ñ–Ω —Ç–µ–∂ –∑–∞ –∫–æ—Ä–¥–æ–Ω–æ–º, —Å—É–¥ –º–æ–∂–µ –≤—ñ–¥–∫–ª–∞–¥–∞—Ç–∏ —Å–ø—Ä–∞–≤—É –º—ñ—Å—è—Ü—è–º–∏.
–ú–∏ –ø—ñ–¥–±–µ—Ä–µ–º–æ —Å–ø–µ—Ü—ñ–∞–ª—ñ—Å—Ç–∞, —è–∫–∏–π –∑–Ω–∞—î, —è–∫ –ø—Ä–∞–≤–∏–ª—å–Ω–æ –æ—Ñ–æ—Ä–º–∏—Ç–∏ –≤–∏–∫–ª–∏–∫ —á–µ—Ä–µ–∑ —Å–∞–π—Ç —Å—É–¥—É, —â–æ–± –æ—Ç—Ä–∏–º–∞—Ç–∏ –∑–∞–æ—á–Ω–µ —Ä—ñ—à–µ–Ω–Ω—è –±–µ–∑ –∑–∞—Ç—Ä–∏–º–æ–∫.""" + DISCLAIMER_TEXT,
    
    # E (–†–æ–∑—à—É–∫)
    'E1': """üîç <b>–°—Ü–µ–Ω–∞—Ä—ñ–π: –ë–µ–∑ –≤—ñ–¥–æ–º–æ—ó –∞–¥—Ä–µ—Å–∏</b>

–ü—Ä–æ—Ü–µ–¥—É—Ä–Ω–∞ —Å–∫–ª–∞–¥–Ω—ñ—Å—Ç—å.

üí∞ <b>–ë—é–¥–∂–µ—Ç:</b> 12 000 ‚Äî 16 000 –≥—Ä–Ω
‚è± <b>–°—Ç—Ä–æ–∫–∏:</b> 5-7 –º—ñ—Å—è—Ü—ñ–≤

<b>üí° –†—ñ—à–µ–Ω–Ω—è:</b>
–°—É–¥–∏ –∑–∞—Ä–∞–∑ –ø–µ—Ä–µ–≤–∞–Ω—Ç–∞–∂–µ–Ω—ñ. –°–ø—Ä–∞–≤–∏ "–±–µ–∑ –∞–¥—Ä–µ—Å–∏" —á–∞—Å—Ç–æ –∑–∞–ª–∏—à–∞—é—Ç—å –±–µ–∑ —Ä—É—Ö—É.
–í–∞–º –ø–æ—Ç—Ä—ñ–±–µ–Ω —é—Ä–∏—Å—Ç, —è–∫–∏–π –æ–¥—Ä–∞–∑—É –ø–æ–¥–∞—Å—Ç—å –∫–ª–æ–ø–æ—Ç–∞–Ω–Ω—è –ø—Ä–æ –≤–∏–∫–ª–∏–∫ —á–µ—Ä–µ–∑ –æ–≥–æ–ª–æ—à–µ–Ω–Ω—è –Ω–∞ —Å–∞–π—Ç—ñ —Å—É–¥–æ–≤–æ—ó –≤–ª–∞–¥–∏. –¶–µ —î–¥–∏–Ω–∏–π –ª–µ–≥–∞–ª—å–Ω–∏–π —Å–ø–æ—Å—ñ–± –æ—Ç—Ä–∏–º–∞—Ç–∏ —Ä–æ–∑–ª—É—á–µ–Ω–Ω—è –±–µ–∑ –∑–≥–æ–¥–∏ –¥—Ä—É–≥–æ—ó —Å—Ç–æ—Ä–æ–Ω–∏.""" + DISCLAIMER_TEXT,

    'E2': """üîç <b>–°—Ü–µ–Ω–∞—Ä—ñ–π: –†–æ–∑—à—É–∫ / –°–∞–±–æ—Ç–∞–∂</b>

–í—ñ–¥–ø–æ–≤—ñ–¥–∞—á —Ö–æ–≤–∞—î—Ç—å—Å—è –∞–±–æ —ñ–≥–Ω–æ—Ä—É—î —Å—É–¥.

üí∞ <b>–ë—é–¥–∂–µ—Ç:</b> 16 000 ‚Äî 24 000 –≥—Ä–Ω
‚è± <b>–°—Ç—Ä–æ–∫–∏:</b> 6-9 –º—ñ—Å—è—Ü—ñ–≤

<b>üí° –¢–∞–∫—Ç–∏–∫–∞:</b>
–û—Ç—Ä–∏–º–∞–Ω–Ω—è –∑–∞–æ—á–Ω–æ–≥–æ —Ä—ñ—à–µ–Ω–Ω—è —Å—É–¥—É. –ê–¥–≤–æ–∫–∞—Ç –º–∞—î –∫–æ–Ω—Ç—Ä–æ–ª—é–≤–∞—Ç–∏ –∫–æ–∂–Ω–µ –∑–∞—Å—ñ–¥–∞–Ω–Ω—è, —â–æ–± —Å—É–¥–¥—è –Ω–µ –≤—ñ–¥–∫–ª–∞–¥–∞–≤ —Å–ø—Ä–∞–≤—É "–Ω–∞ –ø–æ—Ç—ñ–º" —á–µ—Ä–µ–∑ –Ω–µ—è–≤–∫—É –≤—ñ–¥–ø–æ–≤—ñ–¥–∞—á–∞.""" + DISCLAIMER_TEXT
}

def get_consultation_booked_text(first_name, phone):
    return f"""
‚úÖ <b>–ó–∞–º–æ–≤–ª–µ–Ω–Ω—è –ø—Ä–∏–π–Ω—è—Ç–æ, {first_name}!</b>

–ú–∏ –∑–∞—Ñ—ñ–∫—Å—É–≤–∞–ª–∏ –∑–∞ –≤–∞–º–∏ –∞–∫—Ü—ñ–π–Ω—É —Ü—ñ–Ω—É ‚Äî <b>199 –≥—Ä–Ω</b>.

–ü—Ä–æ—Ç—è–≥–æ–º 15-30 —Ö–≤–∏–ª–∏–Ω (—É —Ä–æ–±–æ—á–∏–π —á–∞—Å) –Ω–∞—à –º–µ–Ω–µ–¥–∂–µ—Ä –∑–≤'—è–∂–µ—Ç—å—Å—è –∑ –≤–∞–º–∏ —É Telegram –∞–±–æ –ø–æ —Ç–µ–ª–µ—Ñ–æ–Ω—É, —â–æ–±:
1. –ù–∞–¥–∞—Ç–∏ —Ä–µ–∫–≤—ñ–∑–∏—Ç–∏ –¥–ª—è –æ–ø–ª–∞—Ç–∏.
2. –£—Ç–æ—á–Ω–∏—Ç–∏ –¥–µ—Ç–∞–ª—ñ –¥–ª—è —Å—Ç–∞—Ä—Ç—É —Ä–æ–±–æ—Ç–∏.

<i>–î—è–∫—É—î–º–æ –∑–∞ –¥–æ–≤—ñ—Ä—É –¥–æ —Å–µ—Ä–≤—ñ—Å—É OPORA!</i> üõ°
"""

# =====================================================
# 4. –õ–û–ì–Ü–ö–ê –°–ï–ì–ú–ï–ù–¢–ê–¶–Ü–á (–ù–û–í–ê)
# =====================================================

def determine_segment(user_data):
    """
    –†–æ–∑—É–º–Ω–∞ —Å–µ–≥–º–µ–Ω—Ç–∞—Ü—ñ—è (–í—Ä–∞—Ö–æ–≤—É—î –∫–æ–Ω—Ñ–ª—ñ–∫—Ç–∏)
    """
    has_children = user_data.get('has_children') == 'yes'
    conflict_children = user_data.get('conflict_children') == 'yes'
    property_dispute = user_data.get('property_dispute') == 'yes'
    conflict_property = user_data.get('conflict_property') == 'yes'
    spouse_location = user_data.get('spouse_location')
    urgency = user_data.get('urgency')
    spouse_consent = user_data.get('spouse_consent')

    # 1. –ó–∞ –∫–æ—Ä–¥–æ–Ω–æ–º
    if spouse_location == 'abroad':
        return ('D1', 'üåç –ú—ñ–∂–Ω–∞—Ä–æ–¥–Ω–µ —Ä–æ–∑–ª—É—á–µ–Ω–Ω—è (VIP)', '18 000 ‚Äî 26 000 –≥—Ä–Ω', '4-5 –º—ñ—Å—è—Ü—ñ–≤') if urgency == 'high' else ('D2', 'üåç –ú—ñ–∂–Ω–∞—Ä–æ–¥–Ω–µ —Ä–æ–∑–ª—É—á–µ–Ω–Ω—è (–°—Ç–∞–Ω–¥–∞—Ä—Ç)', '14 000 ‚Äî 20 000 –≥—Ä–Ω', '4-6 –º—ñ—Å—è—Ü—ñ–≤')
    
    # 2. –ù–µ–≤—ñ–¥–æ–º–µ –º—ñ—Å—Ü–µ
    if spouse_location == 'unknown':
        return ('E2', 'üîç –†–æ–∑–ª—É—á–µ–Ω–Ω—è –∑ —Ä–æ–∑—à—É–∫–æ–º', '16 000 ‚Äî 24 000 –≥—Ä–Ω', '6-9 –º—ñ—Å—è—Ü—ñ–≤') if spouse_consent == 'no' else ('E1', 'üîç –†–æ–∑–ª—É—á–µ–Ω–Ω—è –±–µ–∑ –∞–¥—Ä–µ—Å–∏', '12 000 ‚Äî 16 000 –≥—Ä–Ω', '5-7 –º—ñ—Å—è—Ü—ñ–≤')

    # 3. –ú–ê–ô–ù–û
    if property_dispute:
        if conflict_property:
            # –Ñ –∫–æ–Ω—Ñ–ª—ñ–∫—Ç –ø–æ –º–∞–π–Ω—É -> –î–æ—Ä–æ–≥–æ
            if has_children:
                return ('C1', 'üíº –ö–æ–º–ø–ª–µ–∫—Å–Ω–∏–π –º–∞–π–Ω–æ–≤–∏–π —Å–ø—ñ—Ä', '25 000 ‚Äî 50 000+ –≥—Ä–Ω', '8-16 –º—ñ—Å—è—Ü—ñ–≤')
            else:
                return ('C3_WAR', 'üí∞ –°—É–¥–æ–≤–∏–π –ø–æ–¥—ñ–ª –º–∞–π–Ω–∞', '18 000 ‚Äî 30 000 –≥—Ä–Ω', '6-10 –º—ñ—Å—è—Ü—ñ–≤')
        else:
            # –ú–∞–π–Ω–æ —î, –∞–ª–µ –∫–æ–Ω—Ñ–ª—ñ–∫—Ç—É –Ω–µ–º–∞—î -> –î–µ—à–µ–≤—à–µ (–û—Ñ–æ—Ä–º–ª–µ–Ω–Ω—è)
            return ('C2_PEACE', 'ü§ù –û—Ñ–æ—Ä–º–ª–µ–Ω–Ω—è –ø–æ–¥—ñ–ª—É –º–∞–π–Ω–∞', '10 000 ‚Äî 16 000 –≥—Ä–Ω', '3-5 –º—ñ—Å—è—Ü—ñ–≤')

    # 4. –î–Ü–¢–ò
    if has_children:
        if conflict_children:
            return ('B1', 'üõ° –°—É–¥–æ–≤–∏–π —Å–ø—ñ—Ä –∑–∞ –¥—ñ—Ç–µ–π', '14 000 ‚Äî 22 000 –≥—Ä–Ω', '5-8 –º—ñ—Å—è—Ü—ñ–≤')
        else:
            return ('B2', 'üë®‚Äçüë©‚Äçüëß –ú–∏—Ä–Ω–µ —Ä–æ–∑–ª—É—á–µ–Ω–Ω—è –∑ –¥—ñ—Ç—å–º–∏', '8 000 ‚Äî 12 000 –≥—Ä–Ω', '3-4 –º—ñ—Å—è—Ü—ñ')

    # 5. –ü–†–û–°–¢–Ü
    if urgency == 'high':
        return ('A1', '‚ö°Ô∏è –ï–∫—Å–ø—Ä–µ—Å-—Ä–æ–∑–ª—É—á–µ–Ω–Ω—è', '5 500 ‚Äî 7 500 –≥—Ä–Ω', '2-3 –º—ñ—Å—è—Ü—ñ')
    
    return ('A2', '‚úÖ –°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–µ —Ä–æ–∑–ª—É—á–µ–Ω–Ω—è', '4 500 ‚Äî 6 500 –≥—Ä–Ω', '3-4 –º—ñ—Å—è—Ü—ñ')

def get_mini_case(user_data):
    """–†–æ–∑—É–º–Ω–∏–π –ø—ñ–¥–±—ñ—Ä —ñ–Ω—Å–∞–π—Ç—É"""
    if user_data.get('conflict_children') == 'yes': return random.choice(MINI_CASES['conflict_children'])
    if user_data.get('has_children') == 'yes': return random.choice(MINI_CASES['peace_children'])
    
    if user_data.get('conflict_property') == 'yes': return random.choice(MINI_CASES['conflict_property'])
    if user_data.get('property_dispute') == 'yes': return random.choice(MINI_CASES['peace_property'])
    
    return random.choice(MINI_CASES['default'])

async def save_to_sheets(user_data):
    if SHEETS_LEADS is None: return
    try:
        row = [
            user_data.get('completed_at', ''), str(user_data.get('telegram_id', '')),
            user_data.get('username', ''), user_data.get('first_name', ''), user_data.get('phone_number', ''),
            user_data.get('has_children', ''), user_data.get('conflict_children', 'no'),
            user_data.get('spouse_consent', ''),
            user_data.get('property_dispute', ''), user_data.get('conflict_property', 'no'),
            user_data.get('spouse_location', ''),
            user_data.get('urgency', ''), user_data.get('segment', ''), user_data.get('segment_name', ''),
            user_data.get('cost_estimate', ''), user_data.get('time_estimate', ''), user_data.get('status', 'new')
        ]
        SHEETS_LEADS.append_row(row)
    except Exception as e: logger.error(f"‚ùå Sheets Error: {e}")

async def send_to_make(user_data):
    if not MAKE_WEBHOOK_URL: return 
    try:
        user_data['conflict_children'] = user_data.get('conflict_children', 'no')
        user_data['conflict_property'] = user_data.get('conflict_property', 'no')
        loop = asyncio.get_running_loop()
        await loop.run_in_executor(None, lambda: requests.post(MAKE_WEBHOOK_URL, json=user_data, timeout=5))
    except: pass

async def send_lead_to_admin(context: ContextTypes.DEFAULT_TYPE, user_data):
    if not ADMIN_ID: return
    text = f"""
üí∞ <b>–ó–ê–ú–û–í–õ–ï–ù–ù–Ø (199 –≥—Ä–Ω)!</b>

üë§ <b>{user_data.get('first_name')}</b>
üì± <code>{user_data.get('phone_number')}</code>

üìä <b>–°–µ–≥–º–µ–Ω—Ç: {user_data.get('segment')}</b>
‚îî {user_data.get('segment_name')}

üìù <b>–î–µ—Ç–∞–ª—ñ:</b>
‚Ä¢ –î—ñ—Ç–∏: {user_data.get('has_children')} (–ö–æ–Ω—Ñ–ª—ñ–∫—Ç: {user_data.get('conflict_children', '–Ω—ñ')})
‚Ä¢ –ú–∞–π–Ω–æ: {user_data.get('property_dispute')} (–ö–æ–Ω—Ñ–ª—ñ–∫—Ç: {user_data.get('conflict_property', '–Ω—ñ')})
‚Ä¢ –ó–≥–æ–¥–∞: {user_data.get('spouse_consent')}
‚Ä¢ –õ–æ–∫–∞—Ü—ñ—è: {user_data.get('spouse_location')}

<i>–î–∑–≤–æ–Ω–∏ —à–≤–∏–¥—à–µ! üöÄ</i>
"""
    try: await context.bot.send_message(chat_id=ADMIN_ID, text=text, parse_mode='HTML')
    except: pass

async def send_result(update: Update, context: ContextTypes.DEFAULT_TYPE, segment, segment_name, cost, time):
    """–í—ñ–¥–ø—Ä–∞–≤–ª—è—î —Ä–µ–∑—É–ª—å—Ç–∞—Ç + –†–æ–∑—à–∏—Ä–µ–Ω—É –î–æ—Ä–æ–∂–Ω—é –∫–∞—Ä—Ç—É (Hook)"""
    
    # 1. –û—Å–Ω–æ–≤–Ω–∏–π —Ä–æ–∑—Ä–∞—Ö—É–Ω–æ–∫
    message_template = SEGMENT_MESSAGES.get(segment, SEGMENT_MESSAGES['B2'])
    result_text = message_template.format(segment_name=segment_name, cost=cost, time=time)
    await update.message.reply_text(result_text, parse_mode='HTML')
    
    await asyncio.sleep(6)
    
    # 2. –§–æ—Ä–º—É—î–º–æ –î–æ—Ä–æ–∂–Ω—é –∫–∞—Ä—Ç—É (–ö–æ—Ä–∏—Å—Ç—å + "–ì–∞—á–æ–∫")
    roadmap_text = ""
    
    if 'D' in segment:
        roadmap_text = """
üìã <b>–í–∞—à –ß–µ–∫-–ª–∏—Å—Ç –¥–ª—è —Å—Ç–∞—Ä—Ç—É (–î–∏—Å—Ç–∞–Ω—Ü—ñ–π–Ω–æ):</b>

1. <b>–ï–ª–µ–∫—Ç—Ä–æ–Ω–Ω–∏–π –∫–ª—é—á (–ö–ï–ü):</b> –ü–µ—Ä–µ–≤—ñ—Ä—Ç–µ —Ç–µ—Ä–º—ñ–Ω –¥—ñ—ó. –ë–µ–∑ –Ω—å–æ–≥–æ –≤ "–ï–ª–µ–∫—Ç—Ä–æ–Ω–Ω–∏–π —Å—É–¥" –Ω–µ –∑–∞–π—Ç–∏.
2. <b>–î–æ–≤—ñ—Ä–µ–Ω—ñ—Å—Ç—å:</b> –Ø–∫—â–æ —Ä–æ–±–∏—Ç–µ –∑–∞ –∫–æ—Ä–¥–æ–Ω–æ–º, –æ–±–æ–≤'—è–∑–∫–æ–≤–∏–π <b>–ê–ø–æ—Å—Ç–∏–ª—å</b> —Ç–∞ –ø–µ—Ä–µ–∫–ª–∞–¥ –Ω–∞ —É–∫—Ä–∞—ó–Ω—Å—å–∫—É. –ë–µ–∑ —Ü—å–æ–≥–æ –¥–æ–∫—É–º–µ–Ω—Ç –Ω–µ–¥—ñ–π—Å–Ω–∏–π.
3. <b>EasyCon:</b> –ó–∞—Ä–µ—î—Å—Ç—Ä—É–π—Ç–µ—Å—å —É —Å–∏—Å—Ç–µ–º—ñ –≤—ñ–¥–µ–æ–∑–≤'—è–∑–∫—É —Å—É–¥—É (–ø–æ—Ç—Ä—ñ–±–Ω–∞ –≤–µ–±-–∫–∞–º–µ—Ä–∞ —Ç–∞ –ø–∞—Å–ø–æ—Ä—Ç).

‚ö†Ô∏è <b>–†–∏–∑–∏–∫:</b> –°—É–¥ –º–æ–∂–µ –≤–∏–º–∞–≥–∞—Ç–∏ –¥–æ–≤—ñ–¥–∫—É –ø—Ä–æ –º—ñ—Å—Ü–µ –ø—Ä–æ–∂–∏–≤–∞–Ω–Ω—è –≤—ñ–¥–ø–æ–≤—ñ–¥–∞—á–∞ –∑–∞ –∫–æ—Ä–¥–æ–Ω–æ–º. –¶–µ –∑–∞—Ç—è–≥—É—î —Å–ø—Ä–∞–≤—É –Ω–∞ –º—ñ—Å—è—Ü—ñ.
"""
    elif 'B2' in segment or 'C2' in segment:
        roadmap_text = """
üìã <b>–í–∞—à –ß–µ–∫-–ª–∏—Å—Ç (–ú–∏—Ä–Ω–∏–π —à–ª—è—Ö):</b>

1. <b>–°–ø—ñ–ª—å–Ω–∞ –∑–∞—è–≤–∞:</b> –°–ø–µ—Ü—ñ–∞–ª—å–Ω–∞ —Ñ–æ—Ä–º–∞ –∑–∞ —Å—Ç. 109 –°–ö –£–∫—Ä–∞—ó–Ω–∏.
2. <b>–û—Ä–∏–≥—ñ–Ω–∞–ª —Å–≤—ñ–¥–æ—Ü—Ç–≤–∞ –ø—Ä–æ —à–ª—é–±:</b> –ö–æ–ø—ñ—è –Ω–µ –ø—ñ–¥—ñ–π–¥–µ, —Å—É–¥ –≤–∏–ª—É—á–∞—î –æ—Ä–∏–≥—ñ–Ω–∞–ª.
3. <b>–ù–æ—Ç–∞—Ä—ñ–∞–ª—å–Ω–∏–π –¥–æ–≥–æ–≤—ñ—Ä:</b> –ü—Ä–æ —É—á–∞—Å—Ç—å —É –≤–∏—Ö–æ–≤–∞–Ω–Ω—ñ –¥–∏—Ç–∏–Ω–∏.

‚ö†Ô∏è <b>–ì–æ–ª–æ–≤–Ω–∞ –ø–∞—Å—Ç–∫–∞:</b>
–ë–µ–∑ –Ω–æ—Ç–∞—Ä—ñ–∞–ª—å–Ω–æ–≥–æ –¥–æ–≥–æ–≤–æ—Ä—É —Å—É–¥ –ü–û–í–ï–†–ù–ï –∑–∞—è–≤—É.
–ù–æ—Ç–∞—Ä—ñ—É—Å–∏ –≤–∏–º–∞–≥–∞—é—Ç—å –∫—É–ø—É –¥–æ–≤—ñ–¥–æ–∫ –¥–ª—è –π–æ–≥–æ –ø–æ—Å–≤—ñ–¥—á–µ–Ω–Ω—è. –ú–∏ –∑–Ω–∞—î–º–æ, —è–∫ —Ü–µ —Å–ø—Ä–æ—Å—Ç–∏—Ç–∏.
"""
    elif 'C' in segment:
        roadmap_text = """
üìã <b>–í–∞—à –ß–µ–∫-–ª–∏—Å—Ç (–ü–æ–¥—ñ–ª –º–∞–π–Ω–∞):</b>

1. <b>–ü—Ä–∞–≤–æ–≤—Å—Ç–∞–Ω–æ–≤–ª—é—é—á—ñ –¥–æ–∫—É–º–µ–Ω—Ç–∏:</b> –î–æ–≥–æ–≤–æ—Ä–∏ –∫—É–ø—ñ–≤–ª—ñ-–ø—Ä–æ–¥–∞–∂—É, —Ç–µ—Ö–ø–∞—Å–ø–æ—Ä—Ç–∏.
2. <b>–û—Ü—ñ–Ω–∫–∞ –≤–∞—Ä—Ç–æ—Å—Ç—ñ:</b> –ü–æ—Ç—Ä—ñ–±–µ–Ω –∑–≤—ñ—Ç —Å–µ—Ä—Ç–∏—Ñ—ñ–∫–æ–≤–∞–Ω–æ–≥–æ –æ—Ü—ñ–Ω—é–≤–∞—á–∞ (–¥–ª—è —Ä–æ–∑—Ä–∞—Ö—É–Ω–∫—É 1% –∑–±–æ—Ä—É).
3. <b>–ö–≤–∏—Ç–∞–Ω—Ü—ñ—è:</b> –°–ø–ª–∞—Ç–∞ —Å—É–¥–æ–≤–æ–≥–æ –∑–±–æ—Ä—É (–¥–æ 15 140 –≥—Ä–Ω).

‚ö†Ô∏è <b>–ö—Ä–∏—Ç–∏—á–Ω–æ –≤–∞–∂–ª–∏–≤–æ:</b>
–ü–æ–¥–∞–≤–∞–π—Ç–µ –∑–∞—è–≤—É –ø—Ä–æ <b>–ê–†–ï–®–¢ –ú–ê–ô–ù–ê</b> —Ä–∞–∑–æ–º —ñ–∑ –ø–æ–∑–æ–≤–æ–º. –Ü–Ω–∞–∫—à–µ –ø–æ–∫–∏ –π–¥–µ —Å—É–¥, –º–∞–π–Ω–æ –º–æ–∂–µ –±—É—Ç–∏ –ø—Ä–æ–¥–∞–Ω–µ —Ç—Ä–µ—Ç—ñ–º –æ—Å–æ–±–∞–º.
"""
    else:
        roadmap_text = """
üìã <b>–í–∞—à –ß–µ–∫-–ª–∏—Å—Ç (–°—É–¥–æ–≤–∏–π —Å–ø—ñ—Ä):</b>

1. <b>–ü–æ–∑–æ–≤–Ω–∞ –∑–∞—è–≤–∞:</b> –ó —á—ñ—Ç–∫–∏–º–∏ –≤–∏–º–æ–≥–∞–º–∏ (—Ä–æ–∑–ª—É—á–µ–Ω–Ω—è + –∞–ª—ñ–º–µ–Ω—Ç–∏ + –º—ñ—Å—Ü–µ –ø—Ä–æ–∂–∏–≤–∞–Ω–Ω—è).
2. <b>–î–æ–∫–∞–∑–∏ –¥–æ—Ö–æ–¥—ñ–≤:</b> –î–ª—è —Ä–æ–∑—Ä–∞—Ö—É–Ω–∫—É –∞–ª—ñ–º–µ–Ω—Ç—ñ–≤.
3. <b>–ê–∫—Ç –æ–±—Å—Ç–µ–∂–µ–Ω–Ω—è –∂–∏—Ç–ª–æ–≤–∏—Ö —É–º–æ–≤:</b> –î–æ–∫–∞–∑, —â–æ –¥–∏—Ç–∏–Ω–∞ –∂–∏–≤–µ –∑ –≤–∞–º–∏.

‚ö†Ô∏è <b>–ì–æ–ª–æ–≤–Ω–∞ –ø–∞—Å—Ç–∫–∞:</b>
–°—É–¥–¥—è –º–æ–∂–µ –¥–∞—Ç–∏ "—Å—Ç—Ä–æ–∫ –Ω–∞ –ø—Ä–∏–º–∏—Ä–µ–Ω–Ω—è" (–¥–æ 6 –º—ñ—Å—è—Ü—ñ–≤), —è–∫—â–æ –≤–∏ –≥—Ä–∞–º–æ—Ç–Ω–æ –Ω–µ –æ–±“ë—Ä—É–Ω—Ç—É—î—Ç–µ, —á–æ–º—É —à–ª—é–± –Ω–µ–º–æ–∂–ª–∏–≤–æ –∑–±–µ—Ä–µ–≥—Ç–∏.
"""

    if roadmap_text:
        await context.bot.send_message(chat_id=update.effective_chat.id, text=roadmap_text, parse_mode='HTML')

async def send_first_offer(update: Update, context: ContextTypes.DEFAULT_TYPE):
    chat_id = update.effective_chat.id if update.effective_chat else context.user_data.get('telegram_id')
    
    text_part_1 = f"""
ü§ù <b>–ß–æ–º—É –Ω–∞—à —Å–µ—Ä–≤—ñ—Å –ø–ª–∞—Ç–Ω–∏–π?</b>

–ë—ñ–ª—å—à—ñ—Å—Ç—å "–±–µ–∑–∫–æ—à—Ç–æ–≤–Ω–∏—Ö" —Å–∞–π—Ç—ñ–≤ –ø—Ä–æ—Å—Ç–æ –ø—Ä–æ–¥–∞—é—Ç—å –≤–∞—à –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω—É –±—É–¥—å-—è–∫–∏–º –∞–¥–≤–æ–∫–∞—Ç–∞–º, –∞–±–∏ –∑–∞—Ä–æ–±–∏—Ç–∏. –á–º –±–∞–π–¥—É–∂–µ –Ω–∞ —è–∫—ñ—Å—Ç—å.

<b>–ú–∏ –ø—Ä–∞—Ü—é—î–º–æ —ñ–Ω–∞–∫—à–µ.</b>
–ú–∏ ‚Äî –Ω–µ–∑–∞–ª–µ–∂–Ω–∏–π —Å–µ—Ä–≤—ñ—Å OPORA. –ú–∏ –±–µ—Ä–µ–º–æ —Å–∏–º–≤–æ–ª—ñ—á–Ω—É –ø–ª–∞—Ç—É –∑ –í–ê–°, —â–æ–± –ø—Ä–∞—Ü—é–≤–∞—Ç–∏ –≤ –í–ê–®–ò–• —ñ–Ω—Ç–µ—Ä–µ—Å–∞—Ö. –¶–µ –≥–∞—Ä–∞–Ω—Ç—ñ—è –Ω–∞—à–æ—ó –æ–±'—î–∫—Ç–∏–≤–Ω–æ—Å—Ç—ñ.
"""
    await context.bot.send_message(chat_id=chat_id, text=text_part_1, parse_mode='HTML')
    
    await asyncio.sleep(5)
    
    text_part_2 = """
üíé <b>–ü–ê–ö–ï–¢ "SMART-–°–¢–ê–†–¢"</b>

–ú–∏ –≤—Ä—É—á–Ω—É –ø—Ä–æ–∞–Ω–∞–ª—ñ–∑—É—î–º–æ –≤–∞—à—É —Å–∏—Ç—É–∞—Ü—ñ—é —ñ –Ω–∞–¥–∞–º–æ –∫–æ–º–ø–ª–µ–∫—Å–Ω–µ —Ä—ñ—à–µ–Ω–Ω—è.

‚úÖ <b>–©–æ –≤—Ö–æ–¥–∏—Ç—å —É –ø–∞–∫–µ—Ç:</b>
1. <b>–ü–µ—Ä—Å–æ–Ω–∞–ª—å–Ω–∏–π –ø—ñ–¥–±—ñ—Ä:</b> 2 –ø–µ—Ä–µ–≤—ñ—Ä–µ–Ω–∏—Ö –∞–¥–≤–æ–∫–∞—Ç–∏ —Å–∞–º–µ –ø—ñ–¥ –≤–∞—à –±—é–¥–∂–µ—Ç.
2. <b>–ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ —Ä–µ–ø—É—Ç–∞—Ü—ñ—ó:</b> –ú–∏ –∑–Ω–∞—î–º–æ —ó—Ö–Ω—ñ —Ä–µ–∞–ª—å–Ω—ñ –≤–∏–≥—Ä–∞–Ω—ñ —Å–ø—Ä–∞–≤–∏.
3. <b>–Æ—Ä–∏–¥–∏—á–Ω–∞ –¥–æ—Ä–æ–∂–Ω—è –∫–∞—Ä—Ç–∞ (PDF):</b> –ü–ª–∞–Ω –¥—ñ–π –∫—Ä–æ–∫ –∑–∞ –∫—Ä–æ–∫–æ–º.
4. <b>100% –ì–∞—Ä–∞–Ω—Ç—ñ—è:</b> –Ø–∫—â–æ –≤–∏ –Ω–µ —Å–ø—Ä–∞—Ü—é—î—Ç–µ—Å—å —ñ–∑ –∂–æ–¥–Ω–∏–º —ñ–∑ –∑–∞–ø—Ä–æ–ø–æ–Ω–æ–≤–∞–Ω–∏—Ö –∞–¥–≤–æ–∫–∞—Ç—ñ–≤ ‚Äî –º–∏ <b>–ø–æ–≤–µ—Ä–Ω–µ–º–æ –≥—Ä–æ—à—ñ</b>.

üí∞ <b>–í–∞—Ä—Ç—ñ—Å—Ç—å –ø–æ—Å–ª—É–≥ —Å–µ—Ä–≤—ñ—Å—É:</b>
–°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–∞ —Ü—ñ–Ω–∞: <s>1200 –≥—Ä–Ω</s>.
üî• <b>–°–ø–µ—Ü—ñ–∞–ª—å–Ω–∞ —Ü—ñ–Ω–∞ –∑–∞—Ä–∞–∑: 199 –≥—Ä–Ω.</b>
<i>–ü—Ä–æ–ø–æ–∑–∏—Ü—ñ—è –¥—ñ—î, –ø–æ–∫–∏ –≤–∏ –Ω–∞ —Ü—ñ–π —Å—Ç–æ—Ä—ñ–Ω—Ü—ñ.</i>

üëá <b>–ù–∞—Ç–∏—Å–Ω—ñ—Ç—å –∫–Ω–æ–ø–∫—É, —â–æ–± –∑–∞–º–æ–≤–∏—Ç–∏ "Smart-–°—Ç–∞—Ä—Ç":</b>
"""
    keyboard = [[InlineKeyboardButton("‚úÖ –ó–∞–º–æ–≤–∏—Ç–∏ –∑–∞ 199 –≥—Ä–Ω", callback_data='book_consultation')]]
    await context.bot.send_message(chat_id=chat_id, text=text_part_2, parse_mode='HTML', reply_markup=InlineKeyboardMarkup(keyboard))


# =====================================================
# MISSING HELPERS (–í—Å—Ç–∞–≤—å —ç—Ç–æ –ø–µ—Ä–µ–¥ def start)
# =====================================================

async def log_event(telegram_id, username, event, details=""):
    """–õ–æ–≥—É–≤–∞–Ω–Ω—è –ø–æ–¥—ñ–π –≤ Analytics"""
    if SHEETS_ANALYTICS:
        try:
            SHEETS_ANALYTICS.append_row([datetime.now().isoformat(), str(telegram_id), username or "", event, details])
        except Exception as e:
            logger.error(f"Analytics Error: {e}")

async def save_all_user(telegram_id, username, first_name, last_name):
    """–ó–±–µ—Ä–µ–∂–µ–Ω–Ω—è –≤—Å—ñ—Ö, —Ö—Ç–æ –Ω–∞—Ç–∏—Å–Ω—É–≤ —Å—Ç–∞—Ä—Ç"""
    if SHEETS_ALL_USERS:
        try:
            # –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ –Ω–∞ –¥—É–±–ª—ñ–∫–∞—Ç (—Å–ø—Ä–æ—â–µ–Ω–∞, —â–æ–± –Ω–µ –≥–∞–ª—å–º—É–≤–∞—Ç–∏)
            # –í —ñ–¥–µ–∞–ª—ñ –∫—Ä–∞—â–µ –ª–æ–≤–∏—Ç–∏ –ø–æ–º–∏–ª–∫—É, –∞–ª–µ –¥–ª—è Google Sheets API find - –æ–∫
            try:
                existing = SHEETS_ALL_USERS.find(str(telegram_id), in_column=2)
                if existing: return
            except: pass
            
            SHEETS_ALL_USERS.append_row([
                datetime.now().isoformat(), str(telegram_id), username or "", 
                first_name or "", last_name or "", "–ù—ñ", "new"
            ])
        except Exception as e:
            logger.error(f"Save User Error: {e}")

def get_quiz_job_name(user_id):
    return f"quiz_reminder_{user_id}"

async def schedule_quiz_reminder(context: ContextTypes.DEFAULT_TYPE, user_id: int, chat_id: int):
    """–ó–∞–ø—É—Å–∫ —Ç–∞–π–º–µ—Ä–∞ –Ω–∞ 15 —Ö–≤"""
    job_name = get_quiz_job_name(user_id)
    # –í–∏–¥–∞–ª—è—î–º–æ —Å—Ç–∞—Ä–∏–π —Ç–∞–π–º–µ—Ä, —è–∫—â–æ —î
    current_jobs = context.job_queue.get_jobs_by_name(job_name)
    for job in current_jobs:
        job.schedule_removal()
    
    # –°—Ç–∞–≤–∏–º–æ –Ω–æ–≤–∏–π
    context.job_queue.run_once(quiz_reminder_callback, 900, chat_id=chat_id, user_id=user_id, name=job_name)

async def remove_quiz_reminder(context: ContextTypes.DEFAULT_TYPE, user_id: int):
    """–°–∫–∞—Å—É–≤–∞–Ω–Ω—è —Ç–∞–π–º–µ—Ä–∞"""
    job_name = get_quiz_job_name(user_id)
    current_jobs = context.job_queue.get_jobs_by_name(job_name)
    for job in current_jobs:
        job.schedule_removal()

# =====================================================
# 5. –°–¶–ï–ù–ê–†–Ü–ô (–û–ù–û–í–õ–ï–ù–ò–ô - –ì–Ü–õ–õ–Ø–°–¢–ò–ô)
# =====================================================

async def start(update: Update, context: ContextTypes.DEFAULT_TYPE):
    user = update.effective_user
    await remove_quiz_reminder(context, user.id)
    await save_all_user(user.id, user.username, user.first_name, user.last_name)
    await log_event(user.id, user.username, "/start", "Start")
    context.user_data.clear()
    context.user_data.update({'telegram_id': user.id, 'username': user.username or '', 'started_at': datetime.now().isoformat()})
    await update.message.reply_text(TEXT_WELCOME, parse_mode='HTML', reply_markup=InlineKeyboardMarkup([[InlineKeyboardButton("‚úÖ –¢–∞–∫, –ø–æ—á–Ω–µ–º–æ!", callback_data='start_quiz')]]))

# --- –ü–ò–¢–ê–ù–ù–Ø 1: –î–Ü–¢–ò ---
async def question_1(update: Update, context: ContextTypes.DEFAULT_TYPE):
    query = update.callback_query
    await query.answer()
    await log_event(update.effective_user.id, update.effective_user.username, "quiz_started")
    keyboard = [[InlineKeyboardButton("üë∂ –¢–∞–∫, —î –¥—ñ—Ç–∏", callback_data='q1_yes')], [InlineKeyboardButton("‚ùå –ù–µ–º–∞—î –¥—ñ—Ç–µ–π", callback_data='q1_no')]]
    await query.edit_message_text(TEXT_Q1, parse_mode='HTML', reply_markup=InlineKeyboardMarkup(keyboard))
    await schedule_quiz_reminder(context, update.effective_user.id, query.message.chat_id)

# --- –£–¢–û–ß–ù–ï–ù–ù–Ø –ü–û –î–Ü–¢–Ø–• (–ì–Ü–õ–ö–ê) ---
async def question_1_clarify(update: Update, context: ContextTypes.DEFAULT_TYPE):
    query = update.callback_query
    await query.answer()
    context.user_data['has_children'] = 'yes'
    keyboard = [[InlineKeyboardButton("ü§ù –î–æ–º–æ–≤–∏–ª–∏—Å—è (–ú–∏—Ä–Ω–æ)", callback_data='q1_sub_peace')], [InlineKeyboardButton("‚öîÔ∏è –Ñ —Å—É–ø–µ—Ä–µ—á–∫–∏ / –ù–µ –ø–ª–∞—Ç–∏—Ç—å", callback_data='q1_sub_conflict')]]
    await query.edit_message_text(TEXT_Q1_CLARIFY, parse_mode='HTML', reply_markup=InlineKeyboardMarkup(keyboard))

# --- –ü–ò–¢–ê–ù–ù–Ø 2: –ó–ì–û–î–ê (–í—Ö—ñ–¥) ---
async def question_2_entry(update: Update, context: ContextTypes.DEFAULT_TYPE, from_prev=False):
    if from_prev:
        context.user_data['has_children'] = 'no'
        context.user_data['conflict_children'] = 'no'
        await update.callback_query.edit_message_text(MC_NO + "\n\n" + TEXT_Q2, parse_mode='HTML', reply_markup=q2_keyboard())
    else:
        query = update.callback_query
        choice = query.data
        if choice == 'q1_sub_peace':
            context.user_data['conflict_children'] = 'no'
            m = MC_AGREED
        else:
            context.user_data['conflict_children'] = 'yes'
            m = MC_CONFLICT
        
        await query.edit_message_text(m + "\n\n" + TEXT_Q2, parse_mode='HTML', reply_markup=q2_keyboard())

def q2_keyboard():
    return InlineKeyboardMarkup([[InlineKeyboardButton("‚úÖ –¢–∞–∫, –∑–≥–æ–¥–µ–Ω/–Ω–∞", callback_data='q2_yes')], [InlineKeyboardButton("‚ùå –ù—ñ, –ø—Ä–æ—Ç–∏", callback_data='q2_no')], [InlineKeyboardButton("ü§∑ –ù–µ –∑–Ω–∞—é", callback_data='q2_unknown')]])

# --- –ü–ò–¢–ê–ù–ù–Ø 3: –ú–ê–ô–ù–û ---
async def question_3(update: Update, context: ContextTypes.DEFAULT_TYPE):
    query = update.callback_query
    await query.answer()
    consent = query.data.replace('q2_', '')
    context.user_data['spouse_consent'] = consent
    if consent == 'yes': m = MC_YES
    elif consent == 'no': m = MC_NO
    else: m = "‚úÖ –ó—Ä–æ–∑—É–º—ñ–ª–æ."
    keyboard = [[InlineKeyboardButton("üè† –¢–∞–∫, —î –º–∞–π–Ω–æ", callback_data='q3_yes')], [InlineKeyboardButton("‚ùå –ù–µ–º–∞—î –º–∞–π–Ω–∞", callback_data='q3_no')]]
    await query.edit_message_text(m + "\n\n" + TEXT_Q3, parse_mode='HTML', reply_markup=InlineKeyboardMarkup(keyboard))

# --- –£–¢–û–ß–ù–ï–ù–ù–Ø –ü–û –ú–ê–ô–ù–£ (–ì–Ü–õ–ö–ê) ---
async def question_3_clarify(update: Update, context: ContextTypes.DEFAULT_TYPE):
    query = update.callback_query
    await query.answer()
    context.user_data['property_dispute'] = 'yes'
    keyboard = [[InlineKeyboardButton("ü§ù –í–∂–µ –ø–æ–¥—ñ–ª–∏–ª–∏ / –î–æ–º–æ–≤–∏–ª–∏—Å—è", callback_data='q3_sub_peace')], [InlineKeyboardButton("‚öîÔ∏è –Ñ –∫–æ–Ω—Ñ–ª—ñ–∫—Ç / –ù–µ –¥—ñ–ª–∏—Ç—å—Å—è", callback_data='q3_sub_conflict')]]
    await query.edit_message_text(TEXT_Q3_CLARIFY, parse_mode='HTML', reply_markup=InlineKeyboardMarkup(keyboard))

# --- –ü–ò–¢–ê–ù–ù–Ø 4: –õ–û–ö–ê–¶–Ü–Ø (–í—Ö—ñ–¥) ---
async def question_4_entry(update: Update, context: ContextTypes.DEFAULT_TYPE, from_prev=False):
    if from_prev:
        context.user_data['property_dispute'] = 'no'
        context.user_data['conflict_property'] = 'no'
        m = MC_NO
        await update.callback_query.edit_message_text(m + "\n\n" + TEXT_Q4, parse_mode='HTML', reply_markup=q4_keyboard())
    else:
        query = update.callback_query
        if query.data == 'q3_sub_peace':
            context.user_data['conflict_property'] = 'no'
            m = MC_AGREED
        else:
            context.user_data['conflict_property'] = 'yes'
            m = MC_CONFLICT
        
        # –Ü–Ω—Å–∞–π—Ç –∑–∞–º—ñ—Å—Ç—å –ø–∞—É–∑–∏
        insight = get_mini_case(context.user_data)
        await query.edit_message_text(m, parse_mode='HTML')
        await asyncio.sleep(1)
        await context.bot.send_chat_action(chat_id=query.message.chat_id, action=ChatAction.TYPING)
        await context.bot.send_message(chat_id=query.message.chat_id, text=insight, parse_mode='HTML')
        await asyncio.sleep(4)
        
        await context.bot.send_message(chat_id=query.message.chat_id, text=TEXT_Q4, parse_mode='HTML', reply_markup=q4_keyboard())

def q4_keyboard():
    return InlineKeyboardMarkup([[InlineKeyboardButton("üá∫üá¶ –ú–∏ –≤ –£–∫—Ä–∞—ó–Ω—ñ", callback_data='q4_ukraine')], [InlineKeyboardButton("üåç –•—Ç–æ—Å—å –∑–∞ –∫–æ—Ä–¥–æ–Ω–æ–º", callback_data='q4_abroad')], [InlineKeyboardButton("‚ùì –ù–µ –∑–Ω–∞—é –¥–µ –≤—ñ–Ω/–≤–æ–Ω–∞", callback_data='q4_unknown')]])

# --- –ü–ò–¢–ê–ù–ù–Ø 5: –¢–ï–†–ú–Ü–ù–û–í–Ü–°–¢–¨ ---
async def question_5(update: Update, context: ContextTypes.DEFAULT_TYPE):
    query = update.callback_query
    await query.answer()
    loc = query.data.replace('q4_', '')
    context.user_data['spouse_location'] = loc
    if loc == 'ukraine': m = MC_YES
    elif loc == 'abroad': m = "‚úÖ –ó—Ä–æ–∑—É–º—ñ–ª–æ, –º—ñ–∂–Ω–∞—Ä–æ–¥–Ω–∏–π –µ–ª–µ–º–µ–Ω—Ç."
    else: m = "‚úÖ –ó—Ä–æ–∑—É–º—ñ–ª–æ."
    keyboard = [[InlineKeyboardButton("‚ö°Ô∏è –¢–µ—Ä–º—ñ–Ω–æ–≤–æ", callback_data='q5_high')], [InlineKeyboardButton("‚è≥ –ú–æ–∂—É —á–µ–∫–∞—Ç–∏", callback_data='q5_low')]]
    await query.edit_message_text(m + "\n\n" + TEXT_Q5, parse_mode='HTML', reply_markup=InlineKeyboardMarkup(keyboard))

# --- –§–Ü–ù–ê–õ: –¢–ï–õ–ï–§–û–ù ---
async def question_6_phone(update: Update, context: ContextTypes.DEFAULT_TYPE):
    query = update.callback_query
    await query.answer()
    urgency = query.data.replace('q5_', '')
    context.user_data['urgency'] = urgency
    user_id = update.effective_user.id
    
    await remove_quiz_reminder(context, user_id)
    
    # –•—É–∫ –∑ —Ä–æ–∑—Ä–∞—Ö—É–Ω–∫–æ–º
    segment, segment_name, cost, time = determine_segment(context.user_data)
    hook_text = f"""
‚úÖ <b>–ü–æ–ø–µ—Ä–µ–¥–Ω—ñ–π —Ä–æ–∑—Ä–∞—Ö—É–Ω–æ–∫ –≥–æ—Ç–æ–≤–∏–π:</b>
üí∞ {cost}
‚è± {time}

–©–æ–± –∑–∞—Ñ—ñ–∫—Å—É–≤–∞—Ç–∏ —Ü–µ–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç —Ç–∞ –æ—Ç—Ä–∏–º–∞—Ç–∏ <b>–ü–µ—Ä—Å–æ–Ω–∞–ª—å–Ω–∏–π –ü–ª–∞–Ω –î—ñ–π</b> ‚Äî –ø—ñ–¥—Ç–≤–µ—Ä–¥—ñ—Ç—å, —â–æ –≤–∏ —Ä–µ–∞–ª—å–Ω–∞ –ª—é–¥–∏–Ω–∞.

üëá <b>–ù–∞—Ç–∏—Å–Ω—ñ—Ç—å –∫–Ω–æ–ø–∫—É "–ü–æ–¥—ñ–ª–∏—Ç–∏—Å—è –Ω–æ–º–µ—Ä–æ–º":</b>
"""
    await query.delete_message()
    await context.bot.send_message(chat_id=query.message.chat_id, text=hook_text, parse_mode='HTML', reply_markup=ReplyKeyboardMarkup([[KeyboardButton("üì± –ü–æ–¥—ñ–ª–∏—Ç–∏—Å—è –Ω–æ–º–µ—Ä–æ–º", request_contact=True)]], one_time_keyboard=True, resize_keyboard=True))
    
    context.job_queue.run_once(phone_reminder_callback, 60, chat_id=query.message.chat_id, user_id=user_id, name=f"phone_reminder_{user_id}")

async def finalize_lead_processing(update: Update, context: ContextTypes.DEFAULT_TYPE, phone_number: str):
    user = update.effective_user
    chat_id = update.effective_chat.id
    context.user_data.update({'first_name': context.user_data.get('first_name') or user.first_name, 'last_name': context.user_data.get('last_name') or user.last_name, 'phone_number': phone_number, 'completed_at': datetime.now().isoformat()})
    
    try:
        current_jobs = context.job_queue.get_jobs_by_name(f"phone_reminder_{user.id}")
        for job in current_jobs: job.schedule_removal()
    except: pass

    await log_event(user.id, user.username, "phone_shared", phone_number)
    
    segment, segment_name, cost, time = determine_segment(context.user_data)
    context.user_data.update({'segment': segment, 'segment_name': segment_name, 'cost_estimate': cost, 'time_estimate': time, 'status': 'new'})
    
    await save_to_sheets(context.user_data)
    await send_to_make(context.user_data)
    
    await context.bot.send_message(chat_id=chat_id, text=f"‚úÖ <b>–î—è–∫—É—é, {context.user_data['first_name']}!</b>", parse_mode='HTML', reply_markup=ReplyKeyboardMarkup([[]], resize_keyboard=True))
    
    await asyncio.sleep(2)
    
    # 1. –†–µ–∑—É–ª—å—Ç–∞—Ç + –î–æ—Ä–æ–∂–Ω—è –∫–∞—Ä—Ç–∞
    await send_result(update, context, segment, segment_name, cost, time)
    
    await asyncio.sleep(7)
    
    # 2. –û—Ñ—Ñ–µ—Ä 199 –≥—Ä–Ω
    await send_first_offer(update, context)
    
    context.job_queue.run_once(offer_reminder_callback, 7200, chat_id=chat_id, user_id=user.id, name=f"offer_reminder_{user.id}", data=context.user_data['first_name'])

async def process_contact(update: Update, context: ContextTypes.DEFAULT_TYPE):
    await finalize_lead_processing(update, context, update.message.contact.phone_number)

async def handle_text(update: Update, context: ContextTypes.DEFAULT_TYPE):
    text = update.message.text
    if context.user_data.get('urgency') and not context.user_data.get('phone_number'):
        phone_match = re.search(r'[\+\(\)\s\-\d]{9,20}', text)
        if phone_match:
            clean = re.sub(r'[^\d\+]', '', text)
            if 9 <= len(clean) <= 15:
                await finalize_lead_processing(update, context, clean)
                return
    await update.message.reply_text(TEXT_UNKNOWN_MESSAGE)

async def book_consultation(update: Update, context: ContextTypes.DEFAULT_TYPE):
    query = update.callback_query
    await query.answer()
    user_id = update.effective_user.id
    try:
        jobs = context.job_queue.get_jobs_by_name(f"offer_reminder_{user_id}")
        for j in jobs: j.schedule_removal()
    except: pass
    
    context.user_data['status'] = 'scheduled'
    await send_lead_to_admin(context, context.user_data)
    await log_event(user_id, update.effective_user.username, "consultation_booked")
    
    try: await context.bot.set_message_reaction(chat_id=query.message.chat_id, message_id=query.message.message_id, reaction=[ReactionTypeEmoji(emoji="üéâ")])
    except: pass
    
    await query.edit_message_text(get_consultation_booked_text(context.user_data['first_name'], context.user_data['phone_number']), parse_mode='HTML')
    
    await asyncio.sleep(1)
    checklist = "üéÅ <b>–í–∞—à –±–æ–Ω—É—Å:</b>\n–û—Å—å –∫–æ—Ä–æ—Ç–∫–∏–π –≥–∞–π–¥ '–¢–æ–ø-10 –ø–æ–º–∏–ª–æ–∫', —è–∫–∏–π –º–∏ –æ–±—ñ—Ü—è–ª–∏. –ü–æ–≤–Ω–∞ –≤–µ—Ä—Å—ñ—è –±—É–¥–µ —É –º–µ–Ω–µ–¥–∂–µ—Ä–∞."
    await context.bot.send_message(chat_id=query.message.chat_id, text=checklist, parse_mode='HTML')

# =====================================================
# SYSTEM (REMINDERS)
# =====================================================

async def phone_reminder_callback(context: ContextTypes.DEFAULT_TYPE):
    job = context.job
    if context.application.user_data.get(job.user_id, {}).get('phone_number'): return
    await context.bot.send_message(chat_id=job.chat_id, text=TEXT_PHONE_REMINDER, parse_mode='HTML', reply_markup=ReplyKeyboardMarkup([[KeyboardButton("üì± –ü–æ–¥—ñ–ª–∏—Ç–∏—Å—è –Ω–æ–º–µ—Ä–æ–º", request_contact=True)]], one_time_keyboard=True, resize_keyboard=True))

async def quiz_reminder_callback(context: ContextTypes.DEFAULT_TYPE):
    job = context.job
    if context.application.user_data.get(job.user_id, {}).get('phone_number'): return
    await context.bot.send_message(chat_id=job.chat_id, text=TEXT_QUIZ_REMINDER, parse_mode='HTML')

async def offer_reminder_callback(context: ContextTypes.DEFAULT_TYPE):
    job = context.job
    if context.application.user_data.get(job.user_id, {}).get('status') == 'scheduled': return
    text = f"{job.data}, —è –±–∞—á—É –≤–∏ —â–µ –Ω–µ –∑–∞–º–æ–≤–∏–ª–∏ –ø—ñ–¥–±—ñ—Ä...\n–ú–æ–∂–ª–∏–≤–æ —É –≤–∞—Å –≤–∏–Ω–∏–∫–ª–∏ –ø–∏—Ç–∞–Ω–Ω—è?"
    await context.bot.send_message(chat_id=job.chat_id, text=text)

async def error_handler(update: object, context: ContextTypes.DEFAULT_TYPE) -> None:
    logger.error(msg="Exception:", exc_info=context.error)
    if ADMIN_ID:
        try: await context.bot.send_message(chat_id=ADMIN_ID, text=f"‚ö†Ô∏è Error: {context.error}")
        except: pass

# =====================================================
# –ì–û–õ–û–í–ù–ê –§–£–ù–ö–¶–Ü–Ø (WEBHOOK + FLASK) - STABLE FIX
# =====================================================

app = Flask(__name__)

@app.route('/')
def index():
    return "‚úÖ OPORA Bot is RUNNING!", 200

@app.route('/health')
def health():
    return {"status": "ok"}, 200

bot_app = None

async def run_bot():
    """–ó–∞–ø—É—Å–∫ –±–æ—Ç–∞ –≤ —Ä–µ–∂–∏–º—ñ Polling (–∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ)"""
    global bot_app
    logger.info("ü§ñ –Ü–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—è –±–æ—Ç–∞...")
    
    bot_app = Application.builder().token(BOT_TOKEN).build()
    
    # –†–µ—î—Å—Ç—Ä–∞—Ü—ñ—è —Ö–µ–Ω–¥–ª–µ—Ä—ñ–≤
    bot_app.add_handler(CommandHandler("start", start))
    bot_app.add_handler(CallbackQueryHandler(question_1, pattern='^start_quiz$'))
    
    # –ì—ñ–ª–∫–∏
    bot_app.add_handler(CallbackQueryHandler(question_1_clarify, pattern='^q1_yes$'))
    bot_app.add_handler(CallbackQueryHandler(question_2_entry, pattern='^q1_no$'))
    bot_app.add_handler(CallbackQueryHandler(question_2_entry, pattern='^q1_sub_'))
    
    bot_app.add_handler(CallbackQueryHandler(question_3, pattern='^q2_'))
    bot_app.add_handler(CallbackQueryHandler(question_3_clarify, pattern='^q3_yes$'))
    bot_app.add_handler(CallbackQueryHandler(question_4_entry, pattern='^q3_no$'))
    bot_app.add_handler(CallbackQueryHandler(question_4_entry, pattern='^q3_sub_'))
    
    bot_app.add_handler(CallbackQueryHandler(question_5, pattern='^q4_'))
    bot_app.add_handler(CallbackQueryHandler(question_6_phone, pattern='^q5_'))
    bot_app.add_handler(CallbackQueryHandler(book_consultation, pattern='^book_consultation$'))
    bot_app.add_handler(MessageHandler(filters.CONTACT, process_contact))
    bot_app.add_handler(MessageHandler(filters.TEXT & ~filters.COMMAND, handle_text))
    
    bot_app.add_error_handler(error_handler)
    
    logger.info("üöÄ –ë–æ—Ç –∑–∞–ø—É—Å–∫–∞—î—Ç—å—Å—è...")
    
    await bot_app.initialize()
    await bot_app.start()
    
    # –ó–∞–ø—É—Å–∫–∞—î–º–æ long polling
    await bot_app.updater.start_polling(allowed_updates=Update.ALL_TYPES)
    
    # –¢—Ä–∏–º–∞—î–º–æ –ø—Ä–æ—Ü–µ—Å –∂–∏–≤–∏–º
    while True:
        await asyncio.sleep(3600)

def start_background_loop(loop):
    """–ó–∞–ø—É—Å–∫ –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ–≥–æ —Ü–∏–∫–ª—É –≤ –æ–∫—Ä–µ–º–æ–º—É –ø–æ—Ç–æ—Ü—ñ"""
    asyncio.set_event_loop(loop)
    loop.run_until_complete(run_bot())

if __name__ == '__main__':
    # 1. –°—Ç–≤–æ—Ä—é—î–º–æ –Ω–æ–≤–∏–π event loop –¥–ª—è –±–æ—Ç–∞
    bot_loop = asyncio.new_event_loop()
    
    # 2. –ó–∞–ø—É—Å–∫–∞—î–º–æ –±–æ—Ç–∞ –≤ –æ–∫—Ä–µ–º–æ–º—É –ø–æ—Ç–æ—Ü—ñ (—â–æ–± –Ω–µ –±–ª–æ–∫—É–≤–∞—Ç–∏ Flask)
    t = threading.Thread(target=start_background_loop, args=(bot_loop,), daemon=True)
    t.start()
    
    # 3. –ó–∞–ø—É—Å–∫–∞—î–º–æ Flask (—Ü–µ –±–ª–æ–∫—É—î –æ—Å–Ω–æ–≤–Ω–∏–π –ø–æ—Ç—ñ–∫ —ñ —Ç—Ä–∏–º–∞—î Render –∂–∏–≤–∏–º)
    port = int(os.environ.get('PORT', 10000))
    logger.info(f"üåê –ó–∞–ø—É—Å–∫ Flask –Ω–∞ –ø–æ—Ä—Ç—É {port}")
    
    # –í–∞–∂–ª–∏–≤–æ: use_reloader=False, —â–æ–± –Ω–µ –±—É–ª–æ –ø–æ–¥–≤—ñ–π–Ω–æ–≥–æ –∑–∞–ø—É—Å–∫—É
    app.run(host='0.0.0.0', port=port, debug=False, use_reloader=False)
